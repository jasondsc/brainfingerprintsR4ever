---
title: "CAMCAN"
output: html_document
---

Read in data from tables and organize it to explore in regressions 
See how it relates to age

```{r cleaning data and demographics}
library(ggplot2)
library(dplyr)
library(BayesFactor)

cbbPalette= c("#4f89e0", "#f5ec6c",'#156605',"#76D7C4","#268236", '#4d3d87','#593d80', '#3b49e3')

#ge_colors = c("#000000","#007E7E","#8001FC","#FF8207","#FFFFFF")
#scale_fill_gradientn(colors = ge_colors,oob = scales::squish,limits=c(floor(rng[1]), ceiling(rng[2])))

demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

write.csv(demo, '~/Documents/CAMCAN_outputs/demo_all_subj.csv')

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]

aper_expon=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/aperiodic_exponent_Rest.csv', header = FALSE)
aper_offset=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/aperiodic_offset_Rest.csv', header = FALSE)

aper_expon_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/aperiodic_exponent_Task.csv', header = FALSE)
aper_offset_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/aperiodic_offset_task.csv', header = FALSE)

aper_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/aperioidc_Rest.csv', header = FALSE)
aper_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/aperiodic_Task.csv', header = FALSE)

fit_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/fit_mse_Rest.csv', header = FALSE)
fit_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/fit_mse_Task.csv', header = FALSE)

R_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/fit_rsq_Rest.csv', header = FALSE)
R_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/fit_rsq_Task.csv', header = FALSE)

periodic_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/perioidc_Rest.csv', header = FALSE)
periodic_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/periodic_Task.csv', header = FALSE)

psd_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_Rest.csv', header = FALSE)
psd_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_Task.csv', header = FALSE)

spectral_peak_count_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/spectral_peak_count_Rest.csv', header = FALSE)
spectral_peak_count_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/spectral_peak_count_Task.csv', header = FALSE)


alpha_peak_amplitude=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/alpha_amplitude_Rest.csv', header = FALSE, na.strings = 'NaN')
alpha_peak_freq=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/alpha_centerfreq_Rest.csv', header = FALSE, na.strings = 'NaN')
alpha_peak_std=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/alpha_std_Rest.csv', header = FALSE,  na.strings = 'NaN')

beta_peak_amplitude=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/beta_amplitude_Rest.csv', header = FALSE, na.strings = 'NaN')
beta_peak_freq=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/beta_centerfreq_Rest.csv', header = FALSE,  na.strings = 'NaN')
beta_peak_std=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/beta_std_Rest.csv', header = FALSE,  na.strings = 'NaN')


alpha_peak_STD=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/alpha_std_Rest.csv', header = FALSE)

alpha_peak=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/alpha_centerfreq_Rest.csv', header = FALSE)





# save aperiodic corrected data
list=1:68
roi_index= c(mapply(seq, 300*(list-1)+3, (300*(list-1)+80)))


ap_corr_psd_rest= log(psd_rest[,roi_index]) - log(aper_rest)
ap_corr_psd_task= log(psd_task[,roi_index]) - log(aper_task)


write.csv(ap_corr_psd_rest, '~/Documents/CAMCAN_outputs/NPM/aperiodic_corrected_spectra_rest.csv')
write.csv(ap_corr_psd_task, '~/Documents/CAMCAN_outputs/NPM/aperiodic_corrected_spectra_task.csv')


demo$mean_aperiodic_expon_rest=rowMeans(aper_expon_task)
demo$mean_aperiodic_offset_rest=rowMeans(aper_offset_task)

demo$mean_aperiodic_expon_task=rowMeans(aper_expon)
demo$mean_aperiodic_offset_task=rowMeans(aper_offset)

demo$mean_fit_rest=rowMeans(fit_rest)
demo$mean_fit_task=rowMeans(fit_task)

demo$mean_R_rest=rowMeans(R_rest)
demo$mean_R_task=rowMeans(R_task)

demo$mean_alpha_amplitude_rest=rowMeans(alpha_peak_amplitude, na.rm = TRUE)
demo$mean_alpha_freq_rest=rowMeans(alpha_peak_freq, na.rm = TRUE)
demo$mean_alpha_std_rest=rowMeans(alpha_peak_std, na.rm = TRUE)

demo$mean_beta_amplitude_rest=rowMeans(beta_peak_amplitude, na.rm = TRUE)
demo$mean_beta_freq_rest=rowMeans(beta_peak_freq, na.rm = TRUE)
demo$mean_beta_std_rest=rowMeans(beta_peak_std, na.rm = TRUE)


mean(demo$mean_R_rest)
mean(demo$mean_R_task)

mean(demo$mean_fit_rest)
mean(demo$mean_fit_task)


mean(as.matrix(aper_expon), na.rm = TRUE)
sd(as.matrix(aper_expon), na.rm = TRUE)

mean(as.matrix(alpha_peak_amplitude), na.rm = TRUE)
sd(as.matrix(alpha_peak_amplitude), na.rm = TRUE)

mean(as.matrix(alpha_peak_freq), na.rm = TRUE)
sd(as.matrix(alpha_peak_freq), na.rm = TRUE)

mean(as.matrix(alpha_peak_std), na.rm = TRUE)
sd(as.matrix(alpha_peak_std), na.rm = TRUE)

```


## Neural Fingerprinting
fingerprint entire cohot and compare effects across psd, aperiodic, and periodic component 

```{r self correlationsn & fingerprinting}


# set colour palette
cbbPalette= c("#DBF132", "#15A705",'#4F89E0',"#D81B99","#268236", '#4d3d87','#593d80', '#3b49e3')


demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]

psd_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_justRest.csv', header = FALSE)
psd_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_justRest2.csv', header = FALSE)

corr_psd=cor(t(psd_rest),t(psd_task)) 
demo$psd_self_corr=diag(corr_psd)
demo$psd_identifiability=diag(apply(corr_psd, 2, scale))

print("psd fingerprinting:")
tt=apply(corr_psd, 1, which.max)
sum(seq(1:606)==tt)/606
tt=apply(corr_psd, 2, which.max)
sum(seq(1:606)==tt)/606


demo$Group[demo$Age>18 & demo$Age <45]= "young adult"
demo$Group[demo$Age>=45 & demo$Age <65]= "adult"
demo$Group[demo$Age>=65 & demo$Age <90]= "older adult"

ggplot(demo, aes(psd_self_corr, color= Group, fill=group, alpha=0.5)) +
  geom_density(aes( color= Group, fill=Group), alpha= 0.5) +
  ggpubr::theme_classic2() +
  labs(x = "self correlation", y = "denstity")  + xlim(c(0.5,1)) +
  ggtitle("") + scale_fill_manual(values=cbbPalette[c(2,3,4)]) + scale_color_manual(values=cbbPalette[c(2,3,4)]) 

ggsave('~/Documents/CAMCAN_outputs/figures/JUST_REST_self_corr_per_age_group_hist.pdf', device = "pdf")


ggplot(demo, aes(psd_self_corr, color= Group, fill=group, alpha=0.5)) +
  geom_density(aes( color= Group, fill=Group), alpha= 0.5) +
  ggpubr::theme_classic2() +
  labs(x = "self correlation", y = "denstity")  + xlim(c(0.8,1)) +
  ggtitle("") + scale_fill_manual(values=cbbPalette[c(2,3,4)]) + scale_color_manual(values=cbbPalette[c(2,3,4)]) 

ggsave('~/Documents/CAMCAN_outputs/figures/JUST_REST_self_corr_per_age_group_hist.pdf', device = "pdf")



RVAideMemoire::perm.t.test(demo$psd_self_corr[demo$Group == "older adult"],demo$psd_self_corr[demo$Group == "young adult"], nperm=1000)



```


```{r differentiability self correlationsn & age}

# NOT RELATED TO SELF CORRELATIONS
lm0=lm(Age ~ 1, demo)
lm1=lm(Age ~ psd_self_corr, demo)
summary(lm1)
sjPlot::tab_model(lm1)

bf = regressionBF(Age ~ psd_self_corr, demo, whichModels = "top")
summary(bf)
cor.test(demo$Age, demo$psd_self_corr)


# Age related to differentiability 
lm0=lm(Age ~ 1, demo)
lm1=lm(Age ~ psd_identifiability, demo)
summary(lm1)
sjPlot::tab_model(lm1)

bf = regressionBF(Age ~ psd_identifiability, demo, whichModels = "top")
summary(bf)
cor.test(demo$Age, demo$psd_identifiability)

ggplot(demo, aes(x=psd_identifiability , y = Age, fill=cbbPalette[1])) + 
  geom_jitter(colour = cbbPalette[1]) + 
  stat_smooth(method = "lm", colour = 'black',fullrange = T, fill = cbbPalette[1]) +
  labs(title = paste("Adj R2 = ", signif(summary(lm1)$adj.r.squared, 5),
                     "Intercept =", signif(lm1$coef[[1]],5 ),
                     " Slope =", signif(lm1$coef[[2]], 5),
                     " P =", signif(summary(lm1)$coef[2,4], 5) )) + scale_fill_manual(values=cbbPalette)  +
  ggpubr::theme_classic2() +   xlab("differentiability") + ylab("Age")+
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"), legend.position = "none") 

ggsave('~/Documents/CAMCAN_outputs/figures/JUST_REST_Regression_AGE_differentiability.pdf', device = "pdf")


```



Bootstrap age effects 

```{r bootstrap fingerprinting effects}

cbbPalette= c("#4f89e0", "#f5ec6c",'#156605',"#76D7C4","#268236", '#4d3d87','#593d80', '#3b49e3')

demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]

psd_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_Rest.csv', header = FALSE)
psd_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_Task.csv', header = FALSE)


fingerprint_boot=matrix(, ncol = 7,nrow=2000)

temp_boot=matrix(, ncol = 2,nrow=1000)

for(i in 1:1000) {
  index_random_par=sample(1:606, 485)
  
  corr_psd=cor(t(psd_rest[index_random_par,]),t(psd_task[index_random_par,])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:485)==tt)/485
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:485)==tt)/485
  
}

fingerprint_boot[,1]= as.vector(temp_boot)
write.csv(fingerprint_boot, '~/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_fingerprinting_fullcohort.csv')

mean(as.vector(temp_boot), na.rm = TRUE)
sd(as.vector(temp_boot), na.rm = TRUE)



index_delta=unlist(lapply(1:68, function(x) ((x-1)*300)+(1:8)))
index_theta=unlist(lapply(1:68, function(x) ((x-1)*300)+(9:16))) # theta
index_alpha=unlist(lapply(1:68, function(x) ((x-1)*300)+(17:26))) # alpha
index_beta=unlist(lapply(1:68, function(x) ((x-1)*300)+(27:60))) # beta
index_gamma=unlist(lapply(1:68, function(x) ((x-1)*300)+(61:101))) # gamma
index_hgamma=unlist(lapply(1:68, function(x) ((x-1)*300)+(102:300))) # Hgamma

index_bands=list(index_delta, index_theta, index_alpha,index_beta,index_gamma,index_hgamma)



for (j in 1:6){
  temp_boot=matrix(, ncol = 2,nrow=1000)
for(i in 1:1000) {
  index_freq=index_bands[[j]]
  index_random_par=sample(1:606, 485)
  
  corr_psd=cor(t(psd_rest[index_random_par,index_freq]),t(psd_task[index_random_par,index_freq])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:485)==tt)/485
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:485)==tt)/485
  
}
  fingerprint_boot[,j+1]= as.vector(temp_boot)
  write.csv(fingerprint_boot, '~/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_fingerprinting_fullcohort.csv')

print(mean(as.vector(temp_boot), na.rm = TRUE))
print(sd(as.vector(temp_boot), na.rm = TRUE))
}


ind=demo$Age>18 & demo$Age <45
psd_rest_age= psd_rest[ind,]
psd_task_age= psd_task[ind,]

fingerprint_boot=matrix(, ncol = 7,nrow=2000)

temp_boot=matrix(, ncol = 2,nrow=1000)

for(i in 1:1000) {
  index_random_par=sample(1:sum(ind), 175)
  
  corr_psd=cor(t(psd_rest_age[index_random_par,]),t(psd_task_age[index_random_par,])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:175)==tt)/175
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:175)==tt)/175
  
}

fingerprint_boot[,1]= as.vector(temp_boot)
write.csv(fingerprint_boot, '~/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_fingerprinting_young.csv')

mean(as.vector(temp_boot), na.rm = TRUE)
sd(as.vector(temp_boot), na.rm = TRUE)



index_delta=unlist(lapply(1:68, function(x) ((x-1)*300)+(1:8)))
index_theta=unlist(lapply(1:68, function(x) ((x-1)*300)+(9:16))) # theta
index_alpha=unlist(lapply(1:68, function(x) ((x-1)*300)+(17:26))) # alpha
index_beta=unlist(lapply(1:68, function(x) ((x-1)*300)+(27:60))) # beta
index_gamma=unlist(lapply(1:68, function(x) ((x-1)*300)+(61:101))) # gamma
index_hgamma=unlist(lapply(1:68, function(x) ((x-1)*300)+(102:300))) # Hgamma

index_bands=list(index_delta, index_theta, index_alpha,index_beta,index_gamma,index_hgamma)



for (j in 1:6){
  temp_boot=matrix(, ncol = 2,nrow=1000)
for(i in 1:1000) {
  index_freq=index_bands[[j]]
  index_random_par=sample(1:sum(ind), 175)
  
  corr_psd=cor(t(psd_rest_age[index_random_par,index_freq]),t(psd_task_age[index_random_par,index_freq])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:175)==tt)/175
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:175)==tt)/175
  
}
  fingerprint_boot[,j+1]= as.vector(temp_boot)
  write.csv(fingerprint_boot, '~/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_fingerprinting_young.csv')

print(mean(as.vector(temp_boot), na.rm = TRUE))
print(sd(as.vector(temp_boot), na.rm = TRUE))
}


ind=demo$Age>=45 & demo$Age <65
psd_rest_age= psd_rest[ind,]
psd_task_age= psd_task[ind,]

fingerprint_boot=matrix(, ncol = 7,nrow=2000)

temp_boot=matrix(, ncol = 2,nrow=1000)

for(i in 1:1000) {
  index_random_par=sample(1:sum(ind), 175)
  
  corr_psd=cor(t(psd_rest_age[index_random_par,]),t(psd_task_age[index_random_par,])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:175)==tt)/175
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:175)==tt)/175
  
}

fingerprint_boot[,1]= as.vector(temp_boot)
write.csv(fingerprint_boot, '/Users/jasondsc/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_fingerprinting_adult.csv')

mean(as.vector(temp_boot), na.rm = TRUE)
sd(as.vector(temp_boot), na.rm = TRUE)



index_delta=unlist(lapply(1:68, function(x) ((x-1)*300)+(1:8)))
index_theta=unlist(lapply(1:68, function(x) ((x-1)*300)+(9:16))) # theta
index_alpha=unlist(lapply(1:68, function(x) ((x-1)*300)+(17:26))) # alpha
index_beta=unlist(lapply(1:68, function(x) ((x-1)*300)+(27:60))) # beta
index_gamma=unlist(lapply(1:68, function(x) ((x-1)*300)+(61:101))) # gamma
index_hgamma=unlist(lapply(1:68, function(x) ((x-1)*300)+(102:300))) # Hgamma

index_bands=list(index_delta, index_theta, index_alpha,index_beta,index_gamma,index_hgamma)



for (j in 1:6){
  temp_boot=matrix(, ncol = 2,nrow=1000)
for(i in 1:1000) {
  index_freq=index_bands[[j]]
  index_random_par=sample(1:sum(ind), 175)
  
  corr_psd=cor(t(psd_rest_age[index_random_par,index_freq]),t(psd_task_age[index_random_par,index_freq])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:175)==tt)/175
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:175)==tt)/175
  
}
  fingerprint_boot[,j+1]= as.vector(temp_boot)
  write.csv(fingerprint_boot, '/Users/jasondsc/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_fingerprinting_adult.csv')

print(mean(as.vector(temp_boot), na.rm = TRUE))
print(sd(as.vector(temp_boot), na.rm = TRUE))
}



ind=demo$Age>=65 & demo$Age <90
psd_rest_age= psd_rest[ind,]
psd_task_age= psd_task[ind,]

fingerprint_boot=matrix(, ncol = 7,nrow=2000)

temp_boot=matrix(, ncol = 2,nrow=1000)

for(i in 1:1000) {
  index_random_par=sample(1:sum(ind), 175)
  
  corr_psd=cor(t(psd_rest_age[index_random_par,]),t(psd_task_age[index_random_par,])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:175)==tt)/175
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:175)==tt)/175
  
}

fingerprint_boot[,1]= as.vector(temp_boot)
write.csv(fingerprint_boot, '/Users/jasondsc/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_fingerprinting_older.csv')

mean(as.vector(temp_boot), na.rm = TRUE)
sd(as.vector(temp_boot), na.rm = TRUE)



index_delta=unlist(lapply(1:68, function(x) ((x-1)*300)+(1:8)))
index_theta=unlist(lapply(1:68, function(x) ((x-1)*300)+(9:16))) # theta
index_alpha=unlist(lapply(1:68, function(x) ((x-1)*300)+(17:26))) # alpha
index_beta=unlist(lapply(1:68, function(x) ((x-1)*300)+(27:60))) # beta
index_gamma=unlist(lapply(1:68, function(x) ((x-1)*300)+(61:101))) # gamma
index_hgamma=unlist(lapply(1:68, function(x) ((x-1)*300)+(102:300))) # Hgamma

index_bands=list(index_delta, index_theta, index_alpha,index_beta,index_gamma,index_hgamma)



for (j in 1:6){
  temp_boot=matrix(, ncol = 2,nrow=1000)
for(i in 1:1000) {
  index_freq=index_bands[[j]]
  index_random_par=sample(1:sum(ind), 175)
  
  corr_psd=cor(t(psd_rest_age[index_random_par,index_freq]),t(psd_task_age[index_random_par,index_freq])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:175)==tt)/175
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:175)==tt)/175
  
}
  fingerprint_boot[,j+1]= as.vector(temp_boot)
  write.csv(fingerprint_boot, '/Users/jasondsc/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_fingerprinting_older.csv')

print(mean(as.vector(temp_boot), na.rm = TRUE))
print(sd(as.vector(temp_boot), na.rm = TRUE))
}


# aperiodic
aper_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/aperioidc_Rest.csv', header = FALSE)
aper_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/aperiodic_Task.csv', header = FALSE)


fingerprint_boot=matrix(, ncol = 7,nrow=2000)
temp_boot=matrix(, ncol = 2,nrow=1000)

for(i in 1:1000) {
  index_random_par=sample(1:606, 485)
  
  corr_psd=cor(t(aper_rest[index_random_par,]),t(aper_task[index_random_par,])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:485)==tt)/485
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:485)==tt)/485
  
}

fingerprint_boot[,1]= as.vector(temp_boot)
write.csv(fingerprint_boot, '/Users/jasondsc/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_fingerprinting_aperiodic.csv')

mean(as.vector(temp_boot), na.rm = TRUE)
sd(as.vector(temp_boot), na.rm = TRUE)


ind=demo$Age>18 & demo$Age <45
psd_rest_age= aper_rest[ind,]
psd_task_age= aper_task[ind,]

temp_boot=matrix(, ncol = 2,nrow=1000)

for(i in 1:1000) {
  index_random_par=sample(1:sum(ind), 175)
  
  corr_psd=cor(t(psd_rest_age[index_random_par,]),t(psd_task_age[index_random_par,])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:175)==tt)/175
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:175)==tt)/175
  
}

fingerprint_boot[,2]= as.vector(temp_boot)
write.csv(fingerprint_boot, '/Users/jasondsc/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_fingerprinting_aperiodic.csv')

mean(as.vector(temp_boot), na.rm = TRUE)
sd(as.vector(temp_boot), na.rm = TRUE)



ind=demo$Age>=45 & demo$Age <65
psd_rest_age= aper_rest[ind,]
psd_task_age= aper_task[ind,]


temp_boot=matrix(, ncol = 2,nrow=1000)

for(i in 1:1000) {
  index_random_par=sample(1:sum(ind), 175)
  
  corr_psd=cor(t(psd_rest_age[index_random_par,]),t(psd_task_age[index_random_par,])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:175)==tt)/175
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:175)==tt)/175
  
}

fingerprint_boot[,3]= as.vector(temp_boot)
write.csv(fingerprint_boot, '/Users/jasondsc/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_fingerprinting_aperiodic.csv')

mean(as.vector(temp_boot), na.rm = TRUE)
sd(as.vector(temp_boot), na.rm = TRUE)


ind=demo$Age>=65 & demo$Age <90
psd_rest_age= aper_rest[ind,]
psd_task_age= aper_task[ind,]

temp_boot=matrix(, ncol = 2,nrow=1000)

for(i in 1:1000) {
  index_random_par=sample(1:sum(ind), 175)
  
  corr_psd=cor(t(psd_rest_age[index_random_par,]),t(psd_task_age[index_random_par,])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:175)==tt)/175
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:175)==tt)/175
  
}

fingerprint_boot[,4]= as.vector(temp_boot)
write.csv(fingerprint_boot, '/Users/jasondsc/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_fingerprinting_aperiodic.csv')

mean(as.vector(temp_boot), na.rm = TRUE)
sd(as.vector(temp_boot), na.rm = TRUE)

```

```{r plot fingerprint age effect }

data1=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_fingerprinting_fullcohort.csv')

data1=data1[,-1]
data4plot= data.frame(mean_differen=apply(data1, 2, mean), lower=apply(data1, 2, quantile, probs=c(0.025,0.975))[1,], upper= apply(data1, 2, quantile, probs=c(0.025,0.975))[2,])

data4plot$band= c("full band", "delta", "theta", "alpha", "beta", "gamma", "high gamma")
data4plot$group= rep('full cohort',7)

data1=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_fingerprinting_older.csv')

data1=data1[,-1]

data4plot2= data.frame(mean_differen=apply(data1, 2, mean), lower=apply(data1, 2, quantile, probs=c(0.025,0.975))[1,], upper= apply(data1, 2, quantile, probs=c(0.025,0.975))[2,])

data4plot2$band= c("full band", "delta", "theta", "alpha", "beta", "gamma", "high gamma")
data4plot2$group= rep('older',7)

data4plot= rbind(data4plot, data4plot2)


data1=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_fingerprinting_adult.csv')

data1=data1[,-1]

data4plot2= data.frame(mean_differen=apply(data1, 2, mean), lower=apply(data1, 2, quantile, probs=c(0.025,0.975))[1,], upper= apply(data1, 2, quantile, probs=c(0.025,0.975))[2,])

data4plot2$band= c("full band", "delta", "theta", "alpha", "beta", "gamma", "high gamma")
data4plot2$group= rep('adult',7)

data4plot= rbind(data4plot, data4plot2)


data1=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_fingerprinting_young.csv')

data1=data1[,-1]

data4plot2= data.frame(mean_differen=apply(data1, 2, mean), lower=apply(data1, 2, quantile, probs=c(0.025,0.975))[1,], upper= apply(data1, 2, quantile, probs=c(0.025,0.975))[2,])

data4plot2$band= c("full band", "delta", "theta", "alpha", "beta", "gamma", "high gamma")
data4plot2$group= rep('young',7)

data4plot= rbind(data4plot, data4plot2)


data1=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_fingerprinting_aperiodic.csv')

data1=data1[,-1]
data1=data1[,-c(5,6,7)]

data4plot2= data.frame(mean_differen=apply(data1, 2, mean), lower=apply(data1, 2, quantile, probs=c(0.025,0.975))[1,], upper= apply(data1, 2, quantile, probs=c(0.025,0.975))[2,])

data4plot2$group= c("full cohort", "young", "adult", "older")
data4plot2$band= rep('aperiodic',4)

data4plot= rbind(data4plot, data4plot2)

data4plot[,c(1,2,3)]= data4plot[,c(1,2,3)]*100

data4plot$band= factor(data4plot$band, levels = c("full band", "delta", "theta", "alpha", "beta", "gamma", "high gamma", "aperiodic"))

data4plot$group= factor(data4plot$group, levels = c("full cohort", "young", "adult", "older"))


ggplot(data=data4plot, aes(x=band, y=mean_differen, fill=group, width=.5)) +  coord_cartesian(ylim=c(50,100))+geom_bar(stat = "identity", position=position_dodge(width = 0.5)) + geom_errorbar(aes(ymin=lower, ymax=upper), width=.2 ,position=position_dodge(.5))  +theme_minimal() + scale_fill_manual(values=cbbPalette) + labs(y="Accuracy (%)", x="",title="") + theme(text = element_text(size=40), legend.title=element_blank())

ggsave('~/Documents/CAMCAN_outputs/figures/Fingerprinting_age_bootstrapped.pdf', device = "pdf", width=25, height=4.51, dpi=800)



```




``` {r JUST REST regress out artifacts from spectra}

demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]

psd_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_justRest.csv', header = FALSE)
psd_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_justRest2.csv', header = FALSE)

artifacts_rest= read.csv('~/Documents/CAMCAN_outputs/artifacts_from_rest_CAMCAN.csv')

hlu1_rest= rowMeans(artifacts_rest[,1:3])
hlu2_rest= rowMeans(artifacts_rest[,4:6])
ecg_rest= artifacts_rest$ecg1
eog_rest= rowMeans(artifacts_rest[11:12])

library(lme4)

psd_rest_residuals=matrix(, nrow = 606, ncol =length(psd_rest) )
psd_task_residuals=matrix(, nrow = 606, ncol =length(psd_rest) )
for (i in 1:length(psd_rest)){
  
  data4reg=data.frame(psd= c(psd_rest[,i], psd_task[,i]), ids= c(1:606,1:606), hlu1= c(hlu1_rest), hlu2= c(hlu2_rest), ecg= c(ecg_rest), eog= c(eog_rest))
  
  data4reg$ids= as.factor(data4reg$ids)
  
  lm1= lmer(psd ~ (1|ids) + hlu1 + hlu2 +ecg +eog, data4reg )
  coeff=coef(lm1)$ids
  residuals_temp=residuals(lm1) + coeff[,1]
  psd_rest_residuals[,i]=residuals_temp[1:606]
  psd_task_residuals[,i]=residuals_temp[607:1212]
}

write.csv(psd_rest_residuals, '~/Documents/CAMCAN_outputs/CAMCAN_Analysis/psd_Rest_residuals.csv', row.names = FALSE, col.names = FALSE)

write.csv(psd_task_residuals, '~/Documents/CAMCAN_outputs/CAMCAN_Analysis/psd_Rest2_residuals.csv', row.names = FALSE, col.names = FALSE)

```


```{r artifacts}

demo= read.csv('~/Documents/CAMCAN_outputs/Delta_AIC_frequency_bands.csv')

# set colour palette
cbbPalette= c("#DBF132", "#15A705",'#4F89E0',"#D81B99", '#4d3d87','#593d80', '#3b49e3')

demo$Group[demo$Age>18 & demo$Age <45]= "young adult"
demo$Group[demo$Age>=45 & demo$Age <65]= "adult"
demo$Group[demo$Age>=65 & demo$Age <90]= "older adult"

artifacts_rest= read.csv('~/Documents/CAMCAN_outputs/artifacts_from_rest_CAMCAN.csv')
artifacts_task= read.csv('~/Documents/CAMCAN_outputs/artifacts_from_task_CAMCAN.csv')

artifact_fingerprinting=matrix(, ncol = 4,nrow=5)

corr_psd=cor(t(artifacts_rest[,c(1:6, 10:12)]),t(artifacts_task[,c(1:6, 10:12)])) 

print("artifact fingerprinting:")
tt=apply(corr_psd, 1, which.max)
artifact_fingerprinting[1,1]=sum(seq(1:606)==tt)/606
tt=apply(corr_psd, 2, which.max)
artifact_fingerprinting[1,2]=sum(seq(1:606)==tt)/606

corr_psd=cor(t(artifacts_rest[,1:6]),t(artifacts_task[,1:6])) 

print("artifact fingerprinting:")
tt=apply(corr_psd, 1, which.max)
artifact_fingerprinting[2,1]=sum(seq(1:606)==tt)/606
tt=apply(corr_psd, 2, which.max)
artifact_fingerprinting[2,2]=sum(seq(1:606)==tt)/606

corr_psd=cor(t(artifacts_rest[,1:3]),t(artifacts_task[,1:3])) 

print("artifact fingerprinting:")
tt=apply(corr_psd, 1, which.max)
artifact_fingerprinting[3,1]=sum(seq(1:606)==tt)/606
tt=apply(corr_psd, 2, which.max)
artifact_fingerprinting[3,2]=sum(seq(1:606)==tt)/606

corr_psd=cor(t(artifacts_rest[,4:6]),t(artifacts_task[,4:6])) 

print("artifact fingerprinting:")
tt=apply(corr_psd, 1, which.max)
artifact_fingerprinting[4,1]=sum(seq(1:606)==tt)/606
tt=apply(corr_psd, 2, which.max)
artifact_fingerprinting[4,2]=sum(seq(1:606)==tt)/606


corr_psd=cor(t(artifacts_rest[,11:12]),t(artifacts_task[,11:12])) 

print("artifact fingerprinting:")
tt=apply(corr_psd, 1, which.max)
artifact_fingerprinting[5,1]=sum(seq(1:606)==tt)/606
tt=apply(corr_psd, 2, which.max)
artifact_fingerprinting[5,2]=sum(seq(1:606)==tt)/606

artifact_fingerprinting[,3]= rowMeans(artifact_fingerprinting[,1:2])*100

artifact_fingerprinting=as.data.frame(artifact_fingerprinting)

artifact_fingerprinting[,4] = ordered(c("all artifacts", "head motion", "head motion: rotation", "head motion: translation", 'occular artifacts'), levels= c("all artifacts", "head motion", "head motion: rotation", "head motion: translation", 'occular artifacts'))

colnames(artifact_fingerprinting)[3:4]=c('ACC', 'group')


ggplot(data=artifact_fingerprinting, aes(x=group, y=ACC, fill=group, width=.5)) +  coord_cartesian(ylim=c(0,100))+geom_bar(stat = "identity", position=position_dodge(width = 0.5)) +theme_minimal() + scale_fill_manual(values=cbbPalette) + labs(y="Accuracy (%)", x="",title="") + theme(text = element_text(size=40), legend.title=element_blank(), axis.text.x = element_text(angle = 90))

ggsave('~/Documents/CAMCAN_outputs/figures/Fingerprinting_artifacts.pdf', device = "pdf", width=10, height=10, dpi=800)


hlu= rowMeans(artifacts_rest[,1:6])
hlu1= rowMeans(artifacts_rest[,1:3])
hlu2= rowMeans(artifacts_rest[,4:6])
ecg= artifacts_rest$ecg1
eog= rowMeans(artifacts_rest[11:12])

# Age related to differentiability 
lm0=lm(Age ~ 1, demo)
lm1=lm(Age ~ psd_identifiability + hlu1, demo)
summary(lm1)
sjPlot::tab_model(lm1)

# Age related to differentiability 
lm0=lm(Age ~ 1, demo)
lm1=lm(Age ~ psd_identifiability + hlu, demo)
summary(lm1)
sjPlot::tab_model(lm1)

lm1=lm(psd_identifiability ~ hlu, demo)
summary(lm1)
sjPlot::tab_model(lm1)

demo$hlu= hlu
bf = regressionBF(psd_identifiability ~ hlu, demo, whichModels = "top")
summary(bf)

lm1=lm(psd_identifiability ~ ecg, demo)
summary(lm1)
sjPlot::tab_model(lm1)

lm1=lm(psd_identifiability ~ eog, demo)
summary(lm1)
sjPlot::tab_model(lm1)


lm1=lm(Age ~ hlu1, demo)
summary(lm1)
sjPlot::tab_model(lm1)

lm1=lm(Age ~ hlu2, demo)
summary(lm1)
sjPlot::tab_model(lm1)

lm1=lm(Age ~ ecg, demo)
summary(lm1)
sjPlot::tab_model(lm1)

lm1=lm(Age ~ eog, demo)
summary(lm1)
sjPlot::tab_model(lm1)


lm1=lm(demo$psd_identifiability[ demo$Group=='young adult'] ~ hlu[demo$Group=='young adult'])
summary(lm1)

lm1=lm(demo$psd_identifiability[ demo$Group=='older adult'] ~ hlu[demo$Group=='older adult'])
summary(lm1)

lm1=lm(demo$psd_identifiability[ demo$Group=='young adult'] ~ hlu1[demo$Group=='young adult'])
summary(lm1)

lm1=lm(demo$psd_identifiability[ demo$Group=='older adult'] ~ hlu1[demo$Group=='older adult'])
summary(lm1)

lm1=lm(demo$psd_identifiability[ demo$Group=='young adult'] ~ hlu2[demo$Group=='young adult'])
summary(lm1)

lm1=lm(demo$psd_identifiability[ demo$Group=='older adult'] ~ hlu2[demo$Group=='older adult'])
summary(lm1)


lm1=lm(psd_identifiability ~ hlu1 , demo)

ggplot(demo, aes(x=psd_identifiability, y = hlu1, fill=cbbPalette[1])) + 
  geom_jitter(colour = cbbPalette[1]) + 
  stat_smooth(method = "lm", colour = 'black',fullrange = T, fill = cbbPalette[1]) +
  labs(title = paste("Adj R2 = ", signif(summary(lm1)$adj.r.squared, 5),
                     "Intercept =", signif(lm1$coef[[1]],5 ),
                     " Slope =", signif(lm1$coef[[2]], 5),
                     " P =", signif(summary(lm1)$coef[2,4], 5) )) + scale_fill_manual(values=cbbPalette)  +
  theme_minimal() +   xlab("differentiability") + ylab("head motion rotation")+
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"), legend.position = "none") 

ggsave('~/Documents/CAMCAN_outputs/figures/JUSTREST_Regression_ARTIFACTS_differentiability_headmotion_rotation.pdf', device = "pdf", width=5, height=5, dpi=800)


lm1=lm(psd_identifiability ~ hlu2 , demo)

ggplot(demo, aes(x=psd_identifiability, y = hlu2, fill=cbbPalette[5])) + 
  geom_jitter(colour = cbbPalette[5]) + 
  stat_smooth(method = "lm", colour = 'black',fullrange = T, fill = cbbPalette[5]) +
  labs(title = paste("Adj R2 = ", signif(summary(lm1)$adj.r.squared, 5),
                     "Intercept =", signif(lm1$coef[[1]],5 ),
                     " Slope =", signif(lm1$coef[[2]], 5),
                     " P =", signif(summary(lm1)$coef[2,4], 5) )) + scale_fill_manual(values=cbbPalette)  +
  theme_minimal() +   xlab("differentiability") + ylab("head motion translation")+
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"), legend.position = "none") 

ggsave('~/Documents/CAMCAN_outputs/figures/JUSTREST_Regression_ARTIFACTS_differentiability_headmotion_translation.pdf', device = "pdf", width=5, height=5, dpi=800)


lm1=lm(psd_identifiability ~ log(hlu2) , demo)

ggplot(demo, aes(x=psd_identifiability, y = log(hlu2), fill=cbbPalette[5])) + 
  geom_jitter(colour = cbbPalette[5]) + 
  stat_smooth(method = "lm", colour = 'black',fullrange = T, fill = cbbPalette[5]) +
  labs(title = paste("Adj R2 = ", signif(summary(lm1)$adj.r.squared, 5),
                     "Intercept =", signif(lm1$coef[[1]],5 ),
                     " Slope =", signif(lm1$coef[[2]], 5),
                     " P =", signif(summary(lm1)$coef[2,4], 5) )) + scale_fill_manual(values=cbbPalette)  +
  theme_minimal() +   xlab("differentiability") + ylab("log head motion translation")+
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"), legend.position = "none") 

ggsave('~/Documents/CAMCAN_outputs/figures/JUSTREST_Regression_ARTIFACTS_differentiability_headmotion_translation_log.pdf', device = "pdf", width=5, height=5, dpi=800)


lm1=lm(Age ~ hlu1 , demo)

ggplot(demo, aes(x=Age, y = hlu1, fill=cbbPalette[1])) + 
  geom_jitter(colour = cbbPalette[1]) + 
  stat_smooth(method = "lm", colour = 'black',fullrange = T, fill = cbbPalette[1]) +
  labs(title = paste("Adj R2 = ", signif(summary(lm1)$adj.r.squared, 5),
                     "Intercept =", signif(lm1$coef[[1]],5 ),
                     " Slope =", signif(lm1$coef[[2]], 5),
                     " P =", signif(summary(lm1)$coef[2,4], 5) )) + scale_fill_manual(values=cbbPalette)  +
  theme_minimal() +   xlab("age") + ylab("head motion translation")+
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"), legend.position = "none") 

ggsave('~/Documents/CAMCAN_outputs/figures/Regression_ARTIFACTS_Age_headmotion_rotion.pdf', device = "pdf", width=5, height=5, dpi=800)


lm1=lm(psd_identifiability ~ ecg , demo)

ggplot(demo, aes(x=psd_identifiability, y = ecg, fill=cbbPalette[4])) + 
  geom_jitter(colour = cbbPalette[4]) + 
  stat_smooth(method = "lm", colour = 'black',fullrange = T, fill = cbbPalette[4]) +
  labs(title = paste("Adj R2 = ", signif(summary(lm1)$adj.r.squared, 5),
                     "Intercept =", signif(lm1$coef[[1]],5 ),
                     " Slope =", signif(lm1$coef[[2]], 5),
                     " P =", signif(summary(lm1)$coef[2,4], 5) )) + scale_fill_manual(values=cbbPalette)  +
  theme_minimal() +   xlab("differentiability") + ylab("ecg")+
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"), legend.position = "none") 

ggsave('~/Documents/CAMCAN_outputs/figures/Regression_ARTIFACTS_differentiability_ecg.pdf', device = "pdf", width=5, height=5, dpi=800)


lm1=lm(Age ~ ecg , demo)

ggplot(demo, aes(x=Age, y = ecg, fill=cbbPalette[4])) + 
  geom_jitter(colour = cbbPalette[4]) + 
  stat_smooth(method = "lm", colour = 'black',fullrange = T, fill = cbbPalette[4]) +
  labs(title = paste("Adj R2 = ", signif(summary(lm1)$adj.r.squared, 5),
                     "Intercept =", signif(lm1$coef[[1]],5 ),
                     " Slope =", signif(lm1$coef[[2]], 5),
                     " P =", signif(summary(lm1)$coef[2,4], 5) )) + scale_fill_manual(values=cbbPalette)  +
  theme_minimal() +   xlab("age") + ylab("ecg")+
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"), legend.position = "none") 

ggsave('~/Documents/CAMCAN_outputs/figures/Regression_ARTIFACTS_age_ecg.pdf', device = "pdf", width=5, height=5, dpi=800)


lm1=lm(Age ~ log(ecg) , demo)

ggplot(demo, aes(x=Age, y = log(ecg), fill=cbbPalette[4])) + 
  geom_jitter(colour = cbbPalette[4]) + 
  stat_smooth(method = "lm", colour = 'black',fullrange = T, fill = cbbPalette[4]) +
  labs(title = paste("Adj R2 = ", signif(summary(lm1)$adj.r.squared, 5),
                     "Intercept =", signif(lm1$coef[[1]],5 ),
                     " Slope =", signif(lm1$coef[[2]], 5),
                     " P =", signif(summary(lm1)$coef[2,4], 5) )) + scale_fill_manual(values=cbbPalette)  +
  theme_minimal() +   xlab("age") + ylab("log ecg")+
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"), legend.position = "none") 

ggsave('~/Documents/CAMCAN_outputs/figures/Regression_ARTIFACTS_age_ecg_log.pdf', device = "pdf", width=5, height=5, dpi=800)


lm1=lm(psd_identifiability ~ log(ecg) , demo)

ggplot(demo, aes(x=psd_identifiability, y = log(ecg), fill=cbbPalette[4])) + 
  geom_jitter(colour = cbbPalette[4]) + 
  stat_smooth(method = "lm", colour = 'black',fullrange = T, fill = cbbPalette[4]) +
  labs(title = paste("Adj R2 = ", signif(summary(lm1)$adj.r.squared, 5),
                     "Intercept =", signif(lm1$coef[[1]],5 ),
                     " Slope =", signif(lm1$coef[[2]], 5),
                     " P =", signif(summary(lm1)$coef[2,4], 5) )) + scale_fill_manual(values=cbbPalette)  +
  theme_minimal() +   xlab("differentiability") + ylab("log ecg")+
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"), legend.position = "none") 

ggsave('~/Documents/CAMCAN_outputs/figures/Regression_ARTIFACTS_differentiability_ecg_log.pdf', device = "pdf", width=5, height=5, dpi=800)



lm1=lm(psd_identifiability ~ eog , demo)

ggplot(demo, aes(x=psd_identifiability, y = eog, fill=cbbPalette[3])) + 
  geom_jitter(colour = cbbPalette[3]) + 
  stat_smooth(method = "lm", colour = 'black',fullrange = T, fill = cbbPalette[3]) +
  labs(title = paste("Adj R2 = ", signif(summary(lm1)$adj.r.squared, 5),
                     "Intercept =", signif(lm1$coef[[1]],5 ),
                     " Slope =", signif(lm1$coef[[2]], 5),
                     " P =", signif(summary(lm1)$coef[2,4], 5) )) + scale_fill_manual(values=cbbPalette)  +
  theme_minimal() +   xlab("differentiability") + ylab("eog")+
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"), legend.position = "none") 

ggsave('~/Documents/CAMCAN_outputs/figures/Regression_ARTIFACTS_differentiability_eog.pdf', device = "pdf", width=5, height=5, dpi=800)


lm1=lm(psd_identifiability ~ log(eog) , demo)

ggplot(demo, aes(x=psd_identifiability, y = log(eog), fill=cbbPalette[3])) + 
  geom_jitter(colour = cbbPalette[3]) + 
  stat_smooth(method = "lm", colour = 'black',fullrange = T, fill = cbbPalette[3]) +
  labs(title = paste("Adj R2 = ", signif(summary(lm1)$adj.r.squared, 5),
                     "Intercept =", signif(lm1$coef[[1]],5 ),
                     " Slope =", signif(lm1$coef[[2]], 5),
                     " P =", signif(summary(lm1)$coef[2,4], 5) )) + scale_fill_manual(values=cbbPalette)  +
  theme_minimal() +   xlab("differentiability") + ylab("log eog")+
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"), legend.position = "none") 

ggsave('~/Documents/CAMCAN_outputs/figures/Regression_ARTIFACTS_differentiability_eog_log.pdf', device = "pdf", width=5, height=5, dpi=800)


```

```{r bootstrap artifact corrected fingerprinting effects}

cbbPalette= c("#4f89e0", "#f5ec6c",'#156605',"#76D7C4","#268236", '#4d3d87','#593d80', '#3b49e3')

demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]

psd_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/psd_Rest_residuals.csv', header = TRUE)
psd_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/psd_Rest2_residuals.csv', header = TRUE)

fingerprint_boot=matrix(, ncol = 7,nrow=2000)

temp_boot=matrix(, ncol = 2,nrow=1000)

for(i in 1:1000) {
  index_random_par=sample(1:606, 485)
  
  corr_psd=cor(t(psd_rest[index_random_par,]),t(psd_task[index_random_par,])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:485)==tt)/485
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:485)==tt)/485
  
}

fingerprint_boot[,1]= as.vector(temp_boot)
write.csv(fingerprint_boot, '~/Documents/CAMCAN_outputs/CAMCAN_Analysis/JUSTREST_ARTIFACT_CORRECTED_bootstrapped_fingerprinting_fullcohort.csv')

mean(as.vector(temp_boot), na.rm = TRUE)
sd(as.vector(temp_boot), na.rm = TRUE)


ind=demo$Age>18 & demo$Age <45
psd_rest_age= psd_rest[ind,]
psd_task_age= psd_task[ind,]

fingerprint_boot=matrix(, ncol = 7,nrow=2000)

temp_boot=matrix(, ncol = 2,nrow=1000)

for(i in 1:1000) {
  index_random_par=sample(1:sum(ind), 175)
  
  corr_psd=cor(t(psd_rest_age[index_random_par,]),t(psd_task_age[index_random_par,])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:175)==tt)/175
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:175)==tt)/175
  
}

fingerprint_boot[,1]= as.vector(temp_boot)
write.csv(fingerprint_boot, '~/Documents/CAMCAN_outputs/CAMCAN_Analysis/JUSTREST_ARTIFACT_CORRECTED_bootstrapped_fingerprinting_young.csv')

mean(as.vector(temp_boot), na.rm = TRUE)
sd(as.vector(temp_boot), na.rm = TRUE)


ind=demo$Age>=45 & demo$Age <65
psd_rest_age= psd_rest[ind,]
psd_task_age= psd_task[ind,]

fingerprint_boot=matrix(, ncol = 7,nrow=2000)

temp_boot=matrix(, ncol = 2,nrow=1000)

for(i in 1:1000) {
  index_random_par=sample(1:sum(ind), 175)
  
  corr_psd=cor(t(psd_rest_age[index_random_par,]),t(psd_task_age[index_random_par,])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:175)==tt)/175
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:175)==tt)/175
  
}

fingerprint_boot[,1]= as.vector(temp_boot)
write.csv(fingerprint_boot, '/Users/jasondsc/Documents/CAMCAN_outputs/CAMCAN_Analysis/JUSTREST_ARTIFACT_CORRECTED_bootstrapped_fingerprinting_adult.csv')

mean(as.vector(temp_boot), na.rm = TRUE)
sd(as.vector(temp_boot), na.rm = TRUE)



ind=demo$Age>=65 & demo$Age <90
psd_rest_age= psd_rest[ind,]
psd_task_age= psd_task[ind,]

fingerprint_boot=matrix(, ncol = 7,nrow=2000)

temp_boot=matrix(, ncol = 2,nrow=1000)

for(i in 1:1000) {
  index_random_par=sample(1:sum(ind), 175)
  
  corr_psd=cor(t(psd_rest_age[index_random_par,]),t(psd_task_age[index_random_par,])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:175)==tt)/175
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:175)==tt)/175
  
}

fingerprint_boot[,1]= as.vector(temp_boot)
write.csv(fingerprint_boot, '/Users/jasondsc/Documents/CAMCAN_outputs/CAMCAN_Analysis/JUSTREST_ARTIFACT_CORRECTED_bootstrapped_fingerprinting_older.csv')

mean(as.vector(temp_boot), na.rm = TRUE)
sd(as.vector(temp_boot), na.rm = TRUE)


```


```{r fingerprinting of empty room}

library(ggplot2)
library(dplyr)


cbbPalette= c("#4f89e0", "#f5ec6c",'#156605',"#76D7C4","#268236", '#4d3d87','#593d80', '#3b49e3')


demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]

psd_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_justRest.csv', header = FALSE)
psd_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_justRest2.csv', header = FALSE)

emptyroom=read.csv('~/Documents/CAMCAN_outputs/PSD_emptyroom.csv', header = FALSE)

fingerprint=matrix(, ncol = 5,nrow=4)

corr_emptyroom1=cor(t(psd_rest),t(emptyroom)) 

print("emptyroom fingerprinting accuracy:")
tt=apply(corr_emptyroom1, 1, which.max)
fingerprint[1,1]=sum(seq(1:606)==tt)/606
tt=apply(corr_emptyroom1, 2, which.max)
fingerprint[1,2]=sum(seq(1:606)==tt)/606


corr_emptyroom2=cor(t(psd_task),t(emptyroom)) 

print("emptyroom fingerprinting accuracy:")
tt=apply(corr_emptyroom2, 1, which.max)
fingerprint[1,3]=sum(seq(1:606)==tt)/606
tt=apply(corr_emptyroom2, 2, which.max)
fingerprint[1,4]=sum(seq(1:606)==tt)/606


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(psd_rest[ind,]),t(emptyroom[ind,])) 
print("psd fingerprinting young adults:")
tt=apply(corr_psd, 1, which.max)
fingerprint[2,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[2,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

corr_psd=cor(t(psd_task[ind,]),t(emptyroom[ind,])) 
print("psd fingerprinting young adults:")
tt=apply(corr_psd, 1, which.max)
fingerprint[2,3]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[2,4]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(psd_rest[ind,]),t(emptyroom[ind,])) 
print("psd fingerprinting adults:")
tt=apply(corr_psd, 1, which.max)
fingerprint[3,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[3,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

corr_psd=cor(t(psd_task[ind,]),t(emptyroom[ind,])) 
print("psd fingerprinting adults:")
tt=apply(corr_psd, 1, which.max)
fingerprint[3,3]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[3,4]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(psd_rest[ind,]),t(emptyroom[ind,])) 
print("psd fingerprinting older adults:")
tt=apply(corr_psd, 1, which.max)
fingerprint[4,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[4,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

corr_psd=cor(t(psd_task[ind,]),t(emptyroom[ind,])) 
print("psd fingerprinting older adults:")
tt=apply(corr_psd, 1, which.max)
fingerprint[4,3]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[4,4]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint=as.data.frame(fingerprint)

fingerprint[,5]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[,6]=c("full band", "full band", "full band", "full band")

colnames(fingerprint) = c("acc1", "acc2","acc1", "acc2", "age_group", "band")

data4plot=cbind(stack(fingerprint[,1:4]),fingerprint[,5:6])
data4plot$values=as.numeric(data4plot$values)*100

data4plot$age_group = ordered(fingerprint$age_group, levels= c("full dataset", "younger adults", "adults", "older adults"))

data4plot$band = ordered(fingerprint$band, levels= c("full band"))

ggplot(data=data4plot, aes(x=band, y=values, fill=age_group, width=.5)) +  coord_cartesian(ylim=c(0,100))+geom_bar(stat = "identity", position=position_dodge(width = 0.5)) +theme_minimal() + scale_fill_manual(values=cbbPalette) + labs(y="Accuracy (%)", x="",title="") + theme(text = element_text(size=40), legend.title=element_blank())

ggsave('/Users/jasondsc/Documents/CAMCAN_outputs/figures/JUSTREST_Emptyroom_Fingerprinting_age.pdf', device = "pdf", width=25, height=4.51, dpi=800)


```



bootstrap aperiodic corr

```{r bootstrap aperiodic corrected fingerprinting effects}


cbbPalette= c("#4f89e0", "#f5ec6c",'#156605',"#76D7C4","#268236", '#4d3d87','#593d80', '#3b49e3')

demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]

ap_corr_psd_rest= read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/corrspec_Rest.csv', header = FALSE)
ap_corr_psd_task= read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/corrspec_Task.csv', header = FALSE)


fingerprint_boot=matrix(, ncol = 7,nrow=2000)

temp_boot=matrix(, ncol = 2,nrow=1000)

for(i in 1:1000) {
  index_random_par=sample(1:606, 485)
  
  corr_psd=cor(t(ap_corr_psd_rest[index_random_par,]),t(ap_corr_psd_task[index_random_par,])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:485)==tt)/485
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:485)==tt)/485
  
}

fingerprint_boot[,1]= as.vector(temp_boot)
write.csv(fingerprint_boot, '/Users/jasondsc/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_aperiodic_corr_fingerprinting_fullcohort.csv')

mean(as.vector(temp_boot), na.rm = TRUE)
sd(as.vector(temp_boot), na.rm = TRUE)



index_delta=unlist(lapply(1:68, function(x) ((x-1)*78)+(1:6))) # delta 
index_theta=unlist(lapply(1:68, function(x) ((x-1)*78)+(7:14))) # theta
index_alpha=unlist(lapply(1:68, function(x) ((x-1)*78)+(15:24))) # alpha
index_beta=unlist(lapply(1:68, function(x) ((x-1)*78)+(25:58))) # beta

index_bands=list(index_delta, index_theta, index_alpha,index_beta)


for (j in 1:4){
  temp_boot=matrix(, ncol = 2,nrow=1000)
for(i in 1:1000) {
  index_freq=index_bands[[j]]
  index_random_par=sample(1:606, 485)
  
  corr_psd=cor(t(ap_corr_psd_rest[index_random_par,index_freq]),t(ap_corr_psd_task[index_random_par,index_freq])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:485)==tt)/485
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:485)==tt)/485
  
}
  fingerprint_boot[,j+1]= as.vector(temp_boot)
  write.csv(fingerprint_boot, '/Users/jasondsc/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_aperiodic_corr_fingerprinting_fullcohort.csv')

print(mean(as.vector(temp_boot), na.rm = TRUE))
print(sd(as.vector(temp_boot), na.rm = TRUE))
}


ind=demo$Age>18 & demo$Age <45
ap_corr_psd_rest_age= ap_corr_psd_rest[ind,]
ap_corr_psd_task_age= ap_corr_psd_task[ind,]

fingerprint_boot=matrix(, ncol = 7,nrow=2000)

temp_boot=matrix(, ncol = 2,nrow=1000)

for(i in 1:1000) {
  index_random_par=sample(1:sum(ind), 175)
  
  corr_psd=cor(t(ap_corr_psd_rest_age[index_random_par,]),t(ap_corr_psd_task_age[index_random_par,])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:175)==tt)/175
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:175)==tt)/175
  
}

fingerprint_boot[,1]= as.vector(temp_boot)
write.csv(fingerprint_boot, '/Users/jasondsc/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_aperiodic_corr_fingerprinting_young.csv')

mean(as.vector(temp_boot), na.rm = TRUE)
sd(as.vector(temp_boot), na.rm = TRUE)




index_delta=unlist(lapply(1:68, function(x) ((x-1)*78)+(1:6))) # delta 
index_theta=unlist(lapply(1:68, function(x) ((x-1)*78)+(7:14))) # theta
index_alpha=unlist(lapply(1:68, function(x) ((x-1)*78)+(15:24))) # alpha
index_beta=unlist(lapply(1:68, function(x) ((x-1)*78)+(25:58))) # beta

index_bands=list(index_delta, index_theta, index_alpha,index_beta)

for (j in 1:4){
  temp_boot=matrix(, ncol = 2,nrow=1000)
for(i in 1:1000) {
  index_freq=index_bands[[j]]
  index_random_par=sample(1:sum(ind), 175)
  
  corr_psd=cor(t(ap_corr_psd_rest_age[index_random_par,index_freq]),t(ap_corr_psd_task_age[index_random_par,index_freq])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:175)==tt)/175
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:175)==tt)/175
  
}
  fingerprint_boot[,j+1]= as.vector(temp_boot)
  write.csv(fingerprint_boot, '/Users/jasondsc/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_aperiodic_corr_fingerprinting_young.csv')

print(mean(as.vector(temp_boot), na.rm = TRUE))
print(sd(as.vector(temp_boot), na.rm = TRUE))
}


ind=demo$Age>=45 & demo$Age <65
ap_corr_psd_rest_age= ap_corr_psd_rest[ind,]
ap_corr_psd_task_age= ap_corr_psd_task[ind,]

fingerprint_boot=matrix(, ncol = 7,nrow=2000)

temp_boot=matrix(, ncol = 2,nrow=1000)

for(i in 1:1000) {
  index_random_par=sample(1:sum(ind), 175)
  
  corr_psd=cor(t(ap_corr_psd_rest_age[index_random_par,]),t(ap_corr_psd_task_age[index_random_par,])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:175)==tt)/175
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:175)==tt)/175
  
}

fingerprint_boot[,1]= as.vector(temp_boot)
write.csv(fingerprint_boot, '/Users/jasondsc/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_aperiodic_corr_fingerprinting_adult.csv')

mean(as.vector(temp_boot), na.rm = TRUE)
sd(as.vector(temp_boot), na.rm = TRUE)



index_delta=unlist(lapply(1:68, function(x) ((x-1)*78)+(1:6))) # delta 
index_theta=unlist(lapply(1:68, function(x) ((x-1)*78)+(7:14))) # theta
index_alpha=unlist(lapply(1:68, function(x) ((x-1)*78)+(15:24))) # alpha
index_beta=unlist(lapply(1:68, function(x) ((x-1)*78)+(25:58))) # beta

index_bands=list(index_delta, index_theta, index_alpha,index_beta)


for (j in 1:4){
  temp_boot=matrix(, ncol = 2,nrow=1000)
for(i in 1:1000) {
  index_freq=index_bands[[j]]
  index_random_par=sample(1:sum(ind), 175)
  
  corr_psd=cor(t(ap_corr_psd_rest_age[index_random_par,index_freq]),t(ap_corr_psd_task_age[index_random_par,index_freq])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:175)==tt)/175
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:175)==tt)/175
  
}
  fingerprint_boot[,j+1]= as.vector(temp_boot)
  write.csv(fingerprint_boot, '/Users/jasondsc/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_aperiodic_corr_fingerprinting_adult.csv')

print(mean(as.vector(temp_boot), na.rm = TRUE))
print(sd(as.vector(temp_boot), na.rm = TRUE))
}



ind=demo$Age>=65 & demo$Age <90
ap_corr_psd_rest_age= ap_corr_psd_rest[ind,]
ap_corr_psd_task_age= ap_corr_psd_task[ind,]

fingerprint_boot=matrix(, ncol = 7,nrow=2000)

temp_boot=matrix(, ncol = 2,nrow=1000)

for(i in 1:1000) {
  index_random_par=sample(1:sum(ind), 175)
  
  corr_psd=cor(t(ap_corr_psd_rest_age[index_random_par,]),t(ap_corr_psd_task_age[index_random_par,])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:175)==tt)/175
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:175)==tt)/175
  
}

fingerprint_boot[,1]= as.vector(temp_boot)
write.csv(fingerprint_boot, '/Users/jasondsc/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_aperiodic_corr_fingerprinting_older.csv')

mean(as.vector(temp_boot), na.rm = TRUE)
sd(as.vector(temp_boot), na.rm = TRUE)






index_delta=unlist(lapply(1:68, function(x) ((x-1)*78)+(1:6))) # delta 
index_theta=unlist(lapply(1:68, function(x) ((x-1)*78)+(7:14))) # theta
index_alpha=unlist(lapply(1:68, function(x) ((x-1)*78)+(15:24))) # alpha
index_beta=unlist(lapply(1:68, function(x) ((x-1)*78)+(25:58))) # beta

index_bands=list(index_delta, index_theta, index_alpha,index_beta)

for (j in 1:4){
  temp_boot=matrix(, ncol = 2,nrow=1000)
for(i in 1:1000) {
  index_freq=index_bands[[j]]
  index_random_par=sample(1:sum(ind), 175)
  
  corr_psd=cor(t(ap_corr_psd_rest_age[index_random_par,index_freq]),t(ap_corr_psd_task_age[index_random_par,index_freq])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:175)==tt)/175
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:175)==tt)/175
  
}
  fingerprint_boot[,j+1]= as.vector(temp_boot)
  write.csv(fingerprint_boot, '/Users/jasondsc/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_aperiodic_corr_fingerprinting_older.csv')

print(mean(as.vector(temp_boot), na.rm = TRUE))
print(sd(as.vector(temp_boot), na.rm = TRUE))
}


```







```{r plot effect bootsrap aperiodic corr}

data1=read.csv('/Users/jasondsc/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_aperiodic_corr_fingerprinting_fullcohort.csv')

data1=data1[,-1]
data1=data1[,-c(6,7)]
data4plot= data.frame(mean_differen=apply(data1, 2, mean), lower=apply(data1, 2, quantile, probs=c(0.025,0.975))[1,], upper= apply(data1, 2, quantile, probs=c(0.025,0.975))[2,])

data4plot$band= c("full band", "delta", "theta", "alpha", "beta")
data4plot$group= rep('full cohort',5)

data1=read.csv('/Users/jasondsc/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_aperiodic_corr_fingerprinting_older.csv')

data1=data1[,-1]
data1=data1[,-c(6,7)]
data4plot2= data.frame(mean_differen=apply(data1, 2, mean), lower=apply(data1, 2, quantile, probs=c(0.025,0.975))[1,], upper= apply(data1, 2, quantile, probs=c(0.025,0.975))[2,])

data4plot2$band= c("full band", "delta", "theta", "alpha", "beta")
data4plot2$group= rep('older',5)

data4plot= rbind(data4plot, data4plot2)


data1=read.csv('/Users/jasondsc/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_aperiodic_corr_fingerprinting_adult.csv')

data1=data1[,-1]
data1=data1[,-c(6,7)]
data4plot2= data.frame(mean_differen=apply(data1, 2, mean), lower=apply(data1, 2, quantile, probs=c(0.025,0.975))[1,], upper= apply(data1, 2, quantile, probs=c(0.025,0.975))[2,])

data4plot2$band= c("full band", "delta", "theta", "alpha", "beta")
data4plot2$group= rep('adult',5)

data4plot= rbind(data4plot, data4plot2)


data1=read.csv('/Users/jasondsc/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_aperiodic_corr_fingerprinting_young.csv')

data1=data1[,-1]
data1=data1[,-c(6,7)]
data4plot2= data.frame(mean_differen=apply(data1, 2, mean), lower=apply(data1, 2, quantile, probs=c(0.025,0.975))[1,], upper= apply(data1, 2, quantile, probs=c(0.025,0.975))[2,])

data4plot2$band= c("full band", "delta", "theta", "alpha", "beta")
data4plot2$group= rep('young',5)

data4plot= rbind(data4plot, data4plot2)



data4plot[,c(1,2,3)]= data4plot[,c(1,2,3)]*100

data4plot$band= factor(data4plot$band, levels = c("full band", "delta", "theta", "alpha", "beta"))

data4plot$group= factor(data4plot$group, levels = c("full cohort", "young", "adult", "older"))


ggplot(data=data4plot, aes(x=band, y=mean_differen, fill=group, width=.5)) +  coord_cartesian(ylim=c(0,100))+geom_bar(stat = "identity", position=position_dodge(width = 0.5)) + geom_errorbar(aes(ymin=lower, ymax=upper), width=.2 ,position=position_dodge(.5))  +theme_minimal() + scale_fill_manual(values=cbbPalette) + labs(y="Accuracy (%)", x="",title="") + theme(text = element_text(size=40), legend.title=element_blank())

ggsave('/Users/jasondsc/Documents/CAMCAN_outputs/figures/Fingerprinting_age_aperiodic_corr_bootstrapped.pdf', device = "pdf", width=25, height=4.51, dpi=800)



```





```{r differentiation accuracy plot comaprison }


data1=read.csv('/Users/jasondsc/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_fingerprinting_fullcohort.csv')

data1=data1[,-1]
data4plot= data.frame(mean_differen=apply(data1, 2, mean), lower=apply(data1, 2, quantile, probs=c(0.025,0.975))[1,], upper= apply(data1, 2, quantile, probs=c(0.025,0.975))[2,])

data4plot$band= c("full band", "delta", "theta", "alpha", "beta", "gamma", "high gamma")
data4plot$group= rep('full cohort',7)

data1=read.csv('/Users/jasondsc/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_fingerprinting_older.csv')

data1=data1[,-1]

data4plot2= data.frame(mean_differen=apply(data1, 2, mean), lower=apply(data1, 2, quantile, probs=c(0.025,0.975))[1,], upper= apply(data1, 2, quantile, probs=c(0.025,0.975))[2,])

data4plot2$band= c("full band", "delta", "theta", "alpha", "beta", "gamma", "high gamma")
data4plot2$group= rep('older',7)

data4plot= rbind(data4plot, data4plot2)


data1=read.csv('/Users/jasondsc/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_fingerprinting_adult.csv')

data1=data1[,-1]

data4plot2= data.frame(mean_differen=apply(data1, 2, mean), lower=apply(data1, 2, quantile, probs=c(0.025,0.975))[1,], upper= apply(data1, 2, quantile, probs=c(0.025,0.975))[2,])

data4plot2$band= c("full band", "delta", "theta", "alpha", "beta", "gamma", "high gamma")
data4plot2$group= rep('adult',7)

data4plot= rbind(data4plot, data4plot2)


data1=read.csv('/Users/jasondsc/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_fingerprinting_young.csv')

data1=data1[,-1]

data4plot2= data.frame(mean_differen=apply(data1, 2, mean), lower=apply(data1, 2, quantile, probs=c(0.025,0.975))[1,], upper= apply(data1, 2, quantile, probs=c(0.025,0.975))[2,])

data4plot2$band= c("full band", "delta", "theta", "alpha", "beta", "gamma", "high gamma")
data4plot2$group= rep('young',7)

data4plot= rbind(data4plot, data4plot2)


data4plot[,c(1,2,3)]= data4plot[,c(1,2,3)]*100

data4plot$band= factor(data4plot$band, levels = c("full band", "delta", "theta", "alpha", "beta"))

data4plot$group= factor(data4plot$group, levels = c("full cohort", "young", "adult", "older"))

data4plot1=na.omit(data4plot)



data1=read.csv('/Users/jasondsc/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_aperiodic_corr_fingerprinting_fullcohort.csv')

data1=data1[,-1]
data1=data1[,-c(6,7)]
data4plot= data.frame(mean_differen=apply(data1, 2, mean), lower=apply(data1, 2, quantile, probs=c(0.025,0.975))[1,], upper= apply(data1, 2, quantile, probs=c(0.025,0.975))[2,])

data4plot$band= c("full band", "delta", "theta", "alpha", "beta")
data4plot$group= rep('full cohort',5)

data1=read.csv('/Users/jasondsc/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_aperiodic_corr_fingerprinting_older.csv')

data1=data1[,-1]
data1=data1[,-c(6,7)]
data4plot2= data.frame(mean_differen=apply(data1, 2, mean), lower=apply(data1, 2, quantile, probs=c(0.025,0.975))[1,], upper= apply(data1, 2, quantile, probs=c(0.025,0.975))[2,])

data4plot2$band= c("full band", "delta", "theta", "alpha", "beta")
data4plot2$group= rep('older',5)

data4plot= rbind(data4plot, data4plot2)


data1=read.csv('/Users/jasondsc/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_aperiodic_corr_fingerprinting_adult.csv')

data1=data1[,-1]
data1=data1[,-c(6,7)]
data4plot2= data.frame(mean_differen=apply(data1, 2, mean), lower=apply(data1, 2, quantile, probs=c(0.025,0.975))[1,], upper= apply(data1, 2, quantile, probs=c(0.025,0.975))[2,])

data4plot2$band= c("full band", "delta", "theta", "alpha", "beta")
data4plot2$group= rep('adult',5)

data4plot= rbind(data4plot, data4plot2)


data1=read.csv('/Users/jasondsc/Documents/CAMCAN_outputs/CAMCAN_Analysis/bootstrapped_aperiodic_corr_fingerprinting_young.csv')

data1=data1[,-1]
data1=data1[,-c(6,7)]
data4plot2= data.frame(mean_differen=apply(data1, 2, mean), lower=apply(data1, 2, quantile, probs=c(0.025,0.975))[1,], upper= apply(data1, 2, quantile, probs=c(0.025,0.975))[2,])

data4plot2$band= c("full band", "delta", "theta", "alpha", "beta")
data4plot2$group= rep('young',5)

data4plot= rbind(data4plot, data4plot2)



data4plot[,c(1,2,3)]= data4plot[,c(1,2,3)]*100

data4plot$band= factor(data4plot$band, levels = c("full band", "delta", "theta", "alpha", "beta"))

data4plot$group= factor(data4plot$group, levels = c("full cohort", "young", "adult", "older"))

data4plot2= data4plot1-data4plot

data4plot2[,c(4,5)]=data4plot[,c(4,5)]

ggplot(data=data4plot2, aes(x=band, y=mean_differen, fill=group, width=.5)) +  coord_cartesian(ylim=c(-30,30))+geom_bar(stat = "identity", position=position_dodge(width = 0.5)) + theme_minimal() + scale_fill_manual(values=cbbPalette) + labs(y="Accuracy (%)", x="",title="") + theme(text = element_text(size=40), legend.title=element_blank())

ggsave('/Users/jasondsc/Documents/CAMCAN_outputs/figures/Fingerprinting_age_difference_between_aperiodic_corr_and originial_bootstrapped.pdf', device = "pdf", width=25, height=4.51, dpi=800)



```


```{r Compute ICC effects }

demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]

psd_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_Rest.csv', header = FALSE)
psd_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_Task.csv', header = FALSE)


z_target= t(scale(t(psd_task)))
z_database= t(scale(t(psd_rest)))
icc = c()


n = 606
k = 2
df_b = n-1
df_w = n*(k-1)


for (i_edge in 1:length(psd_rest)){
  x= data.frame(unlist(z_target[,i_edge]),unlist(z_database[,i_edge]) )
  x_w_mean =  rowMeans(x)
  x_g_mean = mean(unlist(x))
  ss_t = sum(((x - x_g_mean)^2))
  ss_w = sum((x - (x_w_mean))^2)
  ss_b = ss_t - ss_w
  ms_b = ss_b / df_b
  ms_w = ss_w / df_w
  icc[i_edge] = (ms_b - ms_w) / (ms_b + ((k-1)*ms_w))
  
  
}

icc_mat <- matrix(icc, nrow = 68, byrow = TRUE)


write.csv(icc_mat, '~/Documents/CAMCAN_outputs/ICC_fullgroup_analysis.csv')



# plot effect 
library(ggseg)
library(ggplot2)
df=read.csv('~/Desktop/Alex_fingerprinting/PSD_ICC_orig_PD_new_PKD2.csv', header = FALSE, stringsAsFactors = FALSE)
colnames(df)[1]='region'
df$hemi =''
df$hemi[seq(2,68,2)] ='right' 
df$hemi[seq(1,67,2)] ='left'

# index_delta=unlist(lapply(1:68, function(x) ((x-1)*300)+(1:8)))
# index_theta=unlist(lapply(1:68, function(x) ((x-1)*300)+(9:16))) # theta
# index_alpha=unlist(lapply(1:68, function(x) ((x-1)*300)+(17:26))) # alpha
# index_beta=unlist(lapply(1:68, function(x) ((x-1)*300)+(27:60))) # beta
# index_gamma=unlist(lapply(1:68, function(x) ((x-1)*300)+(61:101))) # gamma
# index_hgamma=unlist(lapply(1:68, function(x) ((x-1)*300)+(102:300))) # Hgamma

#  look ICC across bands
someData= tidyr::tibble(df$region, rowMeans(icc_mat[,102:300]), df$hemi)
colnames(someData)[2]='ICC'
colnames(someData)[1]='region'
colnames(someData)[3]='hemi'
someData$ICC[someData$ICC<0.4]=0.4
someData$ICC[someData$ICC>0.9]=0.9
someData$band= 'High gamma'
someData2= tidyr::tibble(df$region, rowMeans(icc_mat[,61:101]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Gamma'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_mat[,27:60]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Beta'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_mat[,17:26]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Alpha'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_mat[,9:16]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Theta'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_mat[,1:8]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Delta'
someData=rbind(someData,someData2)

someData$band= ordered(someData$band, levels= c("Delta", "Theta", "Alpha", "Beta", "Gamma", "High gamma"))
someData= someData[!is.na(someData$band),]
someData= na.omit(someData)
ggplot(someData) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ICC)) + viridis::scale_fill_viridis(option = 'viridis',limits=c(0.4, 1 ))+ theme_void() + facet_wrap(~band)

ggsave('~/Documents/CAMCAN_outputs/figures/Fingerprinting_ICC_values_fullcohort.pdf', device = "pdf")


# look at age groups 
ind=demo$Age>18 & demo$Age <45
z_target= t(scale(t(psd_task[ind,])))
z_database= t(scale(t(psd_rest[ind,])))
icc = c()


n = length(ind)
k = 2
df_b = n-1
df_w = n*(k-1)


for (i_edge in 1:length(psd_rest)){
  x= data.frame(unlist(z_target[,i_edge]),unlist(z_database[,i_edge]) )
  x_w_mean =  rowMeans(x)
  x_g_mean = mean(unlist(x))
  ss_t = sum(((x - x_g_mean)^2))
  ss_w = sum((x - (x_w_mean))^2)
  ss_b = ss_t - ss_w
  ms_b = ss_b / df_b
  ms_w = ss_w / df_w
  icc[i_edge] = (ms_b - ms_w) / (ms_b + ((k-1)*ms_w))
  
  
}

icc_mat_young <- matrix(icc, nrow = 68, byrow = TRUE)

write.csv(icc_mat_young, '~/Documents/CAMCAN_outputs/ICC_features_young_adults.csv')

# plot effect 
df=read.csv('~/Documents/Alex_fingerprinting/PSD_ICC_orig_PD_new_PKD2.csv', header = FALSE, stringsAsFactors = FALSE)
colnames(df)[1]='region'
df$hemi =''
df$hemi[seq(2,68,2)] ='right' 
df$hemi[seq(1,67,2)] ='left'


#  look ICC across bands
someData= tidyr::tibble(df$region, rowMeans(icc_mat_young[,102:300]), df$hemi)
colnames(someData)[2]='ICC'
colnames(someData)[1]='region'
colnames(someData)[3]='hemi'
someData$ICC[someData$ICC<0.4]=0.4
someData$ICC[someData$ICC>0.9]=0.9
someData$band= 'High gamma'
someData2= tidyr::tibble(df$region, rowMeans(icc_mat_young[,61:101]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Gamma'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_mat_young[,27:60]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Beta'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_mat_young[,17:26]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Alpha'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_mat_young[,9:16]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Theta'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_mat_young[,1:8]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Delta'
someData=rbind(someData,someData2)

someData$band= ordered(someData$band, levels= c("Delta", "Theta", "Alpha", "Beta", "Gamma", "High gamma"))
someData= someData[!is.na(someData$band),]
someData= na.omit(someData)
ggplot(someData) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ICC)) + viridis::scale_fill_viridis(option = 'viridis',limits=c(0.4, 1 ))+ theme_void() + facet_wrap(~band)

ggsave('~/Documents/CAMCAN_outputs/figures/Fingerprinting_ICC_values_young_adults.pdf', device = "pdf")



# look at age groups 
ind=demo$Age>=45 & demo$Age <65
z_target= t(scale(t(psd_task[ind,])))
z_database= t(scale(t(psd_rest[ind,])))
icc = c()


n = length(ind)
k = 2
df_b = n-1
df_w = n*(k-1)


for (i_edge in 1:length(psd_rest)){
  x= data.frame(unlist(z_target[,i_edge]),unlist(z_database[,i_edge]) )
  x_w_mean =  rowMeans(x)
  x_g_mean = mean(unlist(x))
  ss_t = sum(((x - x_g_mean)^2))
  ss_w = sum((x - (x_w_mean))^2)
  ss_b = ss_t - ss_w
  ms_b = ss_b / df_b
  ms_w = ss_w / df_w
  icc[i_edge] = (ms_b - ms_w) / (ms_b + ((k-1)*ms_w))
  
  
}

icc_mat_adult <- matrix(icc, nrow = 68, byrow = TRUE)

write.csv(icc_mat_adult, '~/Documents/CAMCAN_outputs/ICC_features_adults.csv')

# plot effect 
df=read.csv('~/Documents/Alex_fingerprinting/PSD_ICC_orig_PD_new_PKD2.csv', header = FALSE, stringsAsFactors = FALSE)
colnames(df)[1]='region'
df$hemi =''
df$hemi[seq(2,68,2)] ='right' 
df$hemi[seq(1,67,2)] ='left'


#  look ICC across bands
someData= tidyr::tibble(df$region, rowMeans(icc_mat_adult[,102:300]), df$hemi)
colnames(someData)[2]='ICC'
colnames(someData)[1]='region'
colnames(someData)[3]='hemi'
someData$ICC[someData$ICC<0.4]=0.4
someData$ICC[someData$ICC>0.9]=0.9
someData$band= 'High gamma'
someData2= tidyr::tibble(df$region, rowMeans(icc_mat_adult[,61:101]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Gamma'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_mat_adult[,27:60]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Beta'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_mat_adult[,17:26]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Alpha'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_mat_adult[,9:16]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Theta'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_mat_adult[,1:8]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Delta'
someData=rbind(someData,someData2)

someData$band= ordered(someData$band, levels= c("Delta", "Theta", "Alpha", "Beta", "Gamma", "High gamma"))
someData= someData[!is.na(someData$band),]
someData= na.omit(someData)
ggplot(someData) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ICC)) + viridis::scale_fill_viridis(option = 'viridis',limits=c(0.4, 1 ))+ theme_void() + facet_wrap(~band)

ggsave('~/Documents/CAMCAN_outputs/figures/Fingerprinting_ICC_values_adults.pdf', device = "pdf")




# look at age groups 
ind=demo$Age>=65 & demo$Age <90
z_target= t(scale(t(psd_task[ind,])))
z_database= t(scale(t(psd_rest[ind,])))
icc = c()


n = length(ind)
k = 2
df_b = n-1
df_w = n*(k-1)


for (i_edge in 1:length(psd_rest)){
  x= data.frame(unlist(z_target[,i_edge]),unlist(z_database[,i_edge]) )
  x_w_mean =  rowMeans(x)
  x_g_mean = mean(unlist(x))
  ss_t = sum(((x - x_g_mean)^2))
  ss_w = sum((x - (x_w_mean))^2)
  ss_b = ss_t - ss_w
  ms_b = ss_b / df_b
  ms_w = ss_w / df_w
  icc[i_edge] = (ms_b - ms_w) / (ms_b + ((k-1)*ms_w))
  
  
}

icc_mat_older <- matrix(icc, nrow = 68, byrow = TRUE)
write.csv(icc_mat_older, '~/Documents/CAMCAN_outputs/ICC_features_older_adults.csv')

# plot effect 
df=read.csv('~/Documents/Alex_fingerprinting/PSD_ICC_orig_PD_new_PKD2.csv', header = FALSE, stringsAsFactors = FALSE)
colnames(df)[1]='region'
df$hemi =''
df$hemi[seq(2,68,2)] ='right' 
df$hemi[seq(1,67,2)] ='left'


#  look ICC across bands
someData= tidyr::tibble(df$region, rowMeans(icc_mat_older[,102:300]), df$hemi)
colnames(someData)[2]='ICC'
colnames(someData)[1]='region'
colnames(someData)[3]='hemi'
someData$ICC[someData$ICC<0.4]=0.4
someData$ICC[someData$ICC>0.9]=0.9
someData$band= 'High gamma'
someData2= tidyr::tibble(df$region, rowMeans(icc_mat_older[,61:101]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Gamma'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_mat_older[,27:60]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Beta'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_mat_older[,17:26]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Alpha'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_mat_older[,9:16]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Theta'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_mat_older[,1:8]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Delta'
someData=rbind(someData,someData2)

someData$band= ordered(someData$band, levels= c("Delta", "Theta", "Alpha", "Beta", "Gamma", "High gamma"))
someData= someData[!is.na(someData$band),]
someData= na.omit(someData)
ggplot(someData) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ICC)) + viridis::scale_fill_viridis(option = 'viridis',limits=c(0.4, 1 ))+ theme_void() + facet_wrap(~band)

ggsave('~/Documents/CAMCAN_outputs/figures/Fingerprinting_ICC_values_older.pdf', device = "pdf")







# plot effect 
df=read.csv('~/Documents/Alex_fingerprinting/PSD_ICC_orig_PD_new_PKD2.csv', header = FALSE, stringsAsFactors = FALSE)
colnames(df)[1]='region'
df$hemi =''
df$hemi[seq(2,68,2)] ='right' 
df$hemi[seq(1,67,2)] ='left'

icc_diff= icc_mat_older- icc_mat_young

write.csv(icc_diff, '~/Documents/CAMCAN_outputs/ICC_diff_between_young_and_older_analysis.csv')



#  look ICC across bands
someData= tidyr::tibble(df$region, rowMeans(icc_diff[,102:300]), df$hemi)
colnames(someData)[2]='ICC'
colnames(someData)[1]='region'
colnames(someData)[3]='hemi'
someData$ICC[someData$ICC< -0.3]= -0.3
someData$ICC[someData$ICC>0.3]=0.3
someData$band= 'High gamma'
someData2= tidyr::tibble(df$region, rowMeans(icc_diff[,61:101]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC< -0.3]= -0.3
someData2$ICC[someData2$ICC>0.3]=0.3
someData2$band= 'Gamma'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_diff[,27:60]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC< -0.3]= -0.3
someData2$ICC[someData2$ICC>0.3]=0.3
someData2$band= 'Beta'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_diff[,17:26]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC< -0.3]= -0.3
someData2$ICC[someData2$ICC>0.3]=0.3
someData2$band= 'Alpha'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_diff[,9:16]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC< -0.3]= -0.3
someData2$ICC[someData2$ICC>0.3]=0.3
someData2$band= 'Theta'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_diff[,1:8]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC< -0.3]= -0.3
someData2$ICC[someData2$ICC>0.3]=0.3
someData2$band= 'Delta'
someData=rbind(someData,someData2)

someData$band= ordered(someData$band, levels= c("Delta", "Theta", "Alpha", "Beta", "Gamma", "High gamma"))
someData= someData[!is.na(someData$band),]
someData= na.omit(someData)
ggplot(someData) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ICC)) + #viridis::scale_fill_viridis(option = 'magma',limits=c(-0.3, 0.3 ))
  scale_fill_gradient2(low = "#1C14B4", mid = "#FCF7F4", high = "#079D0A", midpoint = 0.0, limits=c(-0.3, 0.3 )) + facet_wrap(~band)   + theme_void() 

ggsave('~/Documents/CAMCAN_outputs/figures/Fingerprinting_ICC_values_diff_younger_minus_older.pdf', device = "pdf")
```





```{r plot sum ICC and example spectra  }


cbbPalette= c("#4f89e0", "#f5ec6c",'#156605',"#76D7C4","#268236", '#4d3d87','#593d80', '#3b49e3')

demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]

psd_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_Rest.csv', header = FALSE)
psd_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_Task.csv', header = FALSE)

ap_corr_psd_rest= read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/corrspec_Rest.csv', header = FALSE)
ap_corr_psd_task= read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/corrspec_Task.csv', header = FALSE)


ap_corr_psd_task= read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/corrspec_Task.csv', header = FALSE)
ap_corr_psd_rest= read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/corrspec_Rest.csv', header = FALSE)


z_target= t(scale(t(psd_task)))
z_database= t(scale(t(psd_rest)))
icc = c()


n = 606
k = 2
df_b = n-1
df_w = n*(k-1)


for (i_edge in 1:length(psd_rest)){
  x= data.frame(unlist(z_target[,i_edge]),unlist(z_database[,i_edge]) )
  x_w_mean =  rowMeans(x)
  x_g_mean = mean(unlist(x))
  ss_t = sum(((x - x_g_mean)^2))
  ss_w = sum((x - (x_w_mean))^2)
  ss_b = ss_t - ss_w
  ms_b = ss_b / df_b
  ms_w = ss_w / df_w
  icc[i_edge] = (ms_b - ms_w) / (ms_b + ((k-1)*ms_w))
  
  
}

icc_mat <- matrix(icc, nrow = 68, byrow = TRUE)

icc_roi = rowMeans(icc_mat)


# plot effect 
df=read.csv('~/Desktop/Alex_fingerprinting/PSD_ICC_orig_PD_new_PKD2.csv', header = FALSE, stringsAsFactors = FALSE)
colnames(df)[1]='region'
df$hemi =''
df$hemi[seq(2,68,2)] ='right' 
df$hemi[seq(1,67,2)] ='left'

#  look ICC across bands
someData= tidyr::tibble(df$region, icc_roi, df$hemi)
colnames(someData)[2]='ICC'
colnames(someData)[1]='region'
colnames(someData)[3]='hemi'
someData$ICC[someData$ICC< 0.3]= 0.3
someData= na.omit(someData)

ggplot(someData) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ICC)) + viridis::scale_fill_viridis(option = 'viridis',limits=c(0.3, 1 ))+ theme_void() 

ggsave('/Users/jasondsc/Documents/CAMCAN_outputs/figures/Fingerprinting_ICC_values_average_across_allFreqs.pdf', device = "pdf")

# right superior parietal has highest avg ICC

# plot spectra for this region across age groups 

ind=60 # right superior parietal 
index_full=unlist(lapply(ind, function(x) ((x-1)*300)+(1:300))) # delta 
psd_plot= psd_rest[, index_full]

psd_plot = psd_plot[-29, ] # remove subject with very low power (makes SEM look very off)


target_LSP= cbind(demo[-29, ], stack(psd_plot))

target_LSP$ind = plyr::mapvalues(target_LSP$ind , unique(target_LSP$ind ), seq(0,149.5,1/2))

target_LSP$ind= as.numeric(as.character(target_LSP$ind))

data4plot= target_LSP %>% group_by(ind) %>% summarise( power= mean(log(values)), SEM= (sd(log(values))/sqrt(n())))

ggplot(data4plot, aes(x= ind, y = power, ymin=power-SEM, ymax=power+SEM)) + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + ggpubr::theme_classic2() + xlim(1,150)

ggplot(data4plot, aes(x= ind, y = power, ymin=power-SEM, ymax=power+SEM)) + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + ggpubr::theme_classic2() + xlim(1,49)


target_LSP$Group= target_LSP$Age > 18 & target_LSP$Age <45
target_LSP$Group[target_LSP$Age >= 45 & target_LSP$Age <65] =2
target_LSP$Group[target_LSP$Age >= 65 & target_LSP$Age <90] =3
target_LSP$Group= plyr::mapvalues(target_LSP$Group, c(1,2,3), c('young adults', 'adults', 'older adults'))
target_LSP$Group= factor(target_LSP$Group, levels= c('young adults', 'adults', 'older adults'))

data4plot= target_LSP %>% group_by(Group, ind) %>% summarise( power= mean(log(values)), SEM= (sd(log(values))/sqrt(n())))
data4plot= data4plot[!is.na(data4plot$Group),]

ggplot(data4plot, aes(x= ind, y = power, fill= Group,colour= Group, ymin=power-SEM, ymax=power+SEM)) + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + ggpubr::theme_classic2() + xlim(1,150) + scale_color_manual(values=cbbPalette[c(4,1,2)]) + scale_fill_manual(values=cbbPalette[c(4,1,2)]) 

ggsave('/Users/jasondsc/Documents/CAMCAN_outputs/figures/Fingerprinting_example_spectra_right_superior_parietal.pdf', device = "pdf")


ggplot(data4plot, aes(x= ind, y = power, fill= Group,colour= Group, ymin=power-SEM, ymax=power+SEM)) + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + ggpubr::theme_classic2() + xlim(1,40) + ylim(-2.5,2.5) + scale_color_manual(values=cbbPalette[c(4,1,2)]) + scale_fill_manual(values=cbbPalette[c(4,1,2)]) 


ggsave('/Users/jasondsc/Documents/CAMCAN_outputs/figures/Fingerprinting_example_spectra_right_superior_parietal_restricted_range.pdf', device = "pdf")



# try the same with aperiodic corrected spectra 


ind=60 # right superior parietal 
index_full=unlist(lapply(ind, function(x) ((x-1)*78)+(1:78))) # delta 
psd_plot= ap_corr_psd_rest[, index_full]

psd_plot = psd_plot[-29, ] # remove subject with very low power (makes SEM look very off)
# index_delta=unlist(lapply(1:68, function(x) ((x-1)*78)+(1:6))) # delta 

target_LSP= cbind(demo[-29, ], stack(psd_plot))

target_LSP$ind = plyr::mapvalues(target_LSP$ind , unique(target_LSP$ind ), seq(1,39.5,1/2))

target_LSP$ind= as.numeric(as.character(target_LSP$ind))


target_LSP$Group= target_LSP$Age > 18 & target_LSP$Age <45
target_LSP$Group[target_LSP$Age >= 45 & target_LSP$Age <65] =2
target_LSP$Group[target_LSP$Age >= 65 & target_LSP$Age <90] =3
target_LSP$Group= plyr::mapvalues(target_LSP$Group, c(1,2,3), c('young adults', 'adults', 'older adults'))
target_LSP$Group= factor(target_LSP$Group, levels= c('young adults', 'adults', 'older adults'))

data4plot= target_LSP %>% group_by(Group, ind) %>% summarise( power= mean((values)), SEM= (sd((values))/sqrt(n())))
data4plot= data4plot[!is.na(data4plot$Group),]

ggplot(data4plot, aes(x= ind, y = power, fill= Group,colour= Group, ymin=power-SEM, ymax=power+SEM)) + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + ggpubr::theme_classic2() + xlim(1,40) + scale_color_manual(values=cbbPalette[c(4,1,2)]) + scale_fill_manual(values=cbbPalette[c(4,1,2)]) 

ggsave('/Users/jasondsc/Documents/CAMCAN_outputs/figures/Fingerprinting_example_aperiodic_corr_spectra_right_superior_parietal.pdf', device = "pdf")





# plot effect 
df=read.csv('~/Desktop/Alex_fingerprinting/PSD_ICC_orig_PD_new_PKD2.csv', header = FALSE, stringsAsFactors = FALSE)
colnames(df)[1]='region'
df$hemi =''
df$hemi[seq(2,68,2)] ='right' 
df$hemi[seq(1,67,2)] ='left'


#  look ICC across bands
someData= tidyr::tibble(df$region, rep(0,68), df$hemi)

colnames(someData)[2]='ICC'
colnames(someData)[1]='region'
colnames(someData)[3]='hemi'
someData$ICC[60]=0.5
someData$ICC[!(1:68 %in% 60)]= NA

ggplot(someData) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ICC)) + viridis::scale_fill_viridis(option = 'magma',limits=c(0, 1 ))+ theme_void() 

ggsave('/Users/jasondsc/Documents/CAMCAN_outputs/figures/example_ROI_right_sperior_parietal.pdf', device = "pdf")



```




``` {r compute corr between ICC and neuromaps}

demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]

psd_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_Rest.csv', header = FALSE)
psd_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_Task.csv', header = FALSE)

neuromaps= read.csv('~/Desktop/Alex_fingerprinting/neuromaps/receptor_data_scale033_full.csv')


z_target= t(scale(t(psd_task)))
z_database= t(scale(t(psd_rest)))
icc = c()


n = 603
k = 2
df_b = n-1
df_w = n*(k-1)


for (i_edge in 1:length(psd_rest)){
  x= data.frame(unlist(z_target[,i_edge]),unlist(z_database[,i_edge]) )
  x_w_mean =  rowMeans(x)
  x_g_mean = mean(unlist(x))
  ss_t = sum(((x - x_g_mean)^2))
  ss_w = sum((x - (x_w_mean))^2)
  ss_b = ss_t - ss_w
  ms_b = ss_b / df_b
  ms_w = ss_w / df_w
  icc[i_edge] = (ms_b - ms_w) / (ms_b + ((k-1)*ms_w))
  
  
}

icc_mat <- matrix(icc, nrow = 68, byrow = TRUE)



# Define X and Y data
X=data.frame(delta= rowMeans(icc_mat[,1:8]),theta= rowMeans(icc_mat[,9:16]),alpha= rowMeans(icc_mat[,17:26]),beta= rowMeans(icc_mat[,27:60]), gamma= rowMeans(icc_mat[,61:101]), hgamma= rowMeans(icc_mat[,102:300]))
Y = neuromaps[,7:30]


corr_mat=corrplot::cor.mtest(cbind(X,Y))
r_matrix=cor(cbind(X,Y))
r_matrix=r_matrix[1:6,7:30]
p_val=corr_mat$p
p_val=p_val[1:6,7:30]
p_corrected=matrix(p.adjust(p_val, 'fdr'), nrow = 6)
p_corrected_bin=p_corrected <0.05
colnames(p_corrected_bin)= colnames(r_matrix)
rownames(p_corrected_bin)= rownames(r_matrix)

Y= scale(Y)
X= scale(X)
# Fit Canonical Correlation Analysis using built-in cancor function

```


```{r short fingerprinting within session}


cbbPalette= c("#4f89e0", "#d81b99",'#156605',"#76D7C4","#268236", '#4d3d87','#593d80', '#3b49e3')


demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]

permutation <- expand.grid(c(1:9), c(1:9))
permutation=permutation[!duplicated(apply(permutation,1,function(x) paste(sort(x),collapse=''))),]
permutation=permutation[!apply(permutation,1, duplicated)[2,],]

for (k in 1:36){
  
dif=permutation[k,1]-permutation[k,2]
  
seg1= read.csv(paste('~/Documents/CAMCAN_outputs/short_seg/short_segment_', as.character(permutation[k,2]), '.csv', sep = ''), header = FALSE)
seg2= read.csv(paste('~/Documents/CAMCAN_outputs/short_seg/short_segment_', as.character(permutation[k,1]), '.csv', sep = ''), header = FALSE)

corr_psd=cor(t(seg1),t(seg2)) 
demo$psd_self_corr=diag(corr_psd)
demo$psd_identifiability=diag(apply(corr_psd, 2, scale))

fingerprint=matrix(, ncol = 3,nrow=4)

print("psd fingerprinting:")
tt=apply(corr_psd, 1, which.max)
fingerprint[1,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[1,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,]),t(seg2[ind,])) 
print("psd fingerprinting young adults:")
tt=apply(corr_psd, 1, which.max)
fingerprint[2,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[2,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,]),t(seg2[ind,])) 
print("psd fingerprinting adults:")
tt=apply(corr_psd, 1, which.max)
fingerprint[3,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[3,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,]),t(seg2[ind,])) 
print("psd fingerprinting older adults:")
tt=apply(corr_psd, 1, which.max)
fingerprint[4,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[4,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint=as.data.frame(fingerprint)

fingerprint[,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[,4]=c("full band", "full band", "full band", "full band")

colnames(fingerprint) = c("acc1", "acc2", "age_group", "band")

# delta 
index_delta=unlist(lapply(1:68, function(x) ((x-1)*300)+(1:8)))
index_theta=unlist(lapply(1:68, function(x) ((x-1)*300)+(9:16))) # theta
index_alpha=unlist(lapply(1:68, function(x) ((x-1)*300)+(17:26))) # alpha
index_beta=unlist(lapply(1:68, function(x) ((x-1)*300)+(27:60))) # beta
index_gamma=unlist(lapply(1:68, function(x) ((x-1)*300)+(61:101))) # gamma
index_hgamma=unlist(lapply(1:68, function(x) ((x-1)*300)+(102:300))) # Hgamma

corr_psd=cor(t(seg1[,index_delta]),t(seg2[,index_delta])) 

print("psd fingerprinting delta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[5,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[5,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_delta]),t(seg2[ind,index_delta])) 
print("psd fingerprinting young adults delta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[6,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[6,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_delta]),t(seg2[ind,index_delta])) 
print("psd fingerprinting adults delta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[7,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[7,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_delta]),t(seg2[ind,index_delta])) 
print("psd fingerprinting older adults delta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[8,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[8,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint[5:8,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[5:8,4]=c("delta", "delta", "delta", "delta")


# theta
corr_psd=cor(t(seg1[,index_theta]),t(seg2[,index_theta])) 

print("psd fingerprinting theta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[9,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[9,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_theta]),t(seg2[ind,index_theta])) 
print("psd fingerprinting young adults theta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[10,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[10,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_theta]),t(seg2[ind,index_theta])) 
print("psd fingerprinting adults theta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[11,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[11,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_theta]),t(seg2[ind,index_theta])) 
print("psd fingerprinting older adults theta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[12,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[12,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint[9:12,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[9:12,4]=c("theta", "theta", "theta", "theta")


# alpha
corr_psd=cor(t(seg1[,index_alpha]),t(seg2[,index_alpha])) 

print("psd fingerprinting alpha:")
tt=apply(corr_psd, 1, which.max)
fingerprint[13,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[13,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_alpha]),t(seg2[ind,index_alpha])) 
print("psd fingerprinting young adults alpha:")
tt=apply(corr_psd, 1, which.max)
fingerprint[14,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[14,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_alpha]),t(seg2[ind,index_alpha])) 
print("psd fingerprinting adults alpha:")
tt=apply(corr_psd, 1, which.max)
fingerprint[15,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[15,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_alpha]),t(seg2[ind,index_alpha])) 
print("psd fingerprinting older adults alpha:")
tt=apply(corr_psd, 1, which.max)
fingerprint[16,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[16,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint[13:16,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[13:16,4]=c("alpha", "alpha", "alpha", "alpha")


# beta
corr_psd=cor(t(seg1[,index_beta]),t(seg2[,index_beta])) 

print("psd fingerprinting beta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[17,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[17,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_beta]),t(seg2[ind,index_beta])) 
print("psd fingerprinting young adults beta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[18,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[18,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_beta]),t(seg2[ind,index_beta])) 
print("psd fingerprinting adults beta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[19,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[19,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_beta]),t(seg2[ind,index_beta])) 
print("psd fingerprinting older adults beta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[20,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[20,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint[17:20,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[17:20,4]=c("beta", "beta", "beta", "beta")


# gamma
corr_psd=cor(t(seg1[,index_gamma]),t(seg2[,index_gamma])) 

print("psd fingerprinting gamma:")
tt=apply(corr_psd, 1, which.max)
fingerprint[21,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[21,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_gamma]),t(seg2[ind,index_gamma])) 
print("psd fingerprinting young adults gamma:")
tt=apply(corr_psd, 1, which.max)
fingerprint[22,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[22,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_gamma]),t(seg2[ind,index_gamma])) 
print("psd fingerprinting adults gamma:")
tt=apply(corr_psd, 1, which.max)
fingerprint[23,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[23,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_gamma]),t(seg2[ind,index_gamma])) 
print("psd fingerprinting older adults gamma:")
tt=apply(corr_psd, 1, which.max)
fingerprint[24,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[24,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint[21:24,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[21:24,4]=c("gamma", "gamma", "gamma", "gamma")


corr_psd=cor(t(seg1[,index_hgamma]),t(seg2[,index_hgamma])) 

print("psd fingerprinting gamma:")
tt=apply(corr_psd, 1, which.max)
fingerprint[25,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[25,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_hgamma]),t(seg2[ind,index_hgamma])) 
print("psd fingerprinting young adults H gamma:")
tt=apply(corr_psd, 1, which.max)
fingerprint[26,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[26,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_hgamma]),t(seg2[ind,index_hgamma])) 
print("psd fingerprinting adults H gamma:")
tt=apply(corr_psd, 1, which.max)
fingerprint[27,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[27,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_hgamma]),t(seg2[ind,index_hgamma])) 
print("psd fingerprinting older adults Hgamma:")
tt=apply(corr_psd, 1, which.max)
fingerprint[28,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[28,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint[25:28,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[25:28,4]=c("high gamma", "high gamma", "high gamma", "high gamma")


# break up into three (roughly equal) age groups
# young adults (18-45)


fingerprint$ACC= rowMeans(fingerprint[,1:2])*100

fingerprint$age_group = ordered(fingerprint$age_group, levels= c("full dataset", "younger adults", "adults", "older adults"))

fingerprint$band = ordered(fingerprint$band, levels= c("full band", "delta", "theta", "alpha", "beta", "gamma", "high gamma", "aperiodic"))

fingerprint$dist=dif 

write.table(fingerprint, file = '~/Documents/CAMCAN_outputs/short_fingerprinting_table2.csv', append = TRUE, quote = FALSE, sep = ',', row.names = FALSE, col.names = FALSE)
print(k)
}

```



```{r short fingerprinting within session}


cbbPalette= c("#4f89e0", "#d81b99",'#156605',"#76D7C4","#268236", '#4d3d87','#593d80', '#3b49e3')


demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]

permutation <- expand.grid(c(1:8), c(1:8))
permutation=permutation[!duplicated(apply(permutation,1,function(x) paste(sort(x),collapse=''))),]
permutation=permutation[!apply(permutation,1, duplicated)[2,],]

for (k in 1:28){
  
dif=permutation[k,1]-permutation[k,2]
  
seg1= read.csv(paste('~/Documents/CAMCAN_outputs/short_seg_task/short_segment_', as.character(permutation[k,2]), '.csv', sep = ''), header = FALSE)
seg2= read.csv(paste('~/Documents/CAMCAN_outputs/short_seg_task/short_segment_', as.character(permutation[k,1]), '.csv', sep = ''), header = FALSE)

corr_psd=cor(t(seg1),t(seg2)) 
demo$psd_self_corr=diag(corr_psd)
demo$psd_identifiability=diag(apply(corr_psd, 2, scale))

fingerprint=matrix(, ncol = 3,nrow=4)

print("psd fingerprinting:")
tt=apply(corr_psd, 1, which.max)
fingerprint[1,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[1,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,]),t(seg2[ind,])) 
print("psd fingerprinting young adults:")
tt=apply(corr_psd, 1, which.max)
fingerprint[2,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[2,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,]),t(seg2[ind,])) 
print("psd fingerprinting adults:")
tt=apply(corr_psd, 1, which.max)
fingerprint[3,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[3,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,]),t(seg2[ind,])) 
print("psd fingerprinting older adults:")
tt=apply(corr_psd, 1, which.max)
fingerprint[4,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[4,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint=as.data.frame(fingerprint)

fingerprint[,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[,4]=c("full band", "full band", "full band", "full band")

colnames(fingerprint) = c("acc1", "acc2", "age_group", "band")

# delta 
index_delta=unlist(lapply(1:68, function(x) ((x-1)*300)+(1:8)))
index_theta=unlist(lapply(1:68, function(x) ((x-1)*300)+(9:16))) # theta
index_alpha=unlist(lapply(1:68, function(x) ((x-1)*300)+(17:26))) # alpha
index_beta=unlist(lapply(1:68, function(x) ((x-1)*300)+(27:60))) # beta
index_gamma=unlist(lapply(1:68, function(x) ((x-1)*300)+(61:101))) # gamma
index_hgamma=unlist(lapply(1:68, function(x) ((x-1)*300)+(102:300))) # Hgamma

corr_psd=cor(t(seg1[,index_delta]),t(seg2[,index_delta])) 

print("psd fingerprinting delta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[5,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[5,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_delta]),t(seg2[ind,index_delta])) 
print("psd fingerprinting young adults delta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[6,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[6,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_delta]),t(seg2[ind,index_delta])) 
print("psd fingerprinting adults delta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[7,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[7,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_delta]),t(seg2[ind,index_delta])) 
print("psd fingerprinting older adults delta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[8,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[8,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint[5:8,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[5:8,4]=c("delta", "delta", "delta", "delta")


# theta
corr_psd=cor(t(seg1[,index_theta]),t(seg2[,index_theta])) 

print("psd fingerprinting theta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[9,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[9,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_theta]),t(seg2[ind,index_theta])) 
print("psd fingerprinting young adults theta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[10,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[10,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_theta]),t(seg2[ind,index_theta])) 
print("psd fingerprinting adults theta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[11,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[11,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_theta]),t(seg2[ind,index_theta])) 
print("psd fingerprinting older adults theta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[12,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[12,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint[9:12,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[9:12,4]=c("theta", "theta", "theta", "theta")


# alpha
corr_psd=cor(t(seg1[,index_alpha]),t(seg2[,index_alpha])) 

print("psd fingerprinting alpha:")
tt=apply(corr_psd, 1, which.max)
fingerprint[13,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[13,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_alpha]),t(seg2[ind,index_alpha])) 
print("psd fingerprinting young adults alpha:")
tt=apply(corr_psd, 1, which.max)
fingerprint[14,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[14,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_alpha]),t(seg2[ind,index_alpha])) 
print("psd fingerprinting adults alpha:")
tt=apply(corr_psd, 1, which.max)
fingerprint[15,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[15,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_alpha]),t(seg2[ind,index_alpha])) 
print("psd fingerprinting older adults alpha:")
tt=apply(corr_psd, 1, which.max)
fingerprint[16,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[16,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint[13:16,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[13:16,4]=c("alpha", "alpha", "alpha", "alpha")


# beta
corr_psd=cor(t(seg1[,index_beta]),t(seg2[,index_beta])) 

print("psd fingerprinting beta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[17,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[17,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_beta]),t(seg2[ind,index_beta])) 
print("psd fingerprinting young adults beta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[18,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[18,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_beta]),t(seg2[ind,index_beta])) 
print("psd fingerprinting adults beta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[19,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[19,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_beta]),t(seg2[ind,index_beta])) 
print("psd fingerprinting older adults beta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[20,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[20,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint[17:20,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[17:20,4]=c("beta", "beta", "beta", "beta")


# gamma
corr_psd=cor(t(seg1[,index_gamma]),t(seg2[,index_gamma])) 

print("psd fingerprinting gamma:")
tt=apply(corr_psd, 1, which.max)
fingerprint[21,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[21,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_gamma]),t(seg2[ind,index_gamma])) 
print("psd fingerprinting young adults gamma:")
tt=apply(corr_psd, 1, which.max)
fingerprint[22,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[22,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_gamma]),t(seg2[ind,index_gamma])) 
print("psd fingerprinting adults gamma:")
tt=apply(corr_psd, 1, which.max)
fingerprint[23,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[23,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_gamma]),t(seg2[ind,index_gamma])) 
print("psd fingerprinting older adults gamma:")
tt=apply(corr_psd, 1, which.max)
fingerprint[24,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[24,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint[21:24,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[21:24,4]=c("gamma", "gamma", "gamma", "gamma")


corr_psd=cor(t(seg1[,index_hgamma]),t(seg2[,index_hgamma])) 

print("psd fingerprinting gamma:")
tt=apply(corr_psd, 1, which.max)
fingerprint[25,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[25,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_hgamma]),t(seg2[ind,index_hgamma])) 
print("psd fingerprinting young adults H gamma:")
tt=apply(corr_psd, 1, which.max)
fingerprint[26,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[26,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_hgamma]),t(seg2[ind,index_hgamma])) 
print("psd fingerprinting adults H gamma:")
tt=apply(corr_psd, 1, which.max)
fingerprint[27,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[27,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_hgamma]),t(seg2[ind,index_hgamma])) 
print("psd fingerprinting older adults Hgamma:")
tt=apply(corr_psd, 1, which.max)
fingerprint[28,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[28,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint[25:28,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[25:28,4]=c("high gamma", "high gamma", "high gamma", "high gamma")


# break up into three (roughly equal) age groups
# young adults (18-45)


fingerprint$ACC= rowMeans(fingerprint[,1:2])*100

fingerprint$age_group = ordered(fingerprint$age_group, levels= c("full dataset", "younger adults", "adults", "older adults"))

fingerprint$band = ordered(fingerprint$band, levels= c("full band", "delta", "theta", "alpha", "beta", "gamma", "high gamma", "aperiodic"))

fingerprint$dist=dif 

write.table(fingerprint, file = '~/Documents/CAMCAN_outputs/short_fingerprinting_table_within_task2.csv', append = TRUE, quote = FALSE, sep = ',', row.names = FALSE, col.names = FALSE)
print(k)
}

```




```{r short fingerprinting across session}


cbbPalette= c("#4f89e0", "#d81b99",'#156605',"#76D7C4","#268236", '#4d3d87','#593d80', '#3b49e3')


demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]

permutation <- expand.grid(c(1:8), c(1:8))


for (k in 1:64){
  
dif=permutation[k,1]-permutation[k,2]
  
seg1= read.csv(paste('~/Documents/CAMCAN_outputs/short_seg/short_segment_', as.character(permutation[k,2]), '.csv', sep = ''), header = FALSE)
seg2= read.csv(paste('~/Documents/CAMCAN_outputs/short_seg_task/short_segment_', as.character(permutation[k,1]), '.csv', sep = ''), header = FALSE)

corr_psd=cor(t(seg1),t(seg2)) 
demo$psd_self_corr=diag(corr_psd)
demo$psd_identifiability=diag(apply(corr_psd, 2, scale))

fingerprint=matrix(, ncol = 3,nrow=4)

print("psd fingerprinting:")
tt=apply(corr_psd, 1, which.max)
fingerprint[1,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[1,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,]),t(seg2[ind,])) 
print("psd fingerprinting young adults:")
tt=apply(corr_psd, 1, which.max)
fingerprint[2,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[2,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,]),t(seg2[ind,])) 
print("psd fingerprinting adults:")
tt=apply(corr_psd, 1, which.max)
fingerprint[3,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[3,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,]),t(seg2[ind,])) 
print("psd fingerprinting older adults:")
tt=apply(corr_psd, 1, which.max)
fingerprint[4,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[4,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint=as.data.frame(fingerprint)

fingerprint[,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[,4]=c("full band", "full band", "full band", "full band")

colnames(fingerprint) = c("acc1", "acc2", "age_group", "band")

# delta 
index_delta=unlist(lapply(1:68, function(x) ((x-1)*300)+(1:8)))
index_theta=unlist(lapply(1:68, function(x) ((x-1)*300)+(9:16))) # theta
index_alpha=unlist(lapply(1:68, function(x) ((x-1)*300)+(17:26))) # alpha
index_beta=unlist(lapply(1:68, function(x) ((x-1)*300)+(27:60))) # beta
index_gamma=unlist(lapply(1:68, function(x) ((x-1)*300)+(61:101))) # gamma
index_hgamma=unlist(lapply(1:68, function(x) ((x-1)*300)+(102:300))) # Hgamma

corr_psd=cor(t(seg1[,index_delta]),t(seg2[,index_delta])) 

print("psd fingerprinting delta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[5,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[5,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_delta]),t(seg2[ind,index_delta])) 
print("psd fingerprinting young adults delta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[6,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[6,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_delta]),t(seg2[ind,index_delta])) 
print("psd fingerprinting adults delta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[7,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[7,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_delta]),t(seg2[ind,index_delta])) 
print("psd fingerprinting older adults delta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[8,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[8,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint[5:8,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[5:8,4]=c("delta", "delta", "delta", "delta")


# theta
corr_psd=cor(t(seg1[,index_theta]),t(seg2[,index_theta])) 

print("psd fingerprinting theta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[9,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[9,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_theta]),t(seg2[ind,index_theta])) 
print("psd fingerprinting young adults theta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[10,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[10,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_theta]),t(seg2[ind,index_theta])) 
print("psd fingerprinting adults theta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[11,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[11,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_theta]),t(seg2[ind,index_theta])) 
print("psd fingerprinting older adults theta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[12,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[12,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint[9:12,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[9:12,4]=c("theta", "theta", "theta", "theta")


# alpha
corr_psd=cor(t(seg1[,index_alpha]),t(seg2[,index_alpha])) 

print("psd fingerprinting alpha:")
tt=apply(corr_psd, 1, which.max)
fingerprint[13,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[13,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_alpha]),t(seg2[ind,index_alpha])) 
print("psd fingerprinting young adults alpha:")
tt=apply(corr_psd, 1, which.max)
fingerprint[14,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[14,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_alpha]),t(seg2[ind,index_alpha])) 
print("psd fingerprinting adults alpha:")
tt=apply(corr_psd, 1, which.max)
fingerprint[15,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[15,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_alpha]),t(seg2[ind,index_alpha])) 
print("psd fingerprinting older adults alpha:")
tt=apply(corr_psd, 1, which.max)
fingerprint[16,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[16,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint[13:16,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[13:16,4]=c("alpha", "alpha", "alpha", "alpha")


# beta
corr_psd=cor(t(seg1[,index_beta]),t(seg2[,index_beta])) 

print("psd fingerprinting beta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[17,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[17,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_beta]),t(seg2[ind,index_beta])) 
print("psd fingerprinting young adults beta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[18,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[18,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_beta]),t(seg2[ind,index_beta])) 
print("psd fingerprinting adults beta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[19,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[19,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_beta]),t(seg2[ind,index_beta])) 
print("psd fingerprinting older adults beta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[20,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[20,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint[17:20,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[17:20,4]=c("beta", "beta", "beta", "beta")


# gamma
corr_psd=cor(t(seg1[,index_gamma]),t(seg2[,index_gamma])) 

print("psd fingerprinting gamma:")
tt=apply(corr_psd, 1, which.max)
fingerprint[21,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[21,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_gamma]),t(seg2[ind,index_gamma])) 
print("psd fingerprinting young adults gamma:")
tt=apply(corr_psd, 1, which.max)
fingerprint[22,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[22,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_gamma]),t(seg2[ind,index_gamma])) 
print("psd fingerprinting adults gamma:")
tt=apply(corr_psd, 1, which.max)
fingerprint[23,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[23,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_gamma]),t(seg2[ind,index_gamma])) 
print("psd fingerprinting older adults gamma:")
tt=apply(corr_psd, 1, which.max)
fingerprint[24,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[24,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint[21:24,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[21:24,4]=c("gamma", "gamma", "gamma", "gamma")


corr_psd=cor(t(seg1[,index_hgamma]),t(seg2[,index_hgamma])) 

print("psd fingerprinting gamma:")
tt=apply(corr_psd, 1, which.max)
fingerprint[25,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[25,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_hgamma]),t(seg2[ind,index_hgamma])) 
print("psd fingerprinting young adults H gamma:")
tt=apply(corr_psd, 1, which.max)
fingerprint[26,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[26,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_hgamma]),t(seg2[ind,index_hgamma])) 
print("psd fingerprinting adults H gamma:")
tt=apply(corr_psd, 1, which.max)
fingerprint[27,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[27,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_hgamma]),t(seg2[ind,index_hgamma])) 
print("psd fingerprinting older adults Hgamma:")
tt=apply(corr_psd, 1, which.max)
fingerprint[28,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[28,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint[25:28,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[25:28,4]=c("high gamma", "high gamma", "high gamma", "high gamma")


# break up into three (roughly equal) age groups
# young adults (18-45)


fingerprint$ACC= rowMeans(fingerprint[,1:2])*100

fingerprint$age_group = ordered(fingerprint$age_group, levels= c("full dataset", "younger adults", "adults", "older adults"))

fingerprint$band = ordered(fingerprint$band, levels= c("full band", "delta", "theta", "alpha", "beta", "gamma", "high gamma", "aperiodic"))

fingerprint$dist=dif 

write.table(fingerprint, file = '~/Documents/CAMCAN_outputs/short_fingerprinting_table_across_task2.csv', append = TRUE, quote = FALSE, sep = ',', row.names = FALSE, col.names = FALSE)
print(k)
}

```


``` {r plot short differentiation effect}

# set colour palette
cbbPalette= c("#DBF132", "#15A705",'#4F89E0',"#D81B99","#268236", '#4d3d87','#593d80', '#3b49e3')


df=read.csv("~/Documents/CAMCAN_outputs/short_fingerprinting_table2.csv", header = TRUE, stringsAsFactors = FALSE)
df$band= factor(df$band,levels = c("full band", "delta", "theta", "alpha", "beta", "gamma", "high gamma"))
df$band=plyr::mapvalues(df$band, unique(df$band), c( "broadband","delta", "theta", "alpha", "beta", "gamma", "high\ngamma"))

df$age_group= factor(df$age_group,levels = c("full dataset", "younger adults","adults", 'older adults'))
df$age_group=plyr::mapvalues(df$age_group, unique(df$age_group), c( "full cohort","young adult", "adult", "older adult"))
df$dataset_distance=df$dist

data_plot=df[df$band== 'broadband',]
dodge <- position_dodge(width = 0.9)
ggplot(data=data_plot, aes(x=band, y=ACC,fill=age_group, colour=age_group, width=.5)) +  geom_jitter(position= position_jitterdodge(jitter.width=0.2, dodge.width=0.9), size=4, alpha =0.7 ) + stat_summary(fun.data = mean_se, geom = "errorbar", size=2.5, width=0.0, position = dodge, colour='#B7BBBE')  + ylim( c(0,100)) +
  stat_summary(fun.data = "mean_cl_boot", geom = "point", size= 7, position = dodge)  +theme_classic() + labs(y="differentiation accuracy (%)", x="",title="") +  theme(text = element_text(size=40), legend.title=element_blank()) + scale_color_manual(values=cbbPalette) 

ggsave('~/Documents/CAMCAN_outputs/figures/JUSTREST_SHORT_within_restingstate_broadband.pdf', device = "pdf", width=8, height=8, dpi=800)


data_plot=df[df$band== 'broadband',]
data_plot= data_plot[data_plot$dataset_distance !=8,]
ggplot(data=data_plot, aes(x=dataset_distance, y=ACC, colour=age_group, width=.5)) + stat_summary(fun.data = mean_se, geom = "errorbar", size=2.5, width=0.0) + geom_smooth(method = "lm",aes(fill = age_group), size=2) + stat_summary(fun.data = "mean_cl_boot", geom = "point", size= 7,)  +theme_classic() + labs(y="differentiation accuracy (%)", x="",title="") +  theme(text = element_text(size=40), legend.title=element_blank()) + scale_color_manual(values=cbbPalette) + scale_fill_manual(values=cbbPalette) 

ggsave('~/Documents/CAMCAN_outputs/figures/JUSTREST_SHORT_within_restingstate_lineardecay.pdf', device = "pdf", width=8, height=8, dpi=800)


data_plot=df[df$band== 'broadband',]
data_plot= data_plot[data_plot$dataset_distance !=8,]
data_plot=data_plot[data_plot$age_group!="full cohort",]
ggplot(data=data_plot, aes(x=dataset_distance, y=ACC, colour=age_group, width=.5)) + stat_summary(fun.data = mean_se, geom = "errorbar", size=2.5, width=0.0) + geom_smooth(method = "lm",aes(fill = age_group), size=2) + stat_summary(fun.data = "mean_cl_boot", geom = "point", size= 7,)  +theme_classic() + labs(y="differentiation accuracy (%)", x="",title="") +  theme(text = element_text(size=40), legend.position = 'none', legend.title=element_blank()) + scale_color_manual(values=cbbPalette[2:5]) + scale_fill_manual(values=cbbPalette[2:5]) 

ggsave('~/Documents/CAMCAN_outputs/figures/JUSTREST_SHORT_within_restingstate_lineardecay_nofull.pdf', device = "pdf", width=8, height=8, dpi=800)

df=df[df$band== 'broadband',]
df=df[df$dataset_distance != 8,]
data4reg= df[df$age_group != 'full cohort',]

lm0=lm(ACC ~ 1, data4reg)
lm2=lm(ACC ~ 1 + dataset_distance , data4reg)
lm3=lm(ACC ~ 1 + dataset_distance  + age_group, data4reg)
lm4=lm(ACC ~ 1 + dataset_distance  + age_group +age_group*dataset_distance, data4reg)

anova(lm0, lm2,lm3, lm4)
summary(lm4)
sjPlot::tab_model(lm4)

bf = generalTestBF(ACC ~ 1 + dataset_distance + age_group +age_group:dataset_distance, data4reg, whichModels = "top")
summary(bf)



df=read.csv("~/Documents/CAMCAN_outputs/short_fingerprinting_table_within_task2.csv", header = TRUE, stringsAsFactors = FALSE)
df$band= factor(df$band,levels = c("full band", "delta", "theta", "alpha", "beta", "gamma", "high gamma"))
df$band=plyr::mapvalues(df$band, unique(df$band), c( "broadband","delta", "theta", "alpha", "beta", "gamma", "high\ngamma"))

df$age_group= factor(df$age_group,levels = c("full dataset", "younger adults","adults", 'older adults'))
df$age_group=plyr::mapvalues(df$age_group, unique(df$age_group), c( "full cohort","young adult", "adult", "older adult"))
df$dataset_distance=df$dist

data_plot=df
dodge <- position_dodge(width = 0.9)
ggplot(data=data_plot, aes(x=band, y=ACC,fill=age_group, colour=age_group, width=.5)) +  geom_jitter(position= position_jitterdodge(jitter.width=0.2, dodge.width=0.9), size=4, alpha =0.7 ) + stat_summary(fun.data = mean_se, geom = "errorbar", size=2.5, width=0.0, position = dodge, colour='#B7BBBE')  +
  stat_summary(fun.data = "mean_cl_boot", geom = "point", size= 7, position = dodge)  +theme_classic() + labs(y="differentiation accuracy (%)", x="",title="") +  theme(text = element_text(size=40), legend.title=element_blank()) + scale_color_manual(values=cbbPalette) 

ggsave('~/Documents/CAMCAN_outputs/figures/SHORT_within_TASK_bands.pdf', device = "pdf", width=20, height=8, dpi=800)


data_plot=df
ggplot(data=data_plot, aes(x=dataset_distance, y=ACC, colour=age_group, width=.5)) + stat_summary(fun.data = mean_se, geom = "errorbar", size=2.5, width=0.0) + geom_smooth(method = "lm",aes(fill = age_group), size=2) + stat_summary(fun.data = "mean_cl_boot", geom = "point", size= 7,)  +theme_classic() + labs(y="differentiation accuracy (%)", x="",title="") +  theme(text = element_text(size=40), legend.title=element_blank()) + scale_color_manual(values=cbbPalette) + scale_fill_manual(values=cbbPalette) 

ggsave('~/Documents/CAMCAN_outputs/figures/SHORT_within_TASK_lineardecay.pdf', device = "pdf", width=8, height=8, dpi=800)


data_plot=df
data_plot=data_plot[data_plot$age_group!="full cohort",]
ggplot(data=data_plot, aes(x=dataset_distance, y=ACC, colour=age_group, width=.5)) + stat_summary(fun.data = mean_se, geom = "errorbar", size=2.5, width=0.0) + geom_smooth(method = "lm",aes(fill = age_group), size=2) + stat_summary(fun.data = "mean_cl_boot", geom = "point", size= 7,)  +theme_classic() + labs(y="differentiation accuracy (%)", x="",title="") +  theme(text = element_text(size=40), legend.position = 'none', legend.title=element_blank()) + scale_color_manual(values=cbbPalette[2:5]) + scale_fill_manual(values=cbbPalette[2:5]) 

ggsave('~/Documents/CAMCAN_outputs/figures/SHORT_within_TASK_lineardecay_nofull.pdf', device = "pdf", width=8, height=8, dpi=800)


data4reg= df[df$age_group != 'full cohort',]

lm0=lm(ACC ~ 1, data4reg)
lm2=lm(ACC ~ 1 + dataset_distance , data4reg)
lm3=lm(ACC ~ 1 + dataset_distance  + age_group, data4reg)
lm4=lm(ACC ~ 1 + dataset_distance  + age_group +age_group*dataset_distance, data4reg)

anova(lm0, lm2,lm3, lm4)
summary(lm4)
sjPlot::tab_model(lm4)

bf = generalTestBF(ACC ~ 1 + dataset_distance + age_group +age_group:dataset_distance, data4reg, whichModels = "top")
summary(bf)





df=read.csv("~/Documents/CAMCAN_outputs/short_fingerprinting_table_across_task2.csv", header = TRUE, stringsAsFactors = FALSE)
df$band= factor(df$band,levels = c("full band", "delta", "theta", "alpha", "beta", "gamma", "high gamma"))
df$band=plyr::mapvalues(df$band, unique(df$band), c( "broadband","delta", "theta", "alpha", "beta", "gamma", "high\ngamma"))

df$age_group= factor(df$age_group,levels = c("full dataset", "younger adults","adults", 'older adults'))
df$age_group=plyr::mapvalues(df$age_group, unique(df$age_group), c( "full cohort","young adult", "adult", "older adult"))
df$dataset_distance=df$dist


tt=data_plot %>% group_by(band, age_group) %>% summarise(mean=mean(ACC), se= (sd(ACC)/sqrt(n())))

data_plot=df
dodge <- position_dodge(width = 0.9)
ggplot(data=data_plot, aes(x=band, y=ACC,fill=age_group, colour=age_group, width=.5)) +  geom_jitter(position= position_jitterdodge(jitter.width=0.2, dodge.width=0.9), size=4, alpha =0.7 ) + stat_summary(fun.data = mean_se, geom = "errorbar", size=2.5, width=0.0, position = dodge, colour='#B7BBBE')  +
  stat_summary(fun.data = "mean_cl_boot", geom = "point", size= 7, position = dodge)  +theme_classic() + labs(y="differentiation accuracy (%)", x="",title="") +  theme(text = element_text(size=40), legend.title=element_blank()) + scale_color_manual(values=cbbPalette) 

ggsave('~/Documents/CAMCAN_outputs/figures/SHORT_ACROSS_bands.pdf', device = "pdf", width=20, height=8, dpi=800)


data_plot=df
ggplot(data=data_plot, aes(x=dataset_distance, y=ACC, colour=age_group, width=.5)) + stat_summary(fun.data = mean_se, geom = "errorbar", size=2.5, width=0.0) + geom_smooth(method = "lm",aes(fill = age_group), size=2) + stat_summary(fun.data = "mean_cl_boot", geom = "point", size= 7,)  +theme_classic() + labs(y="differentiation accuracy (%)", x="",title="") +  theme(text = element_text(size=40), legend.title=element_blank()) + scale_color_manual(values=cbbPalette) + scale_fill_manual(values=cbbPalette) 

ggsave('~/Documents/CAMCAN_outputs/figures/SHORT_ACROSS_lineardecay.pdf', device = "pdf", width=8, height=8, dpi=800)


data_plot=df
data_plot=data_plot[data_plot$age_group!="full cohort",]
ggplot(data=data_plot, aes(x=dataset_distance, y=ACC, colour=age_group, width=.5)) + stat_summary(fun.data = mean_se, geom = "errorbar", size=2.5, width=0.0) + geom_smooth(method = "lm",aes(fill = age_group), size=2) + stat_summary(fun.data = "mean_cl_boot", geom = "point", size= 7,)  +theme_classic() + labs(y="differentiation accuracy (%)", x="",title="") +  theme(text = element_text(size=40), legend.position = 'none', legend.title=element_blank()) + scale_color_manual(values=cbbPalette[2:5]) + scale_fill_manual(values=cbbPalette[2:5]) 

ggsave('~/Documents/CAMCAN_outputs/figures/SHORT_ACROSS_lineardecay_nofull.pdf', device = "pdf", width=8, height=8, dpi=800)


data4reg= df[df$age_group != 'full cohort',]

lm0=lm(ACC ~ 1, data4reg)
lm2=lm(ACC ~ 1 + dataset_distance , data4reg)
lm3=lm(ACC ~ 1 + dataset_distance  + age_group, data4reg)
lm4=lm(ACC ~ 1 + dataset_distance  + age_group +age_group*dataset_distance, data4reg)

anova(lm0, lm2,lm3, lm4)
summary(lm4)
sjPlot::tab_model(lm4)

bf = generalTestBF(ACC ~ 1 + dataset_distance + age_group +age_group:dataset_distance, data4reg, whichModels = "top")
summary(bf)


```



```{r aperiodic corr short fingerprinting within session}


cbbPalette= c("#4f89e0", "#d81b99",'#156605',"#76D7C4","#268236", '#4d3d87','#593d80', '#3b49e3')


demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]

permutation <- expand.grid(c(1:9), c(1:9))
permutation=permutation[!duplicated(apply(permutation,1,function(x) paste(sort(x),collapse=''))),]
permutation=permutation[!apply(permutation,1, duplicated)[2,],]

for (k in 1:36){
  
dif=permutation[k,1]-permutation[k,2]
  
seg1= read.csv(paste('~/Documents/CAMCAN_outputs/shortsegments4fingerprintingFOOOF//short_segment_', as.character(permutation[k,2]), '.csv', sep = ''), header = FALSE)
seg2= read.csv(paste('~/Documents/CAMCAN_outputs/shortsegments4fingerprintingFOOOF/short_segment_', as.character(permutation[k,1]), '.csv', sep = ''), header = FALSE)

corr_psd=cor(t(seg1),t(seg2)) 
demo$psd_self_corr=diag(corr_psd)
demo$psd_identifiability=diag(apply(corr_psd, 2, scale))

fingerprint=matrix(, ncol = 3,nrow=4)

print("psd fingerprinting:")
tt=apply(corr_psd, 1, which.max)
fingerprint[1,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[1,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,]),t(seg2[ind,])) 
print("psd fingerprinting young adults:")
tt=apply(corr_psd, 1, which.max)
fingerprint[2,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[2,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,]),t(seg2[ind,])) 
print("psd fingerprinting adults:")
tt=apply(corr_psd, 1, which.max)
fingerprint[3,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[3,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,]),t(seg2[ind,])) 
print("psd fingerprinting older adults:")
tt=apply(corr_psd, 1, which.max)
fingerprint[4,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[4,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint=as.data.frame(fingerprint)

fingerprint[,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[,4]=c("full band", "full band", "full band", "full band")

colnames(fingerprint) = c("acc1", "acc2", "age_group", "band")

# delta 
index_delta=unlist(lapply(1:68, function(x) ((x-1)*79)+(1:6)))
index_theta=unlist(lapply(1:68, function(x) ((x-1)*79)+(7:14))) # theta
index_alpha=unlist(lapply(1:68, function(x) ((x-1)*79)+(15:24))) # alpha
index_beta=unlist(lapply(1:68, function(x) ((x-1)*79)+(25:58))) # beta

corr_psd=cor(t(seg1[,index_delta]),t(seg2[,index_delta])) 

print("psd fingerprinting delta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[5,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[5,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_delta]),t(seg2[ind,index_delta])) 
print("psd fingerprinting young adults delta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[6,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[6,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_delta]),t(seg2[ind,index_delta])) 
print("psd fingerprinting adults delta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[7,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[7,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_delta]),t(seg2[ind,index_delta])) 
print("psd fingerprinting older adults delta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[8,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[8,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint[5:8,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[5:8,4]=c("delta", "delta", "delta", "delta")


# theta
corr_psd=cor(t(seg1[,index_theta]),t(seg2[,index_theta])) 

print("psd fingerprinting theta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[9,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[9,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_theta]),t(seg2[ind,index_theta])) 
print("psd fingerprinting young adults theta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[10,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[10,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_theta]),t(seg2[ind,index_theta])) 
print("psd fingerprinting adults theta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[11,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[11,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_theta]),t(seg2[ind,index_theta])) 
print("psd fingerprinting older adults theta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[12,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[12,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint[9:12,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[9:12,4]=c("theta", "theta", "theta", "theta")


# alpha
corr_psd=cor(t(seg1[,index_alpha]),t(seg2[,index_alpha])) 

print("psd fingerprinting alpha:")
tt=apply(corr_psd, 1, which.max)
fingerprint[13,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[13,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_alpha]),t(seg2[ind,index_alpha])) 
print("psd fingerprinting young adults alpha:")
tt=apply(corr_psd, 1, which.max)
fingerprint[14,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[14,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_alpha]),t(seg2[ind,index_alpha])) 
print("psd fingerprinting adults alpha:")
tt=apply(corr_psd, 1, which.max)
fingerprint[15,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[15,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_alpha]),t(seg2[ind,index_alpha])) 
print("psd fingerprinting older adults alpha:")
tt=apply(corr_psd, 1, which.max)
fingerprint[16,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[16,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint[13:16,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[13:16,4]=c("alpha", "alpha", "alpha", "alpha")


# beta
corr_psd=cor(t(seg1[,index_beta]),t(seg2[,index_beta])) 

print("psd fingerprinting beta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[17,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[17,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_beta]),t(seg2[ind,index_beta])) 
print("psd fingerprinting young adults beta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[18,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[18,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_beta]),t(seg2[ind,index_beta])) 
print("psd fingerprinting adults beta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[19,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[19,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_beta]),t(seg2[ind,index_beta])) 
print("psd fingerprinting older adults beta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[20,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[20,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint[17:20,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[17:20,4]=c("beta", "beta", "beta", "beta")



fingerprint$ACC= rowMeans(fingerprint[,1:2])*100

fingerprint$age_group = ordered(fingerprint$age_group, levels= c("full dataset", "younger adults", "adults", "older adults"))

fingerprint$band = ordered(fingerprint$band, levels= c("full band", "delta", "theta", "alpha", "beta"))

fingerprint$dist=dif 

write.table(fingerprint, file = '~/Documents/CAMCAN_outputs/short_fingerprinting_table_within_aperiodic_corr.csv', append = TRUE, quote = FALSE, sep = ',', row.names = FALSE, col.names = FALSE)
print(k)
}


```



```{r aperiodic corr short fingerprinting within session}


cbbPalette= c("#4f89e0", "#d81b99",'#156605',"#76D7C4","#268236", '#4d3d87','#593d80', '#3b49e3')


demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]

permutation <- expand.grid(c(1:8), c(1:8))
permutation=permutation[!duplicated(apply(permutation,1,function(x) paste(sort(x),collapse=''))),]
permutation=permutation[!apply(permutation,1, duplicated)[2,],]

for (k in 1:28){

dif=permutation[k,1]-permutation[k,2]
  
seg1= read.csv(paste('~/Documents/CAMCAN_outputs/shortsegments4fingerprintingFOOOFTASK/short_segment_', as.character(permutation[k,2]), '.csv', sep = ''), header = FALSE)
seg2= read.csv(paste('~/Documents/CAMCAN_outputs/shortsegments4fingerprintingFOOOFTASK/short_segment_', as.character(permutation[k,1]), '.csv', sep = ''), header = FALSE)

corr_psd=cor(t(seg1),t(seg2)) 
demo$psd_self_corr=diag(corr_psd)
demo$psd_identifiability=diag(apply(corr_psd, 2, scale))

fingerprint=matrix(, ncol = 3,nrow=4)

print("psd fingerprinting:")
tt=apply(corr_psd, 1, which.max)
fingerprint[1,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[1,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,]),t(seg2[ind,])) 
print("psd fingerprinting young adults:")
tt=apply(corr_psd, 1, which.max)
fingerprint[2,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[2,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,]),t(seg2[ind,])) 
print("psd fingerprinting adults:")
tt=apply(corr_psd, 1, which.max)
fingerprint[3,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[3,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,]),t(seg2[ind,])) 
print("psd fingerprinting older adults:")
tt=apply(corr_psd, 1, which.max)
fingerprint[4,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[4,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint=as.data.frame(fingerprint)

fingerprint[,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[,4]=c("full band", "full band", "full band", "full band")

colnames(fingerprint) = c("acc1", "acc2", "age_group", "band")

# delta 
index_delta=unlist(lapply(1:68, function(x) ((x-1)*79)+(1:6)))
index_theta=unlist(lapply(1:68, function(x) ((x-1)*79)+(7:14))) # theta
index_alpha=unlist(lapply(1:68, function(x) ((x-1)*79)+(15:24))) # alpha
index_beta=unlist(lapply(1:68, function(x) ((x-1)*79)+(25:58))) # beta

corr_psd=cor(t(seg1[,index_delta]),t(seg2[,index_delta])) 

print("psd fingerprinting delta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[5,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[5,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_delta]),t(seg2[ind,index_delta])) 
print("psd fingerprinting young adults delta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[6,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[6,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_delta]),t(seg2[ind,index_delta])) 
print("psd fingerprinting adults delta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[7,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[7,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_delta]),t(seg2[ind,index_delta])) 
print("psd fingerprinting older adults delta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[8,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[8,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint[5:8,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[5:8,4]=c("delta", "delta", "delta", "delta")


# theta
corr_psd=cor(t(seg1[,index_theta]),t(seg2[,index_theta])) 

print("psd fingerprinting theta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[9,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[9,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_theta]),t(seg2[ind,index_theta])) 
print("psd fingerprinting young adults theta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[10,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[10,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_theta]),t(seg2[ind,index_theta])) 
print("psd fingerprinting adults theta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[11,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[11,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_theta]),t(seg2[ind,index_theta])) 
print("psd fingerprinting older adults theta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[12,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[12,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint[9:12,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[9:12,4]=c("theta", "theta", "theta", "theta")


# alpha
corr_psd=cor(t(seg1[,index_alpha]),t(seg2[,index_alpha])) 

print("psd fingerprinting alpha:")
tt=apply(corr_psd, 1, which.max)
fingerprint[13,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[13,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_alpha]),t(seg2[ind,index_alpha])) 
print("psd fingerprinting young adults alpha:")
tt=apply(corr_psd, 1, which.max)
fingerprint[14,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[14,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_alpha]),t(seg2[ind,index_alpha])) 
print("psd fingerprinting adults alpha:")
tt=apply(corr_psd, 1, which.max)
fingerprint[15,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[15,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_alpha]),t(seg2[ind,index_alpha])) 
print("psd fingerprinting older adults alpha:")
tt=apply(corr_psd, 1, which.max)
fingerprint[16,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[16,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint[13:16,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[13:16,4]=c("alpha", "alpha", "alpha", "alpha")


# beta
corr_psd=cor(t(seg1[,index_beta]),t(seg2[,index_beta])) 

print("psd fingerprinting beta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[17,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[17,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_beta]),t(seg2[ind,index_beta])) 
print("psd fingerprinting young adults beta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[18,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[18,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_beta]),t(seg2[ind,index_beta])) 
print("psd fingerprinting adults beta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[19,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[19,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_beta]),t(seg2[ind,index_beta])) 
print("psd fingerprinting older adults beta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[20,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[20,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint[17:20,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[17:20,4]=c("beta", "beta", "beta", "beta")



fingerprint$ACC= rowMeans(fingerprint[,1:2])*100

fingerprint$age_group = ordered(fingerprint$age_group, levels= c("full dataset", "younger adults", "adults", "older adults"))

fingerprint$band = ordered(fingerprint$band, levels= c("full band", "delta", "theta", "alpha", "beta"))

fingerprint$dist=dif 

write.table(fingerprint, file = '~/Documents/CAMCAN_outputs/short_fingerprinting_table_within_task_aperiodic_corr.csv', append = TRUE, quote = FALSE, sep = ',', row.names = FALSE, col.names = FALSE)
print(k)
}


```




```{r aperiodic corr short fingerprinting across session}


cbbPalette= c("#4f89e0", "#d81b99",'#156605',"#76D7C4","#268236", '#4d3d87','#593d80', '#3b49e3')


demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]

permutation <- expand.grid(c(1:8), c(1:8))


for (k in 1:64){
  
dif=permutation[k,1]-permutation[k,2]
  
seg1= read.csv(paste('~/Documents/CAMCAN_outputs/shortsegments4fingerprintingFOOOF//short_segment_', as.character(permutation[k,2]), '.csv', sep = ''), header = FALSE)
seg2= read.csv(paste('~/Documents/CAMCAN_outputs/shortsegments4fingerprintingFOOOFTASK/short_segment_', as.character(permutation[k,1]), '.csv', sep = ''), header = FALSE)

corr_psd=cor(t(seg1),t(seg2)) 
demo$psd_self_corr=diag(corr_psd)
demo$psd_identifiability=diag(apply(corr_psd, 2, scale))

fingerprint=matrix(, ncol = 3,nrow=4)

print("psd fingerprinting:")
tt=apply(corr_psd, 1, which.max)
fingerprint[1,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[1,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,]),t(seg2[ind,])) 
print("psd fingerprinting young adults:")
tt=apply(corr_psd, 1, which.max)
fingerprint[2,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[2,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,]),t(seg2[ind,])) 
print("psd fingerprinting adults:")
tt=apply(corr_psd, 1, which.max)
fingerprint[3,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[3,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,]),t(seg2[ind,])) 
print("psd fingerprinting older adults:")
tt=apply(corr_psd, 1, which.max)
fingerprint[4,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[4,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint=as.data.frame(fingerprint)

fingerprint[,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[,4]=c("full band", "full band", "full band", "full band")

colnames(fingerprint) = c("acc1", "acc2", "age_group", "band")

# delta 
index_delta=unlist(lapply(1:68, function(x) ((x-1)*79)+(1:6)))
index_theta=unlist(lapply(1:68, function(x) ((x-1)*79)+(7:14))) # theta
index_alpha=unlist(lapply(1:68, function(x) ((x-1)*79)+(15:24))) # alpha
index_beta=unlist(lapply(1:68, function(x) ((x-1)*79)+(25:58))) # beta

corr_psd=cor(t(seg1[,index_delta]),t(seg2[,index_delta])) 

print("psd fingerprinting delta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[5,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[5,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_delta]),t(seg2[ind,index_delta])) 
print("psd fingerprinting young adults delta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[6,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[6,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_delta]),t(seg2[ind,index_delta])) 
print("psd fingerprinting adults delta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[7,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[7,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_delta]),t(seg2[ind,index_delta])) 
print("psd fingerprinting older adults delta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[8,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[8,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint[5:8,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[5:8,4]=c("delta", "delta", "delta", "delta")


# theta
corr_psd=cor(t(seg1[,index_theta]),t(seg2[,index_theta])) 

print("psd fingerprinting theta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[9,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[9,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_theta]),t(seg2[ind,index_theta])) 
print("psd fingerprinting young adults theta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[10,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[10,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_theta]),t(seg2[ind,index_theta])) 
print("psd fingerprinting adults theta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[11,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[11,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_theta]),t(seg2[ind,index_theta])) 
print("psd fingerprinting older adults theta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[12,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[12,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint[9:12,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[9:12,4]=c("theta", "theta", "theta", "theta")


# alpha
corr_psd=cor(t(seg1[,index_alpha]),t(seg2[,index_alpha])) 

print("psd fingerprinting alpha:")
tt=apply(corr_psd, 1, which.max)
fingerprint[13,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[13,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_alpha]),t(seg2[ind,index_alpha])) 
print("psd fingerprinting young adults alpha:")
tt=apply(corr_psd, 1, which.max)
fingerprint[14,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[14,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_alpha]),t(seg2[ind,index_alpha])) 
print("psd fingerprinting adults alpha:")
tt=apply(corr_psd, 1, which.max)
fingerprint[15,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[15,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_alpha]),t(seg2[ind,index_alpha])) 
print("psd fingerprinting older adults alpha:")
tt=apply(corr_psd, 1, which.max)
fingerprint[16,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[16,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint[13:16,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[13:16,4]=c("alpha", "alpha", "alpha", "alpha")


# beta
corr_psd=cor(t(seg1[,index_beta]),t(seg2[,index_beta])) 

print("psd fingerprinting beta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[17,1]=sum(seq(1:603)==tt)/603
tt=apply(corr_psd, 2, which.max)
fingerprint[17,2]=sum(seq(1:603)==tt)/603


# break up into three (roughly equal) age groups
# young adults (18-45)

ind=demo$Age>18 & demo$Age <45
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_beta]),t(seg2[ind,index_beta])) 
print("psd fingerprinting young adults beta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[18,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[18,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# adults (45-65)

ind=demo$Age>=45 & demo$Age <65
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_beta]),t(seg2[ind,index_beta])) 
print("psd fingerprinting adults beta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[19,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[19,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)


# older adults (45-65)
ind=demo$Age>=65 & demo$Age <90
sum(ind==TRUE)
corr_psd=cor(t(seg1[ind,index_beta]),t(seg2[ind,index_beta])) 
print("psd fingerprinting older adults beta:")
tt=apply(corr_psd, 1, which.max)
fingerprint[20,1]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)
tt=apply(corr_psd, 2, which.max)
fingerprint[20,2]=sum(seq(1:sum(ind==TRUE))==tt)/sum(ind==TRUE)

fingerprint[17:20,3]=c("full dataset", "younger adults", "adults", "older adults")
fingerprint[17:20,4]=c("beta", "beta", "beta", "beta")



fingerprint$ACC= rowMeans(fingerprint[,1:2])*100

fingerprint$age_group = ordered(fingerprint$age_group, levels= c("full dataset", "younger adults", "adults", "older adults"))

fingerprint$band = ordered(fingerprint$band, levels= c("full band", "delta", "theta", "alpha", "beta"))

fingerprint$dist=dif 

write.table(fingerprint, file = '~/Documents/CAMCAN_outputs/short_fingerprinting_table_across_task_aperiodicocrr.csv', append = TRUE, quote = FALSE, sep = ',', row.names = FALSE, col.names = FALSE)
print(k)
}

```



``` {r plot short differentiation aperiodic corr effect}

# set colour palette
cbbPalette= c("#DBF132", "#15A705",'#4F89E0',"#D81B99","#268236", '#4d3d87','#593d80', '#3b49e3')


df=read.csv("~/Documents/CAMCAN_outputs/short_fingerprinting_table_within_aperiodic_corr.csv", header = TRUE, stringsAsFactors = FALSE)
df$band= factor(df$band,levels = c("full band", "delta", "theta", "alpha", "beta"))
df$band=plyr::mapvalues(df$band, unique(df$band), c( "broadband","delta", "theta", "alpha", "beta"))

df$age_group= factor(df$age_group,levels = c("full dataset", "younger adults","adults", 'older adults'))
df$age_group=plyr::mapvalues(df$age_group, unique(df$age_group), c( "full cohort","young adult", "adult", "older adult"))
df$dataset_distance=df$dist

data_plot=df
dodge <- position_dodge(width = 0.9)
ggplot(data=data_plot, aes(x=band, y=ACC,fill=age_group, colour=age_group, width=.5)) +  geom_jitter(position= position_jitterdodge(jitter.width=0.2, dodge.width=0.9), size=4, alpha =0.7 ) + stat_summary(fun.data = mean_se, geom = "errorbar", size=2.5, width=0.0, position = dodge, colour='#B7BBBE')  +
  stat_summary(fun.data = "mean_cl_boot", geom = "point", size= 7, position = dodge)  +theme_classic() + labs(y="differentiation accuracy (%)", x="",title="") +  theme(text = element_text(size=40), legend.title=element_blank()) + scale_color_manual(values=cbbPalette) 

ggsave('~/Documents/CAMCAN_outputs/figures/SHORT_within_restingstate_bands_aperiodicocr.pdf', device = "pdf", width=20, height=8, dpi=800)


data_plot=df
ggplot(data=data_plot, aes(x=dataset_distance, y=ACC, colour=age_group, width=.5)) + stat_summary(fun.data = mean_se, geom = "errorbar", size=2.5, width=0.5) + geom_smooth(method = "lm",aes(fill = age_group), size=2) + stat_summary(fun.data = "mean_cl_boot", geom = "point", size= 7,)  +theme_classic() + labs(y="differentiation accuracy (%)", x="",title="") +  theme(text = element_text(size=40), legend.title=element_blank()) + scale_color_manual(values=cbbPalette) + scale_fill_manual(values=cbbPalette) 

ggsave('~/Documents/CAMCAN_outputs/figures/SHORT_within_restingstate_lineardecay_aperiodicocr.pdf', device = "pdf", width=8, height=8, dpi=800)


data_plot=df
data_plot=data_plot[data_plot$age_group!="full cohort",]
ggplot(data=data_plot, aes(x=dataset_distance, y=ACC, colour=age_group, width=.5)) + stat_summary(fun.data = mean_se, geom = "errorbar", size=2.5, width=0.0) + geom_smooth(method = "lm",aes(fill = age_group), size=2) + stat_summary(fun.data = "mean_cl_boot", geom = "point", size= 7,)  +theme_classic() + labs(y="differentiation accuracy (%)", x="",title="") +  theme(text = element_text(size=40), legend.position = 'none', legend.title=element_blank()) + scale_color_manual(values=cbbPalette[2:5]) + scale_fill_manual(values=cbbPalette[2:5]) 

ggsave('~/Documents/CAMCAN_outputs/figures/SHORT_within_restingstate_lineardecay_noful_aperiodicocrl.pdf', device = "pdf", width=8, height=8, dpi=800)


data4reg= df[df$age_group != 'full cohort',]

lm0=lm(ACC ~ 1, data4reg)
lm2=lm(ACC ~ 1 + dataset_distance , data4reg)
lm3=lm(ACC ~ 1 + dataset_distance  + age_group, data4reg)
lm4=lm(ACC ~ 1 + dataset_distance  + age_group +age_group*dataset_distance, data4reg)

anova(lm0, lm2,lm3, lm4)
summary(lm4)
sjPlot::tab_model(lm4)

bf = generalTestBF(ACC ~ 1 + dataset_distance + age_group +age_group:dataset_distance, data4reg, whichModels = "top")
summary(bf)



df=read.csv("~/Documents/CAMCAN_outputs/short_fingerprinting_table_within_task_aperiodic_corr.csv", header = TRUE, stringsAsFactors = FALSE)
df$band= factor(df$band,levels = c("full band", "delta", "theta", "alpha", "beta"))
df$band=plyr::mapvalues(df$band, unique(df$band), c( "broadband","delta", "theta", "alpha", "beta"))

df$age_group= factor(df$age_group,levels = c("full dataset", "younger adults","adults", 'older adults'))
df$age_group=plyr::mapvalues(df$age_group, unique(df$age_group), c( "full cohort","young adult", "adult", "older adult"))
df$dataset_distance=df$dist

data_plot=df
dodge <- position_dodge(width = 0.9)
ggplot(data=data_plot, aes(x=band, y=ACC,fill=age_group, colour=age_group, width=.5)) +  geom_jitter(position= position_jitterdodge(jitter.width=0.2, dodge.width=0.9), size=4, alpha =0.7 ) + stat_summary(fun.data = mean_se, geom = "errorbar", size=2.5, width=0.0, position = dodge, colour='#B7BBBE')  +
  stat_summary(fun.data = "mean_cl_boot", geom = "point", size= 7, position = dodge)  +theme_classic() + labs(y="differentiation accuracy (%)", x="",title="") +  theme(text = element_text(size=40), legend.title=element_blank()) + scale_color_manual(values=cbbPalette) 

ggsave('~/Documents/CAMCAN_outputs/figures/SHORT_within_TASK_bands_aperiodicocr.pdf', device = "pdf", width=20, height=8, dpi=800)


data_plot=df
ggplot(data=data_plot, aes(x=dataset_distance, y=ACC, colour=age_group, width=.5)) + stat_summary(fun.data = mean_se, geom = "errorbar", size=2.5, width=0.0) + geom_smooth(method = "lm",aes(fill = age_group), size=2) + stat_summary(fun.data = "mean_cl_boot", geom = "point", size= 7,)  +theme_classic() + labs(y="differentiation accuracy (%)", x="",title="") +  theme(text = element_text(size=40), legend.title=element_blank()) + scale_color_manual(values=cbbPalette) + scale_fill_manual(values=cbbPalette) 

ggsave('~/Documents/CAMCAN_outputs/figures/SHORT_within_TASK_lineardecay_aperiodicocr.pdf', device = "pdf", width=8, height=8, dpi=800)


data_plot=df
data_plot=data_plot[data_plot$age_group!="full cohort",]
ggplot(data=data_plot, aes(x=dataset_distance, y=ACC, colour=age_group, width=.5)) + stat_summary(fun.data = mean_se, geom = "errorbar", size=2.5, width=0.0) + geom_smooth(method = "lm",aes(fill = age_group), size=2) + stat_summary(fun.data = "mean_cl_boot", geom = "point", size= 7,)  +theme_classic() + labs(y="differentiation accuracy (%)", x="",title="") +  theme(text = element_text(size=40), legend.position = 'none', legend.title=element_blank()) + scale_color_manual(values=cbbPalette[2:5]) + scale_fill_manual(values=cbbPalette[2:5]) 

ggsave('~/Documents/CAMCAN_outputs/figures/SHORT_within_TASK_lineardecay_noful_aperiodicocrl.pdf', device = "pdf", width=8, height=8, dpi=800)







df=read.csv("~/Documents/CAMCAN_outputs/short_fingerprinting_table_across_task_aperiodicocrr.csv", header = TRUE, stringsAsFactors = FALSE)
df$band= factor(df$band,levels = c("full band", "delta", "theta", "alpha", "beta"))
df$band=plyr::mapvalues(df$band, unique(df$band), c( "broadband","delta", "theta", "alpha", "beta"))

df$age_group= factor(df$age_group,levels = c("full dataset", "younger adults","adults", 'older adults'))
df$age_group=plyr::mapvalues(df$age_group, unique(df$age_group), c( "full cohort","young adult", "adult", "older adult"))
df$dataset_distance=df$dist

data_plot=df
dodge <- position_dodge(width = 0.9)
ggplot(data=data_plot, aes(x=band, y=ACC,fill=age_group, colour=age_group, width=.5)) +  geom_jitter(position= position_jitterdodge(jitter.width=0.2, dodge.width=0.9), size=4, alpha =0.7 ) + stat_summary(fun.data = mean_se, geom = "errorbar", size=2.5, width=0.0, position = dodge, colour='#B7BBBE')  +
  stat_summary(fun.data = "mean_cl_boot", geom = "point", size= 7, position = dodge)  +theme_classic() + labs(y="differentiation accuracy (%)", x="",title="") +  theme(text = element_text(size=40), legend.title=element_blank()) + scale_color_manual(values=cbbPalette) 

ggsave('~/Documents/CAMCAN_outputs/figures/SHORT_ACROSS_bands_aperiodicocr.pdf', device = "pdf", width=20, height=8, dpi=800)


data_plot=df
ggplot(data=data_plot, aes(x=dataset_distance, y=ACC, colour=age_group, width=.5)) + stat_summary(fun.data = mean_se, geom = "errorbar", size=2.5, width=0.0) + geom_smooth(method = "lm",aes(fill = age_group), size=2) + stat_summary(fun.data = "mean_cl_boot", geom = "point", size= 7,)  +theme_classic() + labs(y="differentiation accuracy (%)", x="",title="") +  theme(text = element_text(size=40), legend.title=element_blank()) + scale_color_manual(values=cbbPalette) + scale_fill_manual(values=cbbPalette) 

ggsave('~/Documents/CAMCAN_outputs/figures/SHORT_ACROSS_lineardecay_aperiodicocr.pdf', device = "pdf", width=8, height=8, dpi=800)


data_plot=df
data_plot=data_plot[data_plot$age_group!="full cohort",]
ggplot(data=data_plot, aes(x=dataset_distance, y=ACC, colour=age_group, width=.5)) + stat_summary(fun.data = mean_se, geom = "errorbar", size=2.5, width=0.0) + geom_smooth(method = "lm",aes(fill = age_group), size=2) + stat_summary(fun.data = "mean_cl_boot", geom = "point", size= 7,)  +theme_classic() + labs(y="differentiation accuracy (%)", x="",title="") +  theme(text = element_text(size=40), legend.position = 'none', legend.title=element_blank()) + scale_color_manual(values=cbbPalette[2:5]) + scale_fill_manual(values=cbbPalette[2:5]) 

ggsave('~/Documents/CAMCAN_outputs/figures/SHORT_ACROSS_lineardecay_nofull_aperiodicocr.pdf', device = "pdf", width=8, height=8, dpi=800)





```



``` {r plotting SVR of cognition}

# set colour palette
cbbPalette= c("#DBF132", "#15A705",'#4F89E0',"#D81B99","#268236", '#4d3d87','#593d80', '#3b49e3')

SVM=read.csv( '~/Documents/CAMCAN_outputs/decode_SVR_ACER_FROMBETA_80_20_new_log.csv')
SVM=SVM[,-1]

df=read.csv('~/Documents//Alex_fingerprinting/PSD_ICC_orig_PD_new_PKD2.csv', header = FALSE, stringsAsFactors = FALSE)
colnames(df)[1]='region'
df=df[,1:2]
df$hemi =''
df$hemi[seq(2,68,2)] ='right'
df$hemi[seq(1,67,2)] ='left'
df$R=colMeans(SVM)

quantiles_decode=apply(SVM, 2, quantile, c(0.025, 0.975))
df$quantile_sig= quantiles_decode[1,] >0 & quantiles_decode[2,] >0



someData2= df
colnames(someData2)[2]='decoding corr'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'

someData2$R[someData2$R>0.2]=0.2
someData2$R[someData2$R<0]=0.0

ggplot(someData2) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = `R`)) +
  #scale_fill_distiller(palette = "RdBu"
  #                     , limits = c(0.4, 0.9))+
  viridis::scale_fill_viridis(option = 'viridis', limits = c(0.0, 0.2))+
  #scale_fill_gradient2(low="white", mid="#EC352F", high="#6C1917", 
  #                     midpoint=0.6,   
  #                     limits=c(0.4, 0.9 ))+
  theme_void() 

ggsave('~/Documents/CAMCAN_outputs/figures/decoding_of_acer_topo_80_20_beta_log.pdf', device = "pdf")


someData2$quantile_sig=as.numeric(someData2$quantile_sig)

ggplot(someData2) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = `quantile_sig`)) +

  scale_fill_gradient2(low="#DCD2D9", mid="#EC352F", high="#D81B99",
                      midpoint=0.5,
                      limits=c(0, 1 ))+
  theme_void() 

ggsave('~/Documents/CAMCAN_outputs/figures/decoding_of_acer_thresholded_maps_beta.pdf', device = "pdf")


# make hist of regions

data4plot= stack(SVM[,someData2$quantile_sig==1])

data4plot$hemi = plyr::mapvalues(data4plot$ind, unique(data4plot$ind), someData2$hemi[someData2$quantile_sig==1])

data4plot$region = plyr::mapvalues(data4plot$ind, unique(data4plot$ind), someData2$region[someData2$quantile_sig==1])


ggplot(data4plot, aes(values, color= hemi, fill=hemi, alpha=0.5)) +
  geom_density(aes( color= hemi, fill=hemi), alpha= 0.5, bins = 20) +
  #geom_histogram(aes(y=..density.., color= group, fill=group), alpha= 0.5, bins = 20) +
  theme_minimal() +
  labs(x = "prediction observed acer correlation", y = "denstity")  + theme_classic2() +
  ggtitle("") + scale_fill_manual(values=cbbPalette[c(1,4)]) + scale_color_manual(values=cbbPalette[c(1,4)]) + facet_wrap(~region, nrow = 3)

ggsave('~/Documents/CAMCAN_outputs/figures/decoding_of_acer_histograms_of_sig_regions.pdf', device = "pdf")

# compute diff in ICC
demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]

psd_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_Rest.csv', header = FALSE)
psd_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_Task.csv', header = FALSE)


# look at age groups 
ind=demo$Age>18 & demo$Age <45
z_target= t(scale(t(psd_task[ind,])))
z_database= t(scale(t(psd_rest[ind,])))
icc = c()


n = length(ind)
k = 2
df_b = n-1
df_w = n*(k-1)


for (i_edge in 1:length(psd_rest)){
  x= data.frame(unlist(z_target[,i_edge]),unlist(z_database[,i_edge]) )
  x_w_mean =  rowMeans(x)
  x_g_mean = mean(unlist(x))
  ss_t = sum(((x - x_g_mean)^2))
  ss_w = sum((x - (x_w_mean))^2)
  ss_b = ss_t - ss_w
  ms_b = ss_b / df_b
  ms_w = ss_w / df_w
  icc[i_edge] = (ms_b - ms_w) / (ms_b + ((k-1)*ms_w))
  
  
}

icc_mat_young <- matrix(icc, nrow = 68, byrow = TRUE)


# look at age groups 
ind=demo$Age>=65 & demo$Age <90
z_target= t(scale(t(psd_task[ind,])))
z_database= t(scale(t(psd_rest[ind,])))
icc = c()


n = length(ind)
k = 2
df_b = n-1
df_w = n*(k-1)


for (i_edge in 1:length(psd_rest)){
  x= data.frame(unlist(z_target[,i_edge]),unlist(z_database[,i_edge]) )
  x_w_mean =  rowMeans(x)
  x_g_mean = mean(unlist(x))
  ss_t = sum(((x - x_g_mean)^2))
  ss_w = sum((x - (x_w_mean))^2)
  ss_b = ss_t - ss_w
  ms_b = ss_b / df_b
  ms_w = ss_w / df_w
  icc[i_edge] = (ms_b - ms_w) / (ms_b + ((k-1)*ms_w))
  
  
}

icc_mat_older <- matrix(icc, nrow = 68, byrow = TRUE)

icc_diff= icc_mat_older- icc_mat_young

cor.test(someData2$R, rowMeans(icc_diff))

someData2= df
someData2$ICC= rowMeans(icc_diff)
colnames(someData2)[2]='decoding corr'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'

someData2$ICC[someData2$ICC>.1]= 0.1

ggplot(someData2) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = `ICC`)) +
  #scale_fill_distiller(palette = "RdBu"
  #                     , limits = c(0.4, 0.9))+
  viridis::scale_fill_viridis(option = 'viridis', limits = c(-0.2, 0.2))+
  #scale_fill_gradient2(low="white", mid="#EC352F", high="#6C1917", 
  #                     midpoint=0.6,   
  #                     limits=c(0.4, 0.9 ))+
  theme_void() 

ggsave('~/Documents/CAMCAN_outputs/figures/broadband_diff_ICC.pdf', device = "pdf")



coeff= data.frame()

someData2$R_scaled= scale(someData2$R)
someData2$ICC_scaled= scale(someData2$ICC)

lm3=lm(`R_scaled` ~ ICC_scaled, someData2)
summary(lm3)
coeff=rbind(coeff, data.frame(coef=coef(lm3)[2], CI_low=confint(lm3)[2,1],CI_up=confint(lm3)[2,2],  p_val= summary.lm(lm3)[[4]][2,4] ))

ggplot(someData2, aes(x=R , y = ICC, fill=cbbPalette[4])) + 
  geom_jitter(colour = cbbPalette[4]) + 
  stat_smooth(method = "lm", colour = 'black',fullrange = T, fill=cbbPalette[4]) +
  labs(title = paste("Adj R2 = ", signif(summary(lm3)$adj.r.squared, 5),
                     "Intercept =", signif(lm3$coef[[1]],5 ),
                     " Slope =", signif(lm3$coef[[2]], 5),
                     " P =", signif(summary(lm3)$coef[2,4], 5) )) + scale_fill_manual(values=cbbPalette[4])  + theme_classic2() +   xlab("decoding correlation (r)") + ylab("ICC")+
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"), legend.position = "none") 

ggsave('~/Documents/CAMCAN_outputs/figures/SVR_ACER_ICC_broadband.pdf', device = "pdf", width=5, height=5, dpi=800)

icc_diff= icc_mat_older- icc_mat_young

icc_diff= data.frame(delta= rowMeans(icc_diff[,1:8]),
                     theta= rowMeans(icc_diff[,9:16]),
                     alpha=rowMeans(icc_diff[,17:26]),
                     beta=rowMeans(icc_diff[,27:60]),
                     gamma=rowMeans(icc_diff[,61:101]),
                     hgamma=rowMeans(icc_diff[,102:300]))


cor.test(someData2$R, icc_diff$delta)

someData2$ICC_scaled= scale(icc_diff$delta)
lm3=lm(`R_scaled` ~ ICC_scaled, someData2)
summary(lm3)
coeff=rbind(coeff, data.frame(coef=coef(lm3)[2], CI_low=confint(lm3)[2,1],CI_up=confint(lm3)[2,2], p_val= summary.lm(lm3)[[4]][2,4] ))


cor.test(someData2$R, icc_diff$theta)

someData2$ICC_scaled= scale(icc_diff$theta)
lm3=lm(`R_scaled` ~ ICC_scaled, someData2)
summary(lm3)
coeff=rbind(coeff, data.frame(coef=coef(lm3)[2], CI_low=confint(lm3)[2,1],CI_up=confint(lm3)[2,2], p_val= summary.lm(lm3)[[4]][2,4] ))


cor.test(someData2$R, icc_diff$alpha)

someData2$ICC_scaled= scale(icc_diff$alpha)
lm3=lm(`R_scaled` ~ ICC_scaled, someData2)
summary(lm3)
coeff=rbind(coeff, data.frame(coef=coef(lm3)[2], CI_low=confint(lm3)[2,1],CI_up=confint(lm3)[2,2], p_val= summary.lm(lm3)[[4]][2,4] ))


cor.test(someData2$R, icc_diff$beta)

someData2$ICC_scaled= scale(icc_diff$beta)
lm3=lm(`R_scaled` ~ ICC_scaled, someData2)
summary(lm3)
coeff=rbind(coeff, data.frame(coef=coef(lm3)[2], CI_low=confint(lm3)[2,1],CI_up=confint(lm3)[2,2], p_val= summary.lm(lm3)[[4]][2,4] ))


cor.test(someData2$R, icc_diff$gamma)

someData2$ICC_scaled= scale(icc_diff$gamma)
lm3=lm(`R_scaled` ~ ICC_scaled, someData2)
summary(lm3)
coeff=rbind(coeff, data.frame(coef=coef(lm3)[2], CI_low=confint(lm3)[2,1],CI_up=confint(lm3)[2,2], p_val= summary.lm(lm3)[[4]][2,4] ))


cor.test(someData2$R, icc_diff$hgamma)

someData2$ICC_scaled= scale(icc_diff$hgamma)
lm3=lm(`R_scaled` ~ ICC_scaled, someData2)
summary(lm3)
coeff=rbind(coeff, data.frame(coef=coef(lm3)[2], CI_low=confint(lm3)[2,1],CI_up=confint(lm3)[2,2], p_val= summary.lm(lm3)[[4]][2,4] ))


coeff$band= c('broadband', 'delta', 'theta', 'alpha', 'beta', 'gamma', 'high gamma')
coeff$band = factor(coeff$band, levels = c('high gamma', 'gamma', 'beta', 'alpha', 'theta', 'delta','broadband'))

ggplot(coeff, aes(x=band , y = coef, colour= cbbPalette[2], fill= cbbPalette[2])) + coord_flip(ylim=c(-0.6,0.6)) + geom_hline(yintercept = 0, linetype="dashed", color = "grey", size=1) +
  geom_errorbar(colour="#000000", aes(ymin=CI_low, ymax=CI_up),  width=.2, position=position_dodge(.9)) + geom_point(stat='identity',position=position_dodge(.9), size= 10)   + scale_fill_manual(values=cbbPalette[3])  + scale_color_manual(values=cbbPalette[2]) + theme_classic2() + xlab("") + ylab(" correlation (r)")+
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"), legend.position = "none")  

ggsave('~/Documents/CAMCAN_outputs/figures/SVR_correlation_between_decoding_and_delta_ICC.pdf', device = "pdf", height = 3.5, width = 5)


```





``` {r plotting SVR of cognition subscales}

# set colour palette
cbbPalette= c("#DBF132", "#15A705",'#4F89E0',"#D81B99",'#1908AF', '#9211E6',"#268236", '#4d3d87','#593d80', '#3b49e3')


SVM=read.csv( '~/Documents/CAMCAN_outputs/decode_SVR_ACER_80_20_noattention.csv')
SVM=SVM[,-1]

df=read.csv('~/Documents//Alex_fingerprinting/PSD_ICC_orig_PD_new_PKD2.csv', header = FALSE, stringsAsFactors = FALSE)
colnames(df)[1]='region'
df=df[,1:2]
df$hemi =''
df$hemi[seq(2,68,2)] ='right'
df$hemi[seq(1,67,2)] ='left'
df$R=colMeans(SVM)

quantiles_decode=apply(SVM, 2, quantile, c(0.025, 0.975))
df$quantile_sig= quantiles_decode[1,] >0 & quantiles_decode[2,] >0


someData2= df
colnames(someData2)[2]='decoding corr'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'

someData2$R[someData2$R>0.2]=0.2

ggplot(someData2) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = `R`)) +
  #scale_fill_distiller(palette = "RdBu"
  #                     , limits = c(0.4, 0.9))+
  viridis::scale_fill_viridis(option = 'viridis', limits = c(0.0, 0.2))+
  #scale_fill_gradient2(low="white", mid="#EC352F", high="#6C1917", 
  #                     midpoint=0.6,   
  #                     limits=c(0.4, 0.9 ))+
  theme_void() 

ggsave('~/Documents/CAMCAN_outputs/figures/decoding_of_acer_topo_80_20_NOATTENTION.pdf', device = "pdf")



# compute diff in ICC
demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]

psd_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_Rest.csv', header = FALSE)
psd_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_Task.csv', header = FALSE)

# look at age groups 
ind=demo$Age>18 & demo$Age <45
z_target= t(scale(t(psd_task[ind,])))
z_database= t(scale(t(psd_rest[ind,])))
icc = c()


n = length(ind)
k = 2
df_b = n-1
df_w = n*(k-1)


for (i_edge in 1:length(psd_rest)){
  x= data.frame(unlist(z_target[,i_edge]),unlist(z_database[,i_edge]) )
  x_w_mean =  rowMeans(x)
  x_g_mean = mean(unlist(x))
  ss_t = sum(((x - x_g_mean)^2))
  ss_w = sum((x - (x_w_mean))^2)
  ss_b = ss_t - ss_w
  ms_b = ss_b / df_b
  ms_w = ss_w / df_w
  icc[i_edge] = (ms_b - ms_w) / (ms_b + ((k-1)*ms_w))
  
  
}

icc_mat_young <- matrix(icc, nrow = 68, byrow = TRUE)


# look at age groups 
ind=demo$Age>=65 & demo$Age <90
z_target= t(scale(t(psd_task[ind,])))
z_database= t(scale(t(psd_rest[ind,])))
icc = c()


n = length(ind)
k = 2
df_b = n-1
df_w = n*(k-1)


for (i_edge in 1:length(psd_rest)){
  x= data.frame(unlist(z_target[,i_edge]),unlist(z_database[,i_edge]) )
  x_w_mean =  rowMeans(x)
  x_g_mean = mean(unlist(x))
  ss_t = sum(((x - x_g_mean)^2))
  ss_w = sum((x - (x_w_mean))^2)
  ss_b = ss_t - ss_w
  ms_b = ss_b / df_b
  ms_w = ss_w / df_w
  icc[i_edge] = (ms_b - ms_w) / (ms_b + ((k-1)*ms_w))
  
  
}

icc_mat_older <- matrix(icc, nrow = 68, byrow = TRUE)

icc_mat= icc_mat_older- icc_mat_young

X=data.frame(delta= rowMeans(icc_mat[,1:8]),theta= rowMeans(icc_mat[,9:16]),alpha= rowMeans(icc_mat[,17:26]),beta= rowMeans(icc_mat[,27:60]), gamma= rowMeans(icc_mat[,61:101]), hgamma= rowMeans(icc_mat[,102:300]))


# run PCA
library(factoextra)

X_scale= scale(X, center = TRUE, scale = TRUE)
pca_result <- prcomp(X_scale, scale = TRUE)
summary(pca_result)
fviz_eig(pca_result, ncp = 7)

cc=cor.test(colMeans(SVM), pca_result$x[,1])

lm1=lm(scale(colMeans(SVM)) ~scale(pca_result$x[,1]))

acer_subscales= data.frame(acer_sub = 'attention', corr2PCA= cc$estimate, corr2PCA_CI_lower= cc$conf.int[1], corr2PCA_CI_upper= cc$conf.int[2], pval2PCA=  cc$p.value, mean_corr_decode= mean(rowMeans(SVM)), max_corr_decode= max(colMeans(SVM)), AIC= AIC(lm1))

SVM=read.csv( '~/Documents/CAMCAN_outputs/decode_SVR_ACER_80_20_nofluency.csv')
SVM=SVM[,-1]

df=read.csv('~/Documents//Alex_fingerprinting/PSD_ICC_orig_PD_new_PKD2.csv', header = FALSE, stringsAsFactors = FALSE)
colnames(df)[1]='region'
df=df[,1:2]
df$hemi =''
df$hemi[seq(2,68,2)] ='right'
df$hemi[seq(1,67,2)] ='left'
df$R=colMeans(SVM)

quantiles_decode=apply(SVM, 2, quantile, c(0.025, 0.975))
df$quantile_sig= quantiles_decode[1,] >0 & quantiles_decode[2,] >0


someData2= df
colnames(someData2)[2]='decoding corr'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'

someData2$R[someData2$R>0.2]=0.2
someData2$R[someData2$R<0]=0

ggplot(someData2) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = `R`)) +
  #scale_fill_distiller(palette = "RdBu"
  #                     , limits = c(0.4, 0.9))+
  viridis::scale_fill_viridis(option = 'viridis', limits = c(0.0, 0.2))+
  #scale_fill_gradient2(low="white", mid="#EC352F", high="#6C1917", 
  #                     midpoint=0.6,   
  #                     limits=c(0.4, 0.9 ))+
  theme_void() 

ggsave('~/Documents/CAMCAN_outputs/figures/decoding_of_acer_topo_80_20_NOFLUENCY.pdf', device = "pdf")


cc=cor.test(colMeans(SVM), pca_result$x[,1])

lm1=lm(scale(colMeans(SVM)) ~scale(pca_result$x[,1]))

acer_subscales2= data.frame(acer_sub = 'fluency', corr2PCA= cc$estimate, corr2PCA_CI_lower= cc$conf.int[1], corr2PCA_CI_upper= cc$conf.int[2], pval2PCA=  cc$p.value, mean_corr_decode= mean(rowMeans(SVM)), max_corr_decode= max(colMeans(SVM)), AIC= AIC(lm1))

acer_subscales= rbind(acer_subscales, acer_subscales2)



SVM=read.csv( '~/Documents/CAMCAN_outputs/decode_SVR_ACER_80_20_nolanguage.csv')
SVM=SVM[,-1]

df=read.csv('~/Documents//Alex_fingerprinting/PSD_ICC_orig_PD_new_PKD2.csv', header = FALSE, stringsAsFactors = FALSE)
colnames(df)[1]='region'
df=df[,1:2]
df$hemi =''
df$hemi[seq(2,68,2)] ='right'
df$hemi[seq(1,67,2)] ='left'
df$R=colMeans(SVM)

quantiles_decode=apply(SVM, 2, quantile, c(0.025, 0.975))
df$quantile_sig= quantiles_decode[1,] >0 & quantiles_decode[2,] >0


someData2= df
colnames(someData2)[2]='decoding corr'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'

someData2$R[someData2$R>0.2]=0.2
someData2$R[someData2$R<0]=0

ggplot(someData2) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = `R`)) +
  #scale_fill_distiller(palette = "RdBu"
  #                     , limits = c(0.4, 0.9))+
  viridis::scale_fill_viridis(option = 'viridis', limits = c(0.0, 0.2))+
  #scale_fill_gradient2(low="white", mid="#EC352F", high="#6C1917", 
  #                     midpoint=0.6,   
  #                     limits=c(0.4, 0.9 ))+
  theme_void() 

ggsave('~/Documents/CAMCAN_outputs/figures/decoding_of_acer_topo_80_20_NOLANGUAGE.pdf', device = "pdf")


cc=cor.test(colMeans(SVM), pca_result$x[,1])

lm1=lm(scale(colMeans(SVM)) ~scale(pca_result$x[,1]))

acer_subscales2= data.frame(acer_sub = 'language', corr2PCA= cc$estimate, corr2PCA_CI_lower= cc$conf.int[1], corr2PCA_CI_upper= cc$conf.int[2], pval2PCA=  cc$p.value, mean_corr_decode= mean(rowMeans(SVM)), max_corr_decode= max(colMeans(SVM)), AIC= AIC(lm1))

acer_subscales= rbind(acer_subscales, acer_subscales2)


SVM=read.csv( '~/Documents/CAMCAN_outputs/decode_SVR_ACER_80_20_nomemory.csv')
SVM=SVM[,-1]

df=read.csv('~/Documents//Alex_fingerprinting/PSD_ICC_orig_PD_new_PKD2.csv', header = FALSE, stringsAsFactors = FALSE)
colnames(df)[1]='region'
df=df[,1:2]
df$hemi =''
df$hemi[seq(2,68,2)] ='right'
df$hemi[seq(1,67,2)] ='left'
df$R=colMeans(SVM)

quantiles_decode=apply(SVM, 2, quantile, c(0.025, 0.975))
df$quantile_sig= quantiles_decode[1,] >0 & quantiles_decode[2,] >0


someData2= df
colnames(someData2)[2]='decoding corr'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'

someData2$R[someData2$R>0.2]=0.2
someData2$R[someData2$R<0]=0

ggplot(someData2) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = `R`)) +
  #scale_fill_distiller(palette = "RdBu"
  #                     , limits = c(0.4, 0.9))+
  viridis::scale_fill_viridis(option = 'viridis', limits = c(0.0, 0.2))+
  #scale_fill_gradient2(low="white", mid="#EC352F", high="#6C1917", 
  #                     midpoint=0.6,   
  #                     limits=c(0.4, 0.9 ))+
  theme_void() 

ggsave('~/Documents/CAMCAN_outputs/figures/decoding_of_acer_topo_80_20_NOMEMORY.pdf', device = "pdf")


cc=cor.test(colMeans(SVM), pca_result$x[,1])

lm1=lm(scale(colMeans(SVM)) ~scale(pca_result$x[,1]))

acer_subscales2= data.frame(acer_sub = 'memory', corr2PCA= cc$estimate, corr2PCA_CI_lower= cc$conf.int[1], corr2PCA_CI_upper= cc$conf.int[2], pval2PCA=  cc$p.value, mean_corr_decode= mean(rowMeans(SVM)), max_corr_decode= max(colMeans(SVM)), AIC= AIC(lm1))

acer_subscales= rbind(acer_subscales, acer_subscales2)

SVM=read.csv( '~/Documents/CAMCAN_outputs/decode_SVR_ACER_80_20_novisuo.csv')
SVM=SVM[,-1]

df=read.csv('~/Documents//Alex_fingerprinting/PSD_ICC_orig_PD_new_PKD2.csv', header = FALSE, stringsAsFactors = FALSE)
colnames(df)[1]='region'
df=df[,1:2]
df$hemi =''
df$hemi[seq(2,68,2)] ='right'
df$hemi[seq(1,67,2)] ='left'
df$R=colMeans(SVM)

quantiles_decode=apply(SVM, 2, quantile, c(0.025, 0.975))
df$quantile_sig= quantiles_decode[1,] >0 & quantiles_decode[2,] >0


someData2= df
colnames(someData2)[2]='decoding corr'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'

someData2$R[someData2$R>0.2]=0.2
someData2$R[someData2$R<0]=0

ggplot(someData2) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = `R`)) +
  #scale_fill_distiller(palette = "RdBu"
  #                     , limits = c(0.4, 0.9))+
  viridis::scale_fill_viridis(option = 'viridis', limits = c(0.0, 0.2))+
  #scale_fill_gradient2(low="white", mid="#EC352F", high="#6C1917", 
  #                     midpoint=0.6,   
  #                     limits=c(0.4, 0.9 ))+
  theme_void() 

ggsave('~/Documents/CAMCAN_outputs/figures/decoding_of_acer_topo_80_20_NOVISUO.pdf', device = "pdf")


cc=cor.test(colMeans(SVM), pca_result$x[,1])

lm1=lm(scale(colMeans(SVM)) ~scale(pca_result$x[,1]))

acer_subscales2= data.frame(acer_sub = 'visuo', corr2PCA= cc$estimate, corr2PCA_CI_lower= cc$conf.int[1], corr2PCA_CI_upper= cc$conf.int[2], pval2PCA=  cc$p.value, mean_corr_decode= mean(rowMeans(SVM)), max_corr_decode= max(colMeans(SVM)), AIC= AIC(lm1))

acer_subscales= rbind(acer_subscales, acer_subscales2)




SVM=read.csv( '~/Documents/CAMCAN_outputs/decode_SVR_ACER_80_20_new.csv')
SVM=SVM[,-1]

df=read.csv('~/Documents//Alex_fingerprinting/PSD_ICC_orig_PD_new_PKD2.csv', header = FALSE, stringsAsFactors = FALSE)
colnames(df)[1]='region'
df=df[,1:2]
df$hemi =''
df$hemi[seq(2,68,2)] ='right'
df$hemi[seq(1,67,2)] ='left'
df$R=colMeans(SVM)

quantiles_decode=apply(SVM, 2, quantile, c(0.025, 0.975))
df$quantile_sig= quantiles_decode[1,] >0 & quantiles_decode[2,] >0


someData2= df
colnames(someData2)[2]='decoding corr'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'

someData2$R[someData2$R>0.2]=0.2
someData2$R[someData2$R<0]=0

ggplot(someData2) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = `R`)) +
  #scale_fill_distiller(palette = "RdBu"
  #                     , limits = c(0.4, 0.9))+
  viridis::scale_fill_viridis(option = 'viridis', limits = c(0.0, 0.2))+
  #scale_fill_gradient2(low="white", mid="#EC352F", high="#6C1917", 
  #                     midpoint=0.6,   
  #                     limits=c(0.4, 0.9 ))+
  theme_void() 


cc=cor.test(colMeans(SVM), pca_result$x[,1])

lm1=lm(scale(colMeans(SVM)) ~scale(pca_result$x[,1]))

acer_subscales2= data.frame(acer_sub = 'all', corr2PCA= cc$estimate, corr2PCA_CI_lower= cc$conf.int[1], corr2PCA_CI_upper= cc$conf.int[2], pval2PCA=  cc$p.value, mean_corr_decode= mean(rowMeans(SVM)), max_corr_decode= max(colMeans(SVM)), AIC= AIC(lm1))
acer_subscales= rbind(acer_subscales, acer_subscales2)

acer_subscales$diff_in_corr_2PCA=  acer_subscales$corr2PCA[6] -acer_subscales$corr2PCA

# make plot

acer_subscales$diff_in_AIC_2PCA=  acer_subscales$AIC[6] -acer_subscales$AIC




ggplot(acer_subscales, aes(x=acer_sub , y = corr2PCA, colour= cbbPalette[2], fill= cbbPalette[2])) + coord_flip(ylim=c(-0.1,0.6)) + geom_hline(yintercept = 0, linetype="dashed", color = "grey", size=1) +
  geom_errorbar(colour="#000000", aes(ymin=corr2PCA_CI_lower, ymax=corr2PCA_CI_upper),  width=.2, position=position_dodge(.9)) + geom_point(stat='identity',position=position_dodge(.9), size= 10)   + scale_fill_manual(values=cbbPalette[3])  + scale_color_manual(values=cbbPalette[2]) + theme_classic2() + xlab("") + ylab(" correlation (r)")+
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"), legend.position = "none")  

ggsave('~/Documents/CAMCAN_outputs/figures/SVR_correlation_subscales.pdf', device = "pdf", height = 3.5, width = 5)


acer_subscales_noall=acer_subscales[acer_subscales$acer_sub != 'all',]
acer_subscales_noall$diff_in_AIC_2PCA= -1*acer_subscales_noall$diff_in_AIC_2PCA

ggplot(acer_subscales_noall, aes(x=acer_sub , y = diff_in_AIC_2PCA,group=1, fill=acer_sub)) + geom_col() + geom_hline(yintercept = c(-2,2), linetype="dashed", color = "grey", size=1) + 
   scale_fill_manual(values=cbbPalette)  + theme_classic2() +   xlab("") + ylab(" AIC")+
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"), legend.position = "none") + ylim(c(-8,8)) + coord_flip()

ggsave('~/Documents/CAMCAN_outputs/figures/SVR_delta_AIC_subscales.pdf', device = "pdf", height = 3.5, width = 5)




```








``` {r plotting SVR of cognition 70 -30 }

# set colour palette
cbbPalette= c("#DBF132", "#15A705",'#4F89E0',"#D81B99","#268236", '#4d3d87','#593d80', '#3b49e3')

SVM=read.csv( '~/Documents/CAMCAN_outputs/decode_SVR_ACER_70_30.csv')
SVM=SVM[,-1]

df=read.csv('~/Documents//Alex_fingerprinting/PSD_ICC_orig_PD_new_PKD2.csv', header = FALSE, stringsAsFactors = FALSE)
colnames(df)[1]='region'
df=df[,1:2]
df$hemi =''
df$hemi[seq(2,68,2)] ='right'
df$hemi[seq(1,67,2)] ='left'
df$R=colMeans(SVM)

quantiles_decode=apply(SVM, 2, quantile, c(0.025, 0.975))
df$quantile_sig= quantiles_decode[1,] >0 & quantiles_decode[2,] >0



someData2= df
colnames(someData2)[2]='decoding corr'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'

ggplot(someData2) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = `R`)) +
  #scale_fill_distiller(palette = "RdBu"
  #                     , limits = c(0.4, 0.9))+
  viridis::scale_fill_viridis(option = 'viridis', limits = c(0.0, 0.2))+
  #scale_fill_gradient2(low="white", mid="#EC352F", high="#6C1917", 
  #                     midpoint=0.6,   
  #                     limits=c(0.4, 0.9 ))+
  theme_void() 

ggsave('~/Documents/CAMCAN_outputs/figures/decoding_of_acer_topo_70_30.pdf', device = "pdf")


someData2$quantile_sig=as.numeric(someData2$quantile_sig)

ggplot(someData2) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = `quantile_sig`)) +

  scale_fill_gradient2(low="#DCD2D9", mid="#EC352F", high="#D81B99",
                      midpoint=0.5,
                      limits=c(0, 1 ))+
  theme_void() 

ggsave('~/Documents/CAMCAN_outputs/figures/decoding_of_acer_thresholded_maps_70_30.pdf', device = "pdf")


# make hist of regions

data4plot= stack(SVM[,someData2$quantile_sig==1])

data4plot$hemi = plyr::mapvalues(data4plot$ind, unique(data4plot$ind), someData2$hemi[someData2$quantile_sig==1])

data4plot$region = plyr::mapvalues(data4plot$ind, unique(data4plot$ind), someData2$region[someData2$quantile_sig==1])


ggplot(data4plot, aes(values, color= hemi, fill=hemi, alpha=0.5)) +
  geom_density(aes( color= hemi, fill=hemi), alpha= 0.5, bins = 20) +
  #geom_histogram(aes(y=..density.., color= group, fill=group), alpha= 0.5, bins = 20) +
  theme_minimal() +
  labs(x = "prediction observed acer correlation", y = "denstity")  + theme_classic2() +
  ggtitle("") + scale_fill_manual(values=cbbPalette[c(1,4)]) + scale_color_manual(values=cbbPalette[c(1,4)]) + facet_wrap(~region, nrow = 3)

ggsave('~/Documents/CAMCAN_outputs/figures/decoding_of_acer_histograms_of_sig_regions_70_30.pdf', device = "pdf")

# set colour palette
cbbPalette= c("#DBF132", "#15A705",'#4F89E0',"#D81B99",'#1908AF', '#9211E6',"#268236", '#4d3d87','#593d80', '#3b49e3')

demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]

psd_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_Rest.csv', header = FALSE)
psd_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_Task.csv', header = FALSE)


# look at age groups 
ind=demo$Age>18 & demo$Age <45
z_target= t(scale(t(psd_task[ind,])))
z_database= t(scale(t(psd_rest[ind,])))
icc = c()


n = length(ind)
k = 2
df_b = n-1
df_w = n*(k-1)


for (i_edge in 1:length(psd_rest)){
  x= data.frame(unlist(z_target[,i_edge]),unlist(z_database[,i_edge]) )
  x_w_mean =  rowMeans(x)
  x_g_mean = mean(unlist(x))
  ss_t = sum(((x - x_g_mean)^2))
  ss_w = sum((x - (x_w_mean))^2)
  ss_b = ss_t - ss_w
  ms_b = ss_b / df_b
  ms_w = ss_w / df_w
  icc[i_edge] = (ms_b - ms_w) / (ms_b + ((k-1)*ms_w))
  
  
}

icc_mat_young <- matrix(icc, nrow = 68, byrow = TRUE)


# look at age groups 
ind=demo$Age>=65 & demo$Age <90
z_target= t(scale(t(psd_task[ind,])))
z_database= t(scale(t(psd_rest[ind,])))
icc = c()


n = length(ind)
k = 2
df_b = n-1
df_w = n*(k-1)


for (i_edge in 1:length(psd_rest)){
  x= data.frame(unlist(z_target[,i_edge]),unlist(z_database[,i_edge]) )
  x_w_mean =  rowMeans(x)
  x_g_mean = mean(unlist(x))
  ss_t = sum(((x - x_g_mean)^2))
  ss_w = sum((x - (x_w_mean))^2)
  ss_b = ss_t - ss_w
  ms_b = ss_b / df_b
  ms_w = ss_w / df_w
  icc[i_edge] = (ms_b - ms_w) / (ms_b + ((k-1)*ms_w))
  
  
}

icc_mat_older <- matrix(icc, nrow = 68, byrow = TRUE)

icc_mat= icc_mat_older - icc_mat_young


X=data.frame(delta= rowMeans(icc_mat[,1:8]),theta= rowMeans(icc_mat[,9:16]),alpha= rowMeans(icc_mat[,17:26]),beta= rowMeans(icc_mat[,27:60]), gamma= rowMeans(icc_mat[,61:101]), hgamma= rowMeans(icc_mat[,102:300]))


# run PCA
library(factoextra)

X_scale= scale(X, center = TRUE, scale = TRUE)
pca_result <- prcomp(X_scale, scale = TRUE)


cor.test(someData2$R, pca_result$x[,1])


lm3=lm(someData2$R ~ pca_result$x[,1], someData2)
summary(lm3)

ggplot(someData2, aes(x=someData2$R , y = pca_result$x[,1], fill=cbbPalette[2])) + 
  geom_jitter(colour = cbbPalette[2]) + 
  stat_smooth(method = "lm", colour = 'black',fullrange = T, fill=cbbPalette[2]) +
  labs(title = paste("Adj R2 = ", signif(summary(lm3)$adj.r.squared, 5),
                     "Intercept =", signif(lm3$coef[[1]],5 ),
                     " Slope =", signif(lm3$coef[[2]], 5),
                     " P =", signif(summary(lm3)$coef[2,4], 5) )) + scale_fill_manual(values=cbbPalette[2])  + theme_classic2() +   xlab("decoding correlation (r)") + ylab("ICC")+
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"), legend.position = "none") 

ggsave('~/Documents/CAMCAN_outputs/figures/SVR_ACER_ICC_broadband_70_30.pdf', device = "pdf", width=5, height=5, dpi=800)


```



``` {r plotting SVR of cognition rand permutations }

# set colour palette
cbbPalette= c("#DBF132", "#15A705",'#4F89E0',"#D81B99","#268236", '#4d3d87','#593d80', '#3b49e3')

SVM=read.csv( '~/Documents/CAMCAN_outputs/decode_SVR_ACER_random_perm.csv')
SVM=SVM[,-1]

df=read.csv('~/Documents//Alex_fingerprinting/PSD_ICC_orig_PD_new_PKD2.csv', header = FALSE, stringsAsFactors = FALSE)
colnames(df)[1]='region'
df=df[,1:2]
df$hemi =''
df$hemi[seq(2,68,2)] ='right'
df$hemi[seq(1,67,2)] ='left'
df$R=colMeans(SVM)

quantiles_decode=apply(SVM, 2, quantile, c(0.025, 0.975))
df$quantile_sig= quantiles_decode[1,] >0 & quantiles_decode[2,] >0



someData2= df
colnames(someData2)[2]='decoding corr'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'

ggplot(someData2) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = `R`)) +
  #scale_fill_distiller(palette = "RdBu"
  #                     , limits = c(0.4, 0.9))+
  viridis::scale_fill_viridis(option = 'viridis', limits = c(-0.05, 0.05))+
  #scale_fill_gradient2(low="white", mid="#EC352F", high="#6C1917", 
  #                     midpoint=0.6,   
  #                     limits=c(0.4, 0.9 ))+
  theme_void() 

ggsave('~/Documents/CAMCAN_outputs/figures/decoding_of_acer_topo_permutations.pdf', device = "pdf")


# look at age groups 
demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]

psd_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_Rest.csv', header = FALSE)
psd_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_Task.csv', header = FALSE)


z_target= t(scale(t(psd_task)))
z_database= t(scale(t(psd_rest)))
icc = c()

ind=demo$Age>18 & demo$Age <45
z_target= t(scale(t(psd_task[ind,])))
z_database= t(scale(t(psd_rest[ind,])))
icc = c()


n = length(ind)
k = 2
df_b = n-1
df_w = n*(k-1)


for (i_edge in 1:length(psd_rest)){
  x= data.frame(unlist(z_target[,i_edge]),unlist(z_database[,i_edge]) )
  x_w_mean =  rowMeans(x)
  x_g_mean = mean(unlist(x))
  ss_t = sum(((x - x_g_mean)^2))
  ss_w = sum((x - (x_w_mean))^2)
  ss_b = ss_t - ss_w
  ms_b = ss_b / df_b
  ms_w = ss_w / df_w
  icc[i_edge] = (ms_b - ms_w) / (ms_b + ((k-1)*ms_w))
  
  
}

icc_mat_young <- matrix(icc, nrow = 68, byrow = TRUE)


# look at age groups 
ind=demo$Age>=65 & demo$Age <90
z_target= t(scale(t(psd_task[ind,])))
z_database= t(scale(t(psd_rest[ind,])))
icc = c()


n = length(ind)
k = 2
df_b = n-1
df_w = n*(k-1)


for (i_edge in 1:length(psd_rest)){
  x= data.frame(unlist(z_target[,i_edge]),unlist(z_database[,i_edge]) )
  x_w_mean =  rowMeans(x)
  x_g_mean = mean(unlist(x))
  ss_t = sum(((x - x_g_mean)^2))
  ss_w = sum((x - (x_w_mean))^2)
  ss_b = ss_t - ss_w
  ms_b = ss_b / df_b
  ms_w = ss_w / df_w
  icc[i_edge] = (ms_b - ms_w) / (ms_b + ((k-1)*ms_w))
  
  
}

icc_mat_older <- matrix(icc, nrow = 68, byrow = TRUE)


icc_diff= icc_mat_older- icc_mat_young

cor.test(someData2$R, rowMeans(icc_diff))

icc_diff= data.frame(broadband= rowMeans(icc_diff),
                     delta= rowMeans(icc_diff[,1:8]),
                     theta= rowMeans(icc_diff[,9:16]),
                     alpha=rowMeans(icc_diff[,17:26]),
                     beta=rowMeans(icc_diff[,27:60]),
                     gamma=rowMeans(icc_diff[,61:101]),
                     hgamma=rowMeans(icc_diff[,102:300]))


hist(apply(SVM, 1, cor, icc_diff$delta))

rand_corr_delta= apply(SVM, 1, cor, icc_diff$delta)
rand_corr_theta= apply(SVM, 1, cor, icc_diff$theta)
rand_corr_alpha= apply(SVM, 1, cor, icc_diff$alpha)
rand_corr_beta= apply(SVM, 1, cor, icc_diff$beta)


quantile(rand_corr_delta, 0.975)
quantile(rand_corr_theta, 0.975)
quantile(rand_corr_alpha, 0.975)
quantile(rand_corr_alpha, 0.025)
quantile(rand_corr_beta, 0.975)


data4plot= data.frame(rand_corr= c(rand_corr_delta, rand_corr_theta, rand_corr_alpha, rand_corr_beta), band= rep(c('delta','theta', 'alpha', 'beta'), each=1000))

data4plot$band= factor(data4plot$band, levels=c('delta','theta', 'alpha', 'beta') )

data_vline <- data.frame(band = c('delta','theta', 'alpha', 'beta'),
                         vline = c(0.3467593, 0.2545567, -0.2471010, 0.2714626))
data_vline$band= factor(data_vline$band, levels=c('delta','theta', 'alpha', 'beta') )

ggplot(data4plot, aes(rand_corr, color= band, fill=band, alpha=0.5)) +
  geom_density(aes( color= band, fill=band), alpha= 0.5, bins = 20) +
  #geom_histogram(aes(y=..density.., color= group, fill=group), alpha= 0.5, bins = 20) +
  theme_minimal() +
  labs(x = "prediction observed acer correlation", y = "denstity")  + theme_classic2() +
  ggtitle("") + scale_fill_manual(values=cbbPalette[c(1:4)]) + scale_color_manual(values=cbbPalette[c(1:4)]) + facet_wrap(~band, nrow = 3) +   geom_vline(data = data_vline,
             aes(xintercept = vline))

ggsave('~/Documents/CAMCAN_outputs/figures/decoding_of_acer_rand_perm_histograms_of_bands.pdf', device = "pdf")





cor.test(someData2$R, icc_diff$delta)

someData2$ICC_scaled= scale(icc_diff$delta)
lm3=lm(`R_scaled` ~ ICC_scaled, someData2)
summary(lm3)
coeff=rbind(coeff, data.frame(coef=coef(lm3)[2], CI_low=confint(lm3)[2,1],CI_up=confint(lm3)[2,2] ))


cor.test(someData2$R, icc_diff$theta)

someData2$ICC_scaled= scale(icc_diff$theta)
lm3=lm(`R_scaled` ~ ICC_scaled, someData2)
summary(lm3)
coeff=rbind(coeff, data.frame(coef=coef(lm3)[2], CI_low=confint(lm3)[2,1],CI_up=confint(lm3)[2,2] ))

cor.test(someData2$R, icc_diff$alpha)

someData2$ICC_scaled= scale(icc_diff$alpha)
lm3=lm(`R_scaled` ~ ICC_scaled, someData2)
summary(lm3)
coeff=rbind(coeff, data.frame(coef=coef(lm3)[2], CI_low=confint(lm3)[2,1],CI_up=confint(lm3)[2,2] ))

cor.test(someData2$R, icc_diff$beta)

someData2$ICC_scaled= scale(icc_diff$beta)
lm3=lm(`R_scaled` ~ ICC_scaled, someData2)
summary(lm3)
coeff=rbind(coeff, data.frame(coef=coef(lm3)[2], CI_low=confint(lm3)[2,1],CI_up=confint(lm3)[2,2] ))

cor.test(someData2$R, icc_diff$gamma)

someData2$ICC_scaled= scale(icc_diff$gamma)
lm3=lm(`R_scaled` ~ ICC_scaled, someData2)
summary(lm3)
coeff=rbind(coeff, data.frame(coef=coef(lm3)[2], CI_low=confint(lm3)[2,1],CI_up=confint(lm3)[2,2] ))

cor.test(someData2$R, icc_diff$hgamma)

someData2$ICC_scaled= scale(icc_diff$hgamma)
lm3=lm(`R_scaled` ~ ICC_scaled, someData2)
summary(lm3)
coeff=rbind(coeff, data.frame(coef=coef(lm3)[2], CI_low=confint(lm3)[2,1],CI_up=confint(lm3)[2,2] ))

coeff$band= c('broadband', 'delta', 'theta', 'alpha', 'beta', 'gamma', 'high gamma')
coeff$band = factor(coeff$band, levels = c('high gamma', 'gamma', 'beta', 'alpha', 'theta', 'delta','broadband'))

ggplot(coeff, aes(x=band , y = coef, colour= cbbPalette[2], fill= cbbPalette[2])) + coord_flip(ylim=c(-0.6,0.6)) + geom_hline(yintercept = 0, linetype="dashed", color = "grey", size=1) +
  geom_errorbar(colour="#000000", aes(ymin=CI_low, ymax=CI_up),  width=.2, position=position_dodge(.9)) + geom_point(stat='identity',position=position_dodge(.9), size= 10)   + scale_fill_manual(values=cbbPalette[3])  + scale_color_manual(values=cbbPalette[2]) + theme_classic2() + xlab("") + ylab(" correlation (r)")+
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"), legend.position = "none")  

ggsave('~/Documents/CAMCAN_outputs/figures/SVR_correlation_between_decoding_and_delta_ICC.pdf', device = "pdf", height = 3.5, width = 5)



```





``` {r plotting SVR of cognition residuals }

# set colour palette
cbbPalette= c("#DBF132", "#15A705",'#4F89E0',"#D81B99","#268236", '#4d3d87','#593d80', '#3b49e3')

SVM=read.csv( '~/Documents/CAMCAN_outputs/decode_SVR_ACER_80_20_residuals_artifacts.csv')
SVM=SVM[,-1]

df=read.csv('~/Documents//Alex_fingerprinting/PSD_ICC_orig_PD_new_PKD2.csv', header = FALSE, stringsAsFactors = FALSE)
colnames(df)[1]='region'
df=df[,1:2]
df$hemi =''
df$hemi[seq(2,68,2)] ='right'
df$hemi[seq(1,67,2)] ='left'
df$R=colMeans(SVM)

quantiles_decode=apply(SVM, 2, quantile, c(0.025, 0.975))
df$quantile_sig= quantiles_decode[1,] >0 & quantiles_decode[2,] >0



someData2= df
colnames(someData2)[2]='decoding corr'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'

ggplot(someData2) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = `R`)) +
  #scale_fill_distiller(palette = "RdBu"
  #                     , limits = c(0.4, 0.9))+
  viridis::scale_fill_viridis(option = 'viridis', limits = c(0.0, 0.2))+
  #scale_fill_gradient2(low="white", mid="#EC352F", high="#6C1917", 
  #                     midpoint=0.6,   
  #                     limits=c(0.4, 0.9 ))+
  theme_void() 

ggsave('~/Documents/CAMCAN_outputs/figures/decoding_of_acer_topo_80_20.pdf', device = "pdf")


someData2$quantile_sig=as.numeric(someData2$quantile_sig)

ggplot(someData2) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = `quantile_sig`)) +

  scale_fill_gradient2(low="#DCD2D9", mid="#EC352F", high="#D81B99",
                      midpoint=0.5,
                      limits=c(0, 1 ))+
  theme_void() 

ggsave('~/Documents/CAMCAN_outputs/figures/decoding_of_acer_thresholded_maps.pdf', device = "pdf")


# make hist of regions

data4plot= stack(SVM[,someData2$quantile_sig==1])

data4plot$hemi = plyr::mapvalues(data4plot$ind, unique(data4plot$ind), someData2$hemi[someData2$quantile_sig==1])

data4plot$region = plyr::mapvalues(data4plot$ind, unique(data4plot$ind), someData2$region[someData2$quantile_sig==1])


ggplot(data4plot, aes(values, color= hemi, fill=hemi, alpha=0.5)) +
  geom_density(aes( color= hemi, fill=hemi), alpha= 0.5, bins = 20) +
  #geom_histogram(aes(y=..density.., color= group, fill=group), alpha= 0.5, bins = 20) +
  theme_minimal() +
  labs(x = "prediction observed acer correlation", y = "denstity")  + theme_classic2() +
  ggtitle("") + scale_fill_manual(values=cbbPalette[c(1,4)]) + scale_color_manual(values=cbbPalette[c(1,4)]) + facet_wrap(~region, nrow = 3)

ggsave('~/Documents/CAMCAN_outputs/figures/decoding_of_acer_histograms_of_sig_regions.pdf', device = "pdf")

# compute diff in ICC
demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]

psd_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_Rest.csv', header = FALSE)
psd_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_Task.csv', header = FALSE)


# look at age groups 
ind=demo$Age>18 & demo$Age <45
z_target= t(scale(t(psd_task[ind,])))
z_database= t(scale(t(psd_rest[ind,])))
icc = c()


n = length(ind)
k = 2
df_b = n-1
df_w = n*(k-1)


for (i_edge in 1:length(psd_rest)){
  x= data.frame(unlist(z_target[,i_edge]),unlist(z_database[,i_edge]) )
  x_w_mean =  rowMeans(x)
  x_g_mean = mean(unlist(x))
  ss_t = sum(((x - x_g_mean)^2))
  ss_w = sum((x - (x_w_mean))^2)
  ss_b = ss_t - ss_w
  ms_b = ss_b / df_b
  ms_w = ss_w / df_w
  icc[i_edge] = (ms_b - ms_w) / (ms_b + ((k-1)*ms_w))
  
  
}

icc_mat_young <- matrix(icc, nrow = 68, byrow = TRUE)


# look at age groups 
ind=demo$Age>=65 & demo$Age <90
z_target= t(scale(t(psd_task[ind,])))
z_database= t(scale(t(psd_rest[ind,])))
icc = c()


n = length(ind)
k = 2
df_b = n-1
df_w = n*(k-1)


for (i_edge in 1:length(psd_rest)){
  x= data.frame(unlist(z_target[,i_edge]),unlist(z_database[,i_edge]) )
  x_w_mean =  rowMeans(x)
  x_g_mean = mean(unlist(x))
  ss_t = sum(((x - x_g_mean)^2))
  ss_w = sum((x - (x_w_mean))^2)
  ss_b = ss_t - ss_w
  ms_b = ss_b / df_b
  ms_w = ss_w / df_w
  icc[i_edge] = (ms_b - ms_w) / (ms_b + ((k-1)*ms_w))
  
  
}

icc_mat_older <- matrix(icc, nrow = 68, byrow = TRUE)


icc_diff= icc_mat_older- icc_mat_young

cor.test(someData2$R, rowMeans(icc_diff))

someData2= df
someData2$ICC= rowMeans(icc_diff)
colnames(someData2)[2]='decoding corr'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'

someData2$ICC[someData2$ICC>.1]= 0.1

ggplot(someData2) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = `ICC`)) +
  #scale_fill_distiller(palette = "RdBu"
  #                     , limits = c(0.4, 0.9))+
  viridis::scale_fill_viridis(option = 'viridis', limits = c(-0.1, 0.1))+
  #scale_fill_gradient2(low="white", mid="#EC352F", high="#6C1917", 
  #                     midpoint=0.6,   
  #                     limits=c(0.4, 0.9 ))+
  theme_void() 

ggsave('~/Documents/CAMCAN_outputs/figures/broadband_diff_ICC.pdf', device = "pdf")



coeff= data.frame()

someData2$R_scaled= scale(someData2$R)
someData2$ICC_scaled= scale(someData2$ICC)

lm3=lm(`R_scaled` ~ ICC_scaled, someData2)
summary(lm3)
coeff=rbind(coeff, data.frame(coef=coef(lm3)[2], CI_low=confint(lm3)[2,1],CI_up=confint(lm3)[2,2] ))

ggplot(someData2, aes(x=R , y = ICC, fill=cbbPalette[4])) + 
  geom_jitter(colour = cbbPalette[4]) + 
  stat_smooth(method = "lm", colour = 'black',fullrange = T, fill=cbbPalette[4]) +
  labs(title = paste("Adj R2 = ", signif(summary(lm3)$adj.r.squared, 5),
                     "Intercept =", signif(lm3$coef[[1]],5 ),
                     " Slope =", signif(lm3$coef[[2]], 5),
                     " P =", signif(summary(lm3)$coef[2,4], 5) )) + scale_fill_manual(values=cbbPalette[4])  + theme_classic2() +   xlab("decoding correlation (r)") + ylab("ICC")+
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"), legend.position = "none") 

ggsave('~/Documents/CAMCAN_outputs/figures/SVR_ACER_ICC_broadband.pdf', device = "pdf", width=5, height=5, dpi=800)

icc_diff= icc_mat_older- icc_mat_young

icc_diff= data.frame(delta= rowMeans(icc_diff[,1:8]),
                     theta= rowMeans(icc_diff[,9:16]),
                     alpha=rowMeans(icc_diff[,17:26]),
                     beta=rowMeans(icc_diff[,27:60]),
                     gamma=rowMeans(icc_diff[,61:101]),
                     hgamma=rowMeans(icc_diff[,102:300]))


cor.test(someData2$R, icc_diff$delta)

someData2$ICC_scaled= scale(icc_diff$delta)
lm3=lm(`R_scaled` ~ ICC_scaled, someData2)
summary(lm3)
coeff=rbind(coeff, data.frame(coef=coef(lm3)[2], CI_low=confint(lm3)[2,1],CI_up=confint(lm3)[2,2] ))


cor.test(someData2$R, icc_diff$theta)

someData2$ICC_scaled= scale(icc_diff$theta)
lm3=lm(`R_scaled` ~ ICC_scaled, someData2)
summary(lm3)
coeff=rbind(coeff, data.frame(coef=coef(lm3)[2], CI_low=confint(lm3)[2,1],CI_up=confint(lm3)[2,2] ))

cor.test(someData2$R, icc_diff$alpha)

someData2$ICC_scaled= scale(icc_diff$alpha)
lm3=lm(`R_scaled` ~ ICC_scaled, someData2)
summary(lm3)
coeff=rbind(coeff, data.frame(coef=coef(lm3)[2], CI_low=confint(lm3)[2,1],CI_up=confint(lm3)[2,2] ))

cor.test(someData2$R, icc_diff$beta)

someData2$ICC_scaled= scale(icc_diff$beta)
lm3=lm(`R_scaled` ~ ICC_scaled, someData2)
summary(lm3)
coeff=rbind(coeff, data.frame(coef=coef(lm3)[2], CI_low=confint(lm3)[2,1],CI_up=confint(lm3)[2,2] ))

cor.test(someData2$R, icc_diff$gamma)

someData2$ICC_scaled= scale(icc_diff$gamma)
lm3=lm(`R_scaled` ~ ICC_scaled, someData2)
summary(lm3)
coeff=rbind(coeff, data.frame(coef=coef(lm3)[2], CI_low=confint(lm3)[2,1],CI_up=confint(lm3)[2,2] ))

cor.test(someData2$R, icc_diff$hgamma)

someData2$ICC_scaled= scale(icc_diff$hgamma)
lm3=lm(`R_scaled` ~ ICC_scaled, someData2)
summary(lm3)
coeff=rbind(coeff, data.frame(coef=coef(lm3)[2], CI_low=confint(lm3)[2,1],CI_up=confint(lm3)[2,2] ))

coeff$band= c('broadband', 'delta', 'theta', 'alpha', 'beta', 'gamma', 'high gamma')
coeff$band = factor(coeff$band, levels = c('high gamma', 'gamma', 'beta', 'alpha', 'theta', 'delta','broadband'))

ggplot(coeff, aes(x=band , y = coef, colour= cbbPalette[2], fill= cbbPalette[2])) + coord_flip(ylim=c(-0.6,0.6)) + geom_hline(yintercept = 0, linetype="dashed", color = "grey", size=1) +
  geom_errorbar(colour="#000000", aes(ymin=CI_low, ymax=CI_up),  width=.2, position=position_dodge(.9)) + geom_point(stat='identity',position=position_dodge(.9), size= 10)   + scale_fill_manual(values=cbbPalette[3])  + scale_color_manual(values=cbbPalette[2]) + theme_classic2() + xlab("") + ylab(" correlation (r)")+
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"), legend.position = "none")  

ggsave('~/Documents/CAMCAN_outputs/figures/SVR_correlation_between_decoding_and_delta_ICC.pdf', device = "pdf", height = 3.5, width = 5)



```





``` {r plotting SVR of cognition aperiodic corrected}

# set colour palette
cbbPalette= c("#DBF132", "#15A705",'#4F89E0',"#D81B99","#268236", '#4d3d87','#593d80', '#3b49e3')

SVM=read.csv( '~/Documents/CAMCAN_outputs/decode_SVR_ACER_80_20_APERIODIC_CORR.csv')
SVM=SVM[,-1]

df=read.csv('~/Documents//Alex_fingerprinting/PSD_ICC_orig_PD_new_PKD2.csv', header = FALSE, stringsAsFactors = FALSE)
colnames(df)[1]='region'
df=df[,1:2]
df$hemi =''
df$hemi[seq(2,68,2)] ='right'
df$hemi[seq(1,67,2)] ='left'
df$R=colMeans(SVM)

quantiles_decode=apply(SVM, 2, quantile, c(0.025, 0.975))
df$quantile_sig= quantiles_decode[1,] >0 & quantiles_decode[2,] >0



someData2= df
colnames(someData2)[2]='decoding corr'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$R[someData2$R >0.2]=0.2


ggplot(someData2) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = `R`)) +
  #scale_fill_distiller(palette = "RdBu"
  #                     , limits = c(0.4, 0.9))+
  viridis::scale_fill_viridis(option = 'viridis', limits = c(0.0, 0.2))+
  #scale_fill_gradient2(low="white", mid="#EC352F", high="#6C1917", 
  #                     midpoint=0.6,   
  #                     limits=c(0.4, 0.9 ))+
  theme_void() 

ggsave('~/Documents/CAMCAN_outputs/figures/decoding_of_acer_topo_80_20_APERIODIC_CORR.pdf', device = "pdf")


someData2$quantile_sig=as.numeric(someData2$quantile_sig)

ggplot(someData2) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = `quantile_sig`)) +

  scale_fill_gradient2(low="#DCD2D9", mid="#EC352F", high="#D81B99",
                      midpoint=0.5,
                      limits=c(0, 1 ))+
  theme_void() 

ggsave('~/Documents/CAMCAN_outputs/figures/decoding_of_acer_thresholded_maps_APERIODIC_CORR.pdf', device = "pdf")


# make hist of regions

data4plot= stack(SVM[,someData2$quantile_sig==1])

data4plot$hemi = plyr::mapvalues(data4plot$ind, unique(data4plot$ind), someData2$hemi[someData2$quantile_sig==1])

data4plot$region = plyr::mapvalues(data4plot$ind, unique(data4plot$ind), someData2$region[someData2$quantile_sig==1])


ggplot(data4plot, aes(values, color= hemi, fill=hemi, alpha=0.5)) +
  geom_density(aes( color= hemi, fill=hemi), alpha= 0.5, bins = 20) +
  #geom_histogram(aes(y=..density.., color= group, fill=group), alpha= 0.5, bins = 20) +
  theme_minimal() +
  labs(x = "prediction observed acer correlation", y = "denstity")  + theme_classic2() +
  ggtitle("") + scale_fill_manual(values=cbbPalette[c(1,4)]) + scale_color_manual(values=cbbPalette[c(1,4)]) + facet_wrap(~region, nrow = 3)

ggsave('~/Documents/CAMCAN_outputs/figures/decoding_of_acer_histograms_of_sig_regions_APERIODIC_CORR.pdf', device = "pdf")

# compute diff in ICC
demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]

psd_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/corrspec_Rest.csv', header = FALSE)
psd_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/corrspec_Task.csv', header = FALSE)


# look at age groups 
ind=demo$Age>18 & demo$Age <45
z_target= t(scale(t(psd_task[ind,])))
z_database= t(scale(t(psd_rest[ind,])))
icc = c()


n = length(ind)
k = 2
df_b = n-1
df_w = n*(k-1)


for (i_edge in 1:length(psd_rest)){
  x= data.frame(unlist(z_target[,i_edge]),unlist(z_database[,i_edge]) )
  x_w_mean =  rowMeans(x)
  x_g_mean = mean(unlist(x))
  ss_t = sum(((x - x_g_mean)^2))
  ss_w = sum((x - (x_w_mean))^2)
  ss_b = ss_t - ss_w
  ms_b = ss_b / df_b
  ms_w = ss_w / df_w
  icc[i_edge] = (ms_b - ms_w) / (ms_b + ((k-1)*ms_w))
  
  
}

icc_mat_young <- matrix(icc, nrow = 68, byrow = TRUE)


# look at age groups 
ind=demo$Age>=65 & demo$Age <90
z_target= t(scale(t(psd_task[ind,])))
z_database= t(scale(t(psd_rest[ind,])))
icc = c()


n = length(ind)
k = 2
df_b = n-1
df_w = n*(k-1)


for (i_edge in 1:length(psd_rest)){
  x= data.frame(unlist(z_target[,i_edge]),unlist(z_database[,i_edge]) )
  x_w_mean =  rowMeans(x)
  x_g_mean = mean(unlist(x))
  ss_t = sum(((x - x_g_mean)^2))
  ss_w = sum((x - (x_w_mean))^2)
  ss_b = ss_t - ss_w
  ms_b = ss_b / df_b
  ms_w = ss_w / df_w
  icc[i_edge] = (ms_b - ms_w) / (ms_b + ((k-1)*ms_w))
  
  
}

icc_mat_older <- matrix(icc, nrow = 68, byrow = TRUE)

icc_diff= icc_mat_older- icc_mat_young

cor.test(someData2$R, rowMeans(icc_diff))

someData2= df
someData2$ICC= rowMeans(icc_diff)
colnames(someData2)[2]='decoding corr'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'

someData2$ICC[someData2$ICC>.1]= 0.1

ggplot(someData2) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = `ICC`)) +
  #scale_fill_distiller(palette = "RdBu"
  #                     , limits = c(0.4, 0.9))+
  viridis::scale_fill_viridis(option = 'viridis', limits = c(-0.05, 0.2))+
  #scale_fill_gradient2(low="white", mid="#EC352F", high="#6C1917", 
  #                     midpoint=0.6,   
  #                     limits=c(0.4, 0.9 ))+
  theme_void() 

ggsave('~/Documents/CAMCAN_outputs/figures/broadband_diff_ICC_APERIODIC_CORR.pdf', device = "pdf")



coeff= data.frame()

someData2$R_scaled= scale(someData2$R)
someData2$ICC_scaled= scale(someData2$ICC)

lm3=lm(`R_scaled` ~ ICC_scaled, someData2)
summary(lm3)
coeff=rbind(coeff, data.frame(coef=coef(lm3)[2], CI_low=confint(lm3)[2,1],CI_up=confint(lm3)[2,2],  p_val= summary.lm(lm3)[[4]][2,4] ))

ggplot(someData2, aes(x=R , y = ICC, fill=cbbPalette[4])) + 
  geom_jitter(colour = cbbPalette[4]) + 
  stat_smooth(method = "lm", colour = 'black',fullrange = T, fill=cbbPalette[4]) +
  labs(title = paste("Adj R2 = ", signif(summary(lm3)$adj.r.squared, 5),
                     "Intercept =", signif(lm3$coef[[1]],5 ),
                     " Slope =", signif(lm3$coef[[2]], 5),
                     " P =", signif(summary(lm3)$coef[2,4], 5) )) + scale_fill_manual(values=cbbPalette[4])  + theme_classic2() +   xlab("decoding correlation (r)") + ylab("ICC")+
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"), legend.position = "none") 

ggsave('~/Documents/CAMCAN_outputs/figures/SVR_ACER_ICC_broadband_APERIODIC_CORR.pdf', device = "pdf", width=5, height=5, dpi=800)

icc_diff= icc_mat_older- icc_mat_young

icc_diff= data.frame(delta= rowMeans(icc_diff[,1:6]),
                     theta= rowMeans(icc_diff[,7:14]),
                     alpha=rowMeans(icc_diff[,15:24]),
                     beta=rowMeans(icc_diff[,25:58]))

cor.test(someData2$R, icc_diff$delta)

someData2$ICC_scaled= scale(icc_diff$delta)
lm3=lm(`R_scaled` ~ ICC_scaled, someData2)
summary(lm3)
coeff=rbind(coeff, data.frame(coef=coef(lm3)[2], CI_low=confint(lm3)[2,1],CI_up=confint(lm3)[2,2], p_val= summary.lm(lm3)[[4]][2,4] ))


cor.test(someData2$R, icc_diff$theta)

someData2$ICC_scaled= scale(icc_diff$theta)
lm3=lm(`R_scaled` ~ ICC_scaled, someData2)
summary(lm3)
coeff=rbind(coeff, data.frame(coef=coef(lm3)[2], CI_low=confint(lm3)[2,1],CI_up=confint(lm3)[2,2], p_val= summary.lm(lm3)[[4]][2,4] ))


cor.test(someData2$R, icc_diff$alpha)

someData2$ICC_scaled= scale(icc_diff$alpha)
lm3=lm(`R_scaled` ~ ICC_scaled, someData2)
summary(lm3)
coeff=rbind(coeff, data.frame(coef=coef(lm3)[2], CI_low=confint(lm3)[2,1],CI_up=confint(lm3)[2,2], p_val= summary.lm(lm3)[[4]][2,4] ))


cor.test(someData2$R, icc_diff$beta)

someData2$ICC_scaled= scale(icc_diff$beta)
lm3=lm(`R_scaled` ~ ICC_scaled, someData2)
summary(lm3)
coeff=rbind(coeff, data.frame(coef=coef(lm3)[2], CI_low=confint(lm3)[2,1],CI_up=confint(lm3)[2,2], p_val= summary.lm(lm3)[[4]][2,4] ))


coeff$band= c('broadband', 'delta', 'theta', 'alpha', 'beta')
coeff$band = factor(coeff$band, levels = c('beta', 'alpha', 'theta', 'delta','broadband'))

ggplot(coeff, aes(x=band , y = coef, colour= cbbPalette[2], fill= cbbPalette[2])) + coord_flip(ylim=c(-0.6,0.6)) + geom_hline(yintercept = 0, linetype="dashed", color = "grey", size=1) +
  geom_errorbar(colour="#000000", aes(ymin=CI_low, ymax=CI_up),  width=.2, position=position_dodge(.9)) + geom_point(stat='identity',position=position_dodge(.9), size= 10)   + scale_fill_manual(values=cbbPalette[3])  + scale_color_manual(values=cbbPalette[2]) + theme_classic2() + xlab("") + ylab(" correlation (r)")+
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"), legend.position = "none")  

ggsave('~/Documents/CAMCAN_outputs/figures/SVR_correlation_between_decoding_and_delta_ICC_APERIODIC_CORR.pdf', device = "pdf", height = 3.5, width = 5)


```





```{r aperiodic ICC diff between groups permtations}


demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]

psd_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/aperiodic_exponent_Rest.csv', header = FALSE)
psd_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/aperiodic_exponent_Task.csv', header = FALSE)


# look at age groups 
ind=demo$Age>18 & demo$Age <45
z_target= t(scale(t(psd_task[ind,])))
z_database= t(scale(t(psd_rest[ind,])))
icc = c()


n = length(ind)
k = 2
df_b = n-1
df_w = n*(k-1)


for (i_edge in 1:length(psd_rest)){
  x= data.frame(unlist(z_target[,i_edge]),unlist(z_database[,i_edge]) )
  x_w_mean =  rowMeans(x)
  x_g_mean = mean(unlist(x))
  ss_t = sum(((x - x_g_mean)^2))
  ss_w = sum((x - (x_w_mean))^2)
  ss_b = ss_t - ss_w
  ms_b = ss_b / df_b
  ms_w = ss_w / df_w
  icc[i_edge] = (ms_b - ms_w) / (ms_b + ((k-1)*ms_w))
  
  
}

icc_mat_young <- matrix(icc, nrow = 68, byrow = TRUE)


# look at age groups 
ind=demo$Age>=65 & demo$Age <90
z_target= t(scale(t(psd_task[ind,])))
z_database= t(scale(t(psd_rest[ind,])))
icc = c()


n = length(ind)
k = 2
df_b = n-1
df_w = n*(k-1)


for (i_edge in 1:length(psd_rest)){
  x= data.frame(unlist(z_target[,i_edge]),unlist(z_database[,i_edge]) )
  x_w_mean =  rowMeans(x)
  x_g_mean = mean(unlist(x))
  ss_t = sum(((x - x_g_mean)^2))
  ss_w = sum((x - (x_w_mean))^2)
  ss_b = ss_t - ss_w
  ms_b = ss_b / df_b
  ms_w = ss_w / df_w
  icc[i_edge] = (ms_b - ms_w) / (ms_b + ((k-1)*ms_w))
  
  
}

icc_mat_older <- matrix(icc, nrow = 68, byrow = TRUE)

icc_mat= icc_mat_older - icc_mat_young



# plot effect 
df=read.csv('~/Documents/Alex_fingerprinting/PSD_ICC_orig_PD_new_PKD2.csv', header = FALSE, stringsAsFactors = FALSE)
colnames(df)[1]='region'
df$hemi =''
df$hemi[seq(2,68,2)] ='right' 
df$hemi[seq(1,67,2)] ='left'

someData= tidyr::tibble(df$region, icc_mat, df$hemi)
colnames(someData)[2]='ICC'
colnames(someData)[1]='region'
colnames(someData)[3]='hemi'
someData$ICC[someData$ICC< -0.3]= -0.3
someData$ICC[someData$ICC>0.3]=0.3


ggplot(someData) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ICC)) + #viridis::scale_fill_viridis(option = 'magma',limits=c(-0.3, 0.3 ))
  scale_fill_gradient2(low = "#1C14B4", mid = "#FCF7F4", high = "#079D0A", midpoint = 0.0, limits=c(-0.3, 0.3 ))   + theme_void() 

ggsave('/Users/jason/Documents/CAMCAN_outputs/figures/Fingerprinting_ICC_values_diff_younger_minus_older_aperiodic_exponent.pdf', device = "pdf")

load("~/Documents/CAMCAN_outputs/July2022_permuted_ICC_values_diffage_aperiodic_exponent.rds")


X=data.frame(aperiodic= icc_mat)



p_value_icc=matrix(, nrow = 68, ncol = 1)
p_value_icc[,1]= colSums(abs(matrix(rep(X[,1], each=1000), nrow = 1000)) < abs(rand_map_aperiodic))/1000

p_adjusted= matrix(p.adjust(p_value_icc, method = 'fdr'),nrow = 68, ncol = 1)

# plot effect 
df=read.csv('~/Documents/Alex_fingerprinting/PSD_ICC_orig_PD_new_PKD2.csv', header = FALSE, stringsAsFactors = FALSE)
colnames(df)[1]='region'
df$hemi =''
df$hemi[seq(2,68,2)] ='right' 
df$hemi[seq(1,67,2)] ='left'

#  look ICC across bands
someData= cbind(df$region, df$hemi, stack(X))
colnames(someData)= c('region', 'hemi', 'ICC', 'band')

someData$ICC[someData$ICC>0.3]=0.3
someData$ICC[someData$ICC< -0.3]=-0.3

ggplot(someData) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ICC)) +   scale_fill_gradient2(low = "#1C14B4", mid = "#FCF7F4", high = "#079D0A", midpoint = 0.0, limits=c(-0.3, 0.3 )) + facet_wrap(~band)   + theme_void() 


#  plot p val
p_adjusted= as.data.frame(p_adjusted)
colnames(p_adjusted)= colnames(X)
rownames(p_adjusted)= rownames(X)
someData= cbind(df$region, df$hemi, stack(p_adjusted),stack(X))
colnames(someData)= c('region', 'hemi', 'p value adjusted', 'band', 'ICC', 'band2')

cbbPalette= c("#4f89e0", "#f5ec6c",'#156605',"#76D7C4","#268236", '#4d3d87','#593d80', '#3b49e3')

ggplot(someData) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = `p value adjusted`)) +   scale_fill_gradient2(low = "#1C14B4", mid = "#4d3d87", high = "#FCF7F4", midpoint = 0.0, limits=c(0, 1 )) + facet_wrap(~band)   + theme_void() 

ggsave('/Users/jason/Documents/CAMCAN_outputs/figures/permuted_ICC_aperiodic_exponent_pvals_unthresholded_adjusted_fdr.pdf', device = "pdf")






# offset 


psd_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/aperiodic_offset_Rest.csv', header = FALSE)
psd_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/aperiodic_offset_Task.csv', header = FALSE)


# look at age groups 
ind=demo$Age>18 & demo$Age <45
z_target= t(scale(t(psd_task[ind,])))
z_database= t(scale(t(psd_rest[ind,])))
icc = c()


n = length(ind)
k = 2
df_b = n-1
df_w = n*(k-1)


for (i_edge in 1:length(psd_rest)){
  x= data.frame(unlist(z_target[,i_edge]),unlist(z_database[,i_edge]) )
  x_w_mean =  rowMeans(x)
  x_g_mean = mean(unlist(x))
  ss_t = sum(((x - x_g_mean)^2))
  ss_w = sum((x - (x_w_mean))^2)
  ss_b = ss_t - ss_w
  ms_b = ss_b / df_b
  ms_w = ss_w / df_w
  icc[i_edge] = (ms_b - ms_w) / (ms_b + ((k-1)*ms_w))
  
  
}

icc_mat_young <- matrix(icc, nrow = 68, byrow = TRUE)


# look at age groups 
ind=demo$Age>=65 & demo$Age <90
z_target= t(scale(t(psd_task[ind,])))
z_database= t(scale(t(psd_rest[ind,])))
icc = c()


n = length(ind)
k = 2
df_b = n-1
df_w = n*(k-1)


for (i_edge in 1:length(psd_rest)){
  x= data.frame(unlist(z_target[,i_edge]),unlist(z_database[,i_edge]) )
  x_w_mean =  rowMeans(x)
  x_g_mean = mean(unlist(x))
  ss_t = sum(((x - x_g_mean)^2))
  ss_w = sum((x - (x_w_mean))^2)
  ss_b = ss_t - ss_w
  ms_b = ss_b / df_b
  ms_w = ss_w / df_w
  icc[i_edge] = (ms_b - ms_w) / (ms_b + ((k-1)*ms_w))
  
  
}

icc_mat_older <- matrix(icc, nrow = 68, byrow = TRUE)

icc_mat= icc_mat_older - icc_mat_young



# plot effect 
df=read.csv('~/Documents/Alex_fingerprinting/PSD_ICC_orig_PD_new_PKD2.csv', header = FALSE, stringsAsFactors = FALSE)
colnames(df)[1]='region'
df$hemi =''
df$hemi[seq(2,68,2)] ='right' 
df$hemi[seq(1,67,2)] ='left'

someData= tidyr::tibble(df$region, icc_mat, df$hemi)
colnames(someData)[2]='ICC'
colnames(someData)[1]='region'
colnames(someData)[3]='hemi'
someData$ICC[someData$ICC< -0.3]= -0.3
someData$ICC[someData$ICC>0.3]=0.3


ggplot(someData) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ICC)) + #viridis::scale_fill_viridis(option = 'magma',limits=c(-0.3, 0.3 ))
  scale_fill_gradient2(low = "#1C14B4", mid = "#FCF7F4", high = "#079D0A", midpoint = 0.0, limits=c(-0.3, 0.3 ))   + theme_void() 

ggsave('/Users/jason/Documents/CAMCAN_outputs/figures/Fingerprinting_ICC_values_diff_younger_minus_older_aperiodic_offset.pdf', device = "pdf")

load("~/Documents/CAMCAN_outputs/July2022_permuted_ICC_values_diffage_aperiodic_offset.rds")


X=data.frame(aperiodic= icc_mat)



p_value_icc=matrix(, nrow = 68, ncol = 1)
p_value_icc[,1]= colSums(abs(matrix(rep(X[,1], each=1000), nrow = 1000)) < abs(rand_map_aperiodic))/1000

p_adjusted= matrix(p.adjust(p_value_icc, method = 'fdr'),nrow = 68, ncol = 1)

# plot effect 
df=read.csv('~/Documents/Alex_fingerprinting/PSD_ICC_orig_PD_new_PKD2.csv', header = FALSE, stringsAsFactors = FALSE)
colnames(df)[1]='region'
df$hemi =''
df$hemi[seq(2,68,2)] ='right' 
df$hemi[seq(1,67,2)] ='left'

#  look ICC across bands
someData= cbind(df$region, df$hemi, stack(X))
colnames(someData)= c('region', 'hemi', 'ICC', 'band')

someData$ICC[someData$ICC>0.3]=0.3
someData$ICC[someData$ICC< -0.3]=-0.3

ggplot(someData) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ICC)) +   scale_fill_gradient2(low = "#1C14B4", mid = "#FCF7F4", high = "#079D0A", midpoint = 0.0, limits=c(-0.3, 0.3 )) + facet_wrap(~band)   + theme_void() 


#  plot p val
p_adjusted= as.data.frame(p_adjusted)
colnames(p_adjusted)= colnames(X)
rownames(p_adjusted)= rownames(X)
someData= cbind(df$region, df$hemi, stack(p_adjusted),stack(X))
colnames(someData)= c('region', 'hemi', 'p value adjusted', 'band', 'ICC', 'band2')

cbbPalette= c("#4f89e0", "#f5ec6c",'#156605',"#76D7C4","#268236", '#4d3d87','#593d80', '#3b49e3')

ggplot(someData) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = `p value adjusted`)) +   scale_fill_gradient2(low = "#1C14B4", mid = "#4d3d87", high = "#FCF7F4", midpoint = 0.0, limits=c(0, 1 )) + facet_wrap(~band)   + theme_void() 



```



```{r computing cognitive effects}


# set colour palette
cbbPalette= c("#DBF132", "#15A705",'#4F89E0',"#D81B99",'#1908AF', '#9211E6',"#268236", '#4d3d87','#593d80', '#3b49e3')


demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]


psd_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_Rest.csv', header = FALSE)
psd_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_Task.csv', header = FALSE)

demo$Group[demo$Age>18 & demo$Age <45]= "young adult"
demo$Group[demo$Age>=45 & demo$Age <65]= "adult"
demo$Group[demo$Age>=65 & demo$Age <90]= "older adult"

t.test(full_demo$additional_acer[demo$Group == 'older adult'], full_demo$additional_acer[demo$Group == 'young adult'])

t1=t.test(full_demo$additional_attention_orientation[demo$Group == 'older adult'], full_demo$additional_attention_orientation[demo$Group == 'young adult'])

t2=t.test(full_demo$additional_fluencies[demo$Group == 'older adult'], full_demo$additional_fluencies[demo$Group == 'young adult'])

t3=t.test(full_demo$additional_language[demo$Group == 'older adult'], full_demo$additional_language[demo$Group == 'young adult'])

t4=t.test(full_demo$additional_memory[demo$Group == 'older adult'], full_demo$additional_memory[demo$Group == 'young adult'])

t5=t.test(full_demo$additional_visuospatial[demo$Group == 'older adult'], full_demo$additional_visuospatial[demo$Group == 'young adult'])

p.adjust(c(t1$p.value, t2$p.value, t3$p.value, t4$p.value, t5$p.value), method = 'fdr')

full_demo$Group = demo$Group
data4plot= full_demo
data4plot= data4plot[data4plot$Group != 'adult',]


# permutation test 

RVAideMemoire::perm.t.test(full_demo$additional_acer[demo$Group == 'older adult'], full_demo$additional_acer[demo$Group == 'young adult'], nperm=1000, paired=FALSE)


ggplot(data4plot, aes(additional_acer, color= Group, fill=Group, alpha=0.5)) +
  geom_density(aes( color= Group, fill=Group), alpha= 0.5, bins = 20) +
  #geom_histogram(aes(y=..density.., color= group, fill=group), alpha= 0.5, bins = 20) +
  labs(x = "ACER", y = "denstity")  + theme_classic2() +
  ggtitle("") + scale_fill_manual(values=cbbPalette[c(2,4)]) + scale_color_manual(values=cbbPalette[c(2,4)]) + xlim(c(70,100))

ggsave('/Users/jason/Documents/CAMCAN_outputs/figures/Hist_of_ACER.pdf', device = "pdf")


```




``` {r plotting spectra}


# set colour palette
cbbPalette= c("#DBF132", "#15A705",'#4F89E0',"#D81B99","#268236", '#4d3d87','#593d80', '#3b49e3')

SVM=read.csv( '~/Documents/CAMCAN_outputs/decode_SVR_ACER_80_20_new.csv')
SVM=SVM[,-1]

df=read.csv('~/Documents//Alex_fingerprinting/PSD_ICC_orig_PD_new_PKD2.csv', header = FALSE, stringsAsFactors = FALSE)
colnames(df)[1]='region'
df=df[,1:2]
df$hemi =''
df$hemi[seq(2,68,2)] ='right'
df$hemi[seq(1,67,2)] ='left'
df$R=colMeans(SVM)

quantiles_decode=apply(SVM, 2, quantile, c(0.025, 0.975))
df$quantile_sig= quantiles_decode[1,] >0 & quantiles_decode[2,] >0

demo$Group[demo$Age>18 & demo$Age <45]= "young adult"
demo$Group[demo$Age>=45 & demo$Age <65]= "adult"
demo$Group[demo$Age>=65 & demo$Age <90]= "older adult"

full_demo$Group = demo$Group

full_demo$Group = factor(full_demo$Group, levels = c('young adult', 'adult', 'older adult'))

full_demo$acer_bin = full_demo$additional_acer>median(full_demo$additional_acer, na.rm = TRUE)

# ROI of highest decoding are left lateral orbitofrontal [25] and left lateral occipital [23], left lingual [27]

psd_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_Rest.csv', header = FALSE)

roi_index= (300*(43-1)+1):(300*(43-1)+300)

target_LSP= psd_rest[,roi_index]

target_LSP= cbind(full_demo, stack(target_LSP))

target_LSP$ind = plyr::mapvalues(target_LSP$ind , unique(target_LSP$ind ), seq(0,149.5,1/2))

target_LSP$ind= as.numeric(as.character(target_LSP$ind))

library(dplyr)
data4plot= target_LSP %>% group_by(Group, ind) %>% summarise( power= mean(log(values)), SEM= (sd(log(values))/sqrt(n())))
data4plot= data4plot[!is.na(data4plot$Group),]

ggplot(data4plot, aes(x= ind, y = power, fill= Group,colour= Group, ymin=power-SEM, ymax=power+SEM)) + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + theme_classic2() + xlim(1,40) + ylim(-2,2.5)+ scale_color_manual(values=cbbPalette[c(2,3, 4)]) + scale_fill_manual(values=cbbPalette[c(2,3, 4)])

ggsave('~/Documents/CAMCAN_outputs/figures/Example_spectra_left_pericalcarine.pdf', device = "pdf", width=5, height=5, dpi=800)

ggplot(data4plot, aes(x= ind, y = power, fill= Group,colour= Group, ymin=power-SEM, ymax=power+SEM, linetype= Group)) + coord_trans(x = 'log10') + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + theme_classic2() + xlim(1,40) + ylim(-1, 3.5) + scale_color_manual(values=cbbPalette[c(2,3,4)]) +  scale_fill_manual(values=cbbPalette[c(2,3,4)]) + xlim(1,40)+  ylim(-3,2) 

ggsave('~/Documents/CAMCAN_outputs/figures/Example_spectra_left_pericalcarine_loglog.pdf', device = "pdf", width=5, height=5, dpi=800)


target_LSP= target_LSP[!is.na(target_LSP$acer_bin),]
target_LSP= target_LSP[target_LSP$Group != 'adult',]

data4plot= target_LSP %>% group_by(Group,acer_bin, ind) %>% summarise( power= mean(log(values)), SEM= (sd(log(values))/sqrt(n())))
data4plot= data4plot[!is.na(data4plot$acer_bin),]


ggplot(data4plot, aes(x= ind, y = power, fill= Group,colour= Group, ymin=power-SEM, ymax=power+SEM, linetype= acer_bin)) + coord_trans(x = 'log10') + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + theme_classic2() + xlim(1,40) + ylim(-1, 3.5) + scale_color_manual(values=cbbPalette[c(2,4)]) +  scale_fill_manual(values=cbbPalette[c(2,4)]) + xlim(1,40)+  ylim(-3,2) 

ggplot(data4plot, aes(x= ind, y = power, fill= Group,colour= Group, ymin=power-SEM, ymax=power+SEM, linetype= acer_bin)) + coord_trans(x = 'log10') + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + theme_classic2() + xlim(1,40) + ylim(-1, 3.5) + scale_color_manual(values=cbbPalette[c(2,4)]) +  scale_fill_manual(values=cbbPalette[c(2,4)]) + xlim(1,40)+  ylim(-3,2)   + facet_wrap(~Group)


ggsave('~/Documents/CAMCAN_outputs/figures/Example_spectra_left_pericalcarine_ACER_V_age_LOGLOG.pdf', device = "pdf", width=10, height=5, dpi=800)


target_LSP= target_LSP[target_LSP$Group == 'older adult',]

target_LSP$quant_acer= ntile(target_LSP$additional_acer, 3)

target_LSP$quant_acer= factor(target_LSP$quant_acer)

data4plot= target_LSP %>% group_by(Group,quant_acer, ind) %>% summarise( power= mean(log(values)), SEM= (sd(log(values))/sqrt(n())))
data4plot= data4plot[!is.na(data4plot$quant_acer),]

ggplot(data4plot, aes(x= ind, y = power, fill= quant_acer,colour= quant_acer, ymin=power-SEM, ymax=power+SEM, linetype= quant_acer)) + coord_trans(x = 'log10') + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + theme_classic2() + xlim(1,40) + ylim(-1, 3.5) + scale_color_manual(values=cbbPalette[c(2,3,4)]) +  scale_fill_manual(values=cbbPalette[c(2,3,4)]) + xlim(1,40)+  ylim(-3,2) 

ggsave('~/Documents/CAMCAN_outputs/figures/Example_spectra_left_pericalcarinel_ACER_old_adult.pdf', device = "pdf", width=5, height=5, dpi=800)


roi_index= (300*(67-1)+1):(300*(67-1)+300)

target_LSP= psd_rest[,roi_index]

target_LSP= cbind(full_demo, stack(target_LSP))

target_LSP$ind = plyr::mapvalues(target_LSP$ind , unique(target_LSP$ind ), seq(0,149.5,1/2))

target_LSP$ind= as.numeric(as.character(target_LSP$ind))

library(dplyr)
data4plot= target_LSP %>% group_by(Group, ind) %>% summarise( power= mean(log(values)), SEM= (sd(log(values))/sqrt(n())))
data4plot= data4plot[!is.na(data4plot$Group),]

ggplot(data4plot, aes(x= ind, y = power, fill= Group,colour= Group, ymin=power-SEM, ymax=power+SEM)) + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + theme_classic2() + xlim(1,40) + ylim(-2,2.5)+ scale_color_manual(values=cbbPalette[c(2,3, 4)]) + scale_fill_manual(values=cbbPalette[c(2,3, 4)])

ggsave('~/Documents/CAMCAN_outputs/figures/Example_spectra_left_transvtemporal.pdf', device = "pdf", width=5, height=5, dpi=800)

ggplot(data4plot, aes(x= ind, y = power, fill= Group,colour= Group, ymin=power-SEM, ymax=power+SEM, linetype= Group)) + coord_trans(x = 'log10') + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + theme_classic2() + xlim(1,40) + ylim(-1, 3.5) + scale_color_manual(values=cbbPalette[c(2,3,4)]) +  scale_fill_manual(values=cbbPalette[c(2,3,4)]) + xlim(1,40)+  ylim(-3,2) 

ggsave('~/Documents/CAMCAN_outputs/figures/Example_spectra_left_transvtemporal_loglog.pdf', device = "pdf", width=5, height=5, dpi=800)


target_LSP= target_LSP[!is.na(target_LSP$acer_bin),]
target_LSP= target_LSP[target_LSP$Group != 'adult',]

data4plot= target_LSP %>% group_by(Group,acer_bin, ind) %>% summarise( power= mean(log(values)), SEM= (sd(log(values))/sqrt(n())))
data4plot= data4plot[!is.na(data4plot$acer_bin),]


ggplot(data4plot, aes(x= ind, y = power, fill= Group,colour= Group, ymin=power-SEM, ymax=power+SEM, linetype= acer_bin)) + coord_trans(x = 'log10') + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + theme_classic2() + xlim(1,40) + ylim(-1, 3.5) + scale_color_manual(values=cbbPalette[c(2,4)]) +  scale_fill_manual(values=cbbPalette[c(2,4)]) + xlim(1,40)+  ylim(-3,2) 

ggplot(data4plot, aes(x= ind, y = power, fill= Group,colour= Group, ymin=power-SEM, ymax=power+SEM, linetype= acer_bin)) + coord_trans(x = 'log10') + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + theme_classic2() + xlim(1,40) + ylim(-1, 3.5) + scale_color_manual(values=cbbPalette[c(2,4)]) +  scale_fill_manual(values=cbbPalette[c(2,4)]) + xlim(1,40)+  ylim(-3,2)   + facet_wrap(~Group)


ggsave('~/Documents/CAMCAN_outputs/figures/Example_spectra_left_transvtemporal_ACER_V_age_LOGLOG.pdf', device = "pdf", width=10, height=5, dpi=800)


target_LSP= target_LSP[target_LSP$Group == 'older adult',]

target_LSP$quant_acer= ntile(target_LSP$additional_acer, 3)

target_LSP$quant_acer= factor(target_LSP$quant_acer)

data4plot= target_LSP %>% group_by(Group,quant_acer, ind) %>% summarise( power= mean(log(values)), SEM= (sd(log(values))/sqrt(n())))
data4plot= data4plot[!is.na(data4plot$quant_acer),]

ggplot(data4plot, aes(x= ind, y = power, fill= quant_acer,colour= quant_acer, ymin=power-SEM, ymax=power+SEM, linetype= quant_acer)) + coord_trans(x = 'log10') + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + theme_classic2() + xlim(1,40) + ylim(-1, 3.5) + scale_color_manual(values=cbbPalette[c(2,3,4)]) +  scale_fill_manual(values=cbbPalette[c(2,3,4)]) + xlim(1,40)+  ylim(-3,2) 

ggsave('~/Documents/CAMCAN_outputs/figures/Example_spectra_left_transvtemporall_ACER_old_adult.pdf', device = "pdf", width=5, height=5, dpi=800)




roi_index= (300*(44-1)+1):(300*(44-1)+300)

target_LSP= psd_rest[,roi_index]

target_LSP= cbind(full_demo, stack(target_LSP))

target_LSP$ind = plyr::mapvalues(target_LSP$ind , unique(target_LSP$ind ), seq(0,149.5,1/2))

target_LSP$ind= as.numeric(as.character(target_LSP$ind))

library(dplyr)
data4plot= target_LSP %>% group_by(Group, ind) %>% summarise( power= mean(log(values)), SEM= (sd(log(values))/sqrt(n())))
data4plot= data4plot[!is.na(data4plot$Group),]

ggplot(data4plot, aes(x= ind, y = power, fill= Group,colour= Group, ymin=power-SEM, ymax=power+SEM)) + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + theme_classic2() + xlim(1,40) + ylim(-2,2.5)+ scale_color_manual(values=cbbPalette[c(2,3, 4)]) + scale_fill_manual(values=cbbPalette[c(2,3, 4)])

ggsave('~/Documents/CAMCAN_outputs/figures/Example_spectra_right_pericalcarine.pdf', device = "pdf", width=5, height=5, dpi=800)

ggplot(data4plot, aes(x= ind, y = power, fill= Group,colour= Group, ymin=power-SEM, ymax=power+SEM, linetype= Group)) + coord_trans(x = 'log10') + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + theme_classic2() + xlim(1,40) + ylim(-1, 3.5) + scale_color_manual(values=cbbPalette[c(2,3,4)]) +  scale_fill_manual(values=cbbPalette[c(2,3,4)]) + xlim(1,40)+  ylim(-3,2) 

ggsave('~/Documents/CAMCAN_outputs/figures/Example_spectra_right_pericalcarine_loglog.pdf', device = "pdf", width=5, height=5, dpi=800)


target_LSP= target_LSP[!is.na(target_LSP$acer_bin),]
target_LSP= target_LSP[target_LSP$Group != 'adult',]

data4plot= target_LSP %>% group_by(Group,acer_bin, ind) %>% summarise( power= mean(log(values)), SEM= (sd(log(values))/sqrt(n())))
data4plot= data4plot[!is.na(data4plot$acer_bin),]


ggplot(data4plot, aes(x= ind, y = power, fill= Group,colour= Group, ymin=power-SEM, ymax=power+SEM, linetype= acer_bin)) + coord_trans(x = 'log10') + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + theme_classic2() + xlim(1,40) + ylim(-1, 3.5) + scale_color_manual(values=cbbPalette[c(2,4)]) +  scale_fill_manual(values=cbbPalette[c(2,4)]) + xlim(1,40)+  ylim(-3,2) 

ggplot(data4plot, aes(x= ind, y = power, fill= Group,colour= Group, ymin=power-SEM, ymax=power+SEM, linetype= acer_bin)) + coord_trans(x = 'log10') + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + theme_classic2() + xlim(1,40) + ylim(-1, 3.5) + scale_color_manual(values=cbbPalette[c(2,4)]) +  scale_fill_manual(values=cbbPalette[c(2,4)]) + xlim(1,40)+  ylim(-3,2)   + facet_wrap(~Group)


ggsave('~/Documents/CAMCAN_outputs/figures/Example_spectra_right_pericalcarine_ACER_V_age_LOGLOG.pdf', device = "pdf", width=10, height=5, dpi=800)


target_LSP= target_LSP[target_LSP$Group == 'older adult',]

target_LSP$quant_acer= ntile(target_LSP$additional_acer, 3)

target_LSP$quant_acer= factor(target_LSP$quant_acer)

data4plot= target_LSP %>% group_by(Group,quant_acer, ind) %>% summarise( power= mean(log(values)), SEM= (sd(log(values))/sqrt(n())))
data4plot= data4plot[!is.na(data4plot$quant_acer),]

ggplot(data4plot, aes(x= ind, y = power, fill= quant_acer,colour= quant_acer, ymin=power-SEM, ymax=power+SEM, linetype= quant_acer)) + coord_trans(x = 'log10') + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + theme_classic2() + xlim(1,40) + ylim(-1, 3.5) + scale_color_manual(values=cbbPalette[c(2,3,4)]) +  scale_fill_manual(values=cbbPalette[c(2,3,4)]) + xlim(1,40)+  ylim(-3,2) 

ggsave('~/Documents/CAMCAN_outputs/figures/Example_spectra_right_pericalcarine_ACER_old_adult.pdf', device = "pdf", width=5, height=5, dpi=800)


roi_index= (300*(24-1)+1):(300*(24-1)+300)

target_LSP= psd_rest[,roi_index]

target_LSP= cbind(full_demo, stack(target_LSP))

target_LSP$ind = plyr::mapvalues(target_LSP$ind , unique(target_LSP$ind ), seq(0,149.5,1/2))

target_LSP$ind= as.numeric(as.character(target_LSP$ind))

library(dplyr)
data4plot= target_LSP %>% group_by(Group, ind) %>% summarise( power= mean(log(values)), SEM= (sd(log(values))/sqrt(n())))
data4plot= data4plot[!is.na(data4plot$Group),]

ggplot(data4plot, aes(x= ind, y = power, fill= Group,colour= Group, ymin=power-SEM, ymax=power+SEM)) + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + theme_classic2() + xlim(1,40) + ylim(-2,2.5)+ scale_color_manual(values=cbbPalette[c(2,3, 4)]) + scale_fill_manual(values=cbbPalette[c(2,3, 4)])

ggsave('~/Documents/CAMCAN_outputs/figures/Example_spectra_right_lateralocci.pdf', device = "pdf", width=5, height=5, dpi=800)

ggplot(data4plot, aes(x= ind, y = power, fill= Group,colour= Group, ymin=power-SEM, ymax=power+SEM, linetype= Group)) + coord_trans(x = 'log10') + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + theme_classic2() + xlim(1,40) + ylim(-1, 3.5) + scale_color_manual(values=cbbPalette[c(2,3,4)]) +  scale_fill_manual(values=cbbPalette[c(2,3,4)]) + xlim(1,40)+  ylim(-3,2) 

ggsave('~/Documents/CAMCAN_outputs/figures/Example_spectra_right_lateralocci_loglog.pdf', device = "pdf", width=5, height=5, dpi=800)


target_LSP= target_LSP[!is.na(target_LSP$acer_bin),]
target_LSP= target_LSP[target_LSP$Group != 'adult',]

data4plot= target_LSP %>% group_by(Group,acer_bin, ind) %>% summarise( power= mean(log(values)), SEM= (sd(log(values))/sqrt(n())))
data4plot= data4plot[!is.na(data4plot$acer_bin),]


ggplot(data4plot, aes(x= ind, y = power, fill= Group,colour= Group, ymin=power-SEM, ymax=power+SEM, linetype= acer_bin)) + coord_trans(x = 'log10') + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + theme_classic2() + xlim(1,40) + ylim(-1, 3.5) + scale_color_manual(values=cbbPalette[c(2,4)]) +  scale_fill_manual(values=cbbPalette[c(2,4)]) + xlim(1,40)+  ylim(-3,2) 

ggplot(data4plot, aes(x= ind, y = power, fill= Group,colour= Group, ymin=power-SEM, ymax=power+SEM, linetype= acer_bin)) + coord_trans(x = 'log10') + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + theme_classic2() + xlim(1,40) + ylim(-1, 3.5) + scale_color_manual(values=cbbPalette[c(2,4)]) +  scale_fill_manual(values=cbbPalette[c(2,4)]) + xlim(1,40)+  ylim(-3,2)   + facet_wrap(~Group)


ggsave('~/Documents/CAMCAN_outputs/figures/Example_spectra_right_lateralocci_ACER_V_age_LOGLOG.pdf', device = "pdf", width=10, height=5, dpi=800)


target_LSP= target_LSP[target_LSP$Group == 'older adult',]

target_LSP$quant_acer= ntile(target_LSP$additional_acer, 3)

target_LSP$quant_acer= factor(target_LSP$quant_acer)

data4plot= target_LSP %>% group_by(Group,quant_acer, ind) %>% summarise( power= mean(log(values)), SEM= (sd(log(values))/sqrt(n())))
data4plot= data4plot[!is.na(data4plot$quant_acer),]

ggplot(data4plot, aes(x= ind, y = power, fill= quant_acer,colour= quant_acer, ymin=power-SEM, ymax=power+SEM, linetype= quant_acer)) + coord_trans(x = 'log10') + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + theme_classic2() + xlim(1,40) + ylim(-1, 3.5) + scale_color_manual(values=cbbPalette[c(2,3,4)]) +  scale_fill_manual(values=cbbPalette[c(2,3,4)]) + xlim(1,40)+  ylim(-3,2) 

ggsave('~/Documents/CAMCAN_outputs/figures/Example_spectra_right_lateralocci_ACER_old_adult.pdf', device = "pdf", width=5, height=5, dpi=800)



roi_index= (300*(40-1)+1):(300*(40-1)+300)

target_LSP= psd_rest[,roi_index]

target_LSP= cbind(full_demo, stack(target_LSP))

target_LSP$ind = plyr::mapvalues(target_LSP$ind , unique(target_LSP$ind ), seq(0,149.5,1/2))

target_LSP$ind= as.numeric(as.character(target_LSP$ind))

library(dplyr)
data4plot= target_LSP %>% group_by(Group, ind) %>% summarise( power= mean(log(values)), SEM= (sd(log(values))/sqrt(n())))
data4plot= data4plot[!is.na(data4plot$Group),]

ggplot(data4plot, aes(x= ind, y = power, fill= Group,colour= Group, ymin=power-SEM, ymax=power+SEM)) + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + theme_classic2() + xlim(1,40) + ylim(-2,2.5)+ scale_color_manual(values=cbbPalette[c(2,3, 4)]) + scale_fill_manual(values=cbbPalette[c(2,3, 4)])

ggsave('~/Documents/CAMCAN_outputs/figures/Example_spectra_right_lparsorbit.pdf', device = "pdf", width=5, height=5, dpi=800)

ggplot(data4plot, aes(x= ind, y = power, fill= Group,colour= Group, ymin=power-SEM, ymax=power+SEM, linetype= Group)) + coord_trans(x = 'log10') + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + theme_classic2() + xlim(1,40) + ylim(-1, 3.5) + scale_color_manual(values=cbbPalette[c(2,3,4)]) +  scale_fill_manual(values=cbbPalette[c(2,3,4)]) + xlim(1,40)+  ylim(-3,2) 

ggsave('~/Documents/CAMCAN_outputs/figures/Example_spectra_right_lparsorbit_loglog.pdf', device = "pdf", width=5, height=5, dpi=800)


target_LSP= target_LSP[!is.na(target_LSP$acer_bin),]
target_LSP= target_LSP[target_LSP$Group != 'adult',]

data4plot= target_LSP %>% group_by(Group,acer_bin, ind) %>% summarise( power= mean(log(values)), SEM= (sd(log(values))/sqrt(n())))
data4plot= data4plot[!is.na(data4plot$acer_bin),]


ggplot(data4plot, aes(x= ind, y = power, fill= Group,colour= Group, ymin=power-SEM, ymax=power+SEM, linetype= acer_bin)) + coord_trans(x = 'log10') + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + theme_classic2() + xlim(1,40) + ylim(-1, 3.5) + scale_color_manual(values=cbbPalette[c(2,4)]) +  scale_fill_manual(values=cbbPalette[c(2,4)]) + xlim(1,40)+  ylim(-3,2) 

ggplot(data4plot, aes(x= ind, y = power, fill= Group,colour= Group, ymin=power-SEM, ymax=power+SEM, linetype= acer_bin)) + coord_trans(x = 'log10') + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + theme_classic2() + xlim(1,40) + ylim(-1, 3.5) + scale_color_manual(values=cbbPalette[c(2,4)]) +  scale_fill_manual(values=cbbPalette[c(2,4)]) + xlim(1,40)+  ylim(-3,2)   + facet_wrap(~Group)


ggsave('~/Documents/CAMCAN_outputs/figures/Example_spectra_right_lparsorbit_ACER_V_age_LOGLOG.pdf', device = "pdf", width=10, height=5, dpi=800)


target_LSP= target_LSP[target_LSP$Group == 'older adult',]

target_LSP$quant_acer= ntile(target_LSP$additional_acer, 3)

target_LSP$quant_acer= factor(target_LSP$quant_acer)

data4plot= target_LSP %>% group_by(Group,quant_acer, ind) %>% summarise( power= mean(log(values)), SEM= (sd(log(values))/sqrt(n())))
data4plot= data4plot[!is.na(data4plot$quant_acer),]

ggplot(data4plot, aes(x= ind, y = power, fill= quant_acer,colour= quant_acer, ymin=power-SEM, ymax=power+SEM, linetype= quant_acer)) + coord_trans(x = 'log10') + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + theme_classic2() + xlim(1,40) + ylim(-1, 3.5) + scale_color_manual(values=cbbPalette[c(2,3,4)]) +  scale_fill_manual(values=cbbPalette[c(2,3,4)]) + xlim(1,40)+  ylim(-3,2) 

ggsave('~/Documents/CAMCAN_outputs/figures/Example_spectra_right_lparsorbit_ACER_old_adult.pdf', device = "pdf", width=5, height=5, dpi=800)



roi_index= (300*(49-1)+1):(300*(49-1)+300)

target_LSP= psd_rest[,roi_index]

target_LSP= cbind(full_demo, stack(target_LSP))

target_LSP$ind = plyr::mapvalues(target_LSP$ind , unique(target_LSP$ind ), seq(0,149.5,1/2))

target_LSP$ind= as.numeric(as.character(target_LSP$ind))

library(dplyr)
data4plot= target_LSP %>% group_by(Group, ind) %>% summarise( power= mean(log(values)), SEM= (sd(log(values))/sqrt(n())))
data4plot= data4plot[!is.na(data4plot$Group),]

ggplot(data4plot, aes(x= ind, y = power, fill= Group,colour= Group, ymin=power-SEM, ymax=power+SEM)) + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + theme_classic2() + xlim(1,40) + ylim(-2,2.5)+ scale_color_manual(values=cbbPalette[c(2,3, 4)]) + scale_fill_manual(values=cbbPalette[c(2,3, 4)])

ggsave('~/Documents/CAMCAN_outputs/figures/Example_spectra_left_precentral.pdf', device = "pdf", width=5, height=5, dpi=800)

ggplot(data4plot, aes(x= ind, y = power, fill= Group,colour= Group, ymin=power-SEM, ymax=power+SEM, linetype= Group)) + coord_trans(x = 'log10') + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + theme_classic2() + xlim(1,40) + ylim(-1, 3.5) + scale_color_manual(values=cbbPalette[c(2,3,4)]) +  scale_fill_manual(values=cbbPalette[c(2,3,4)]) + xlim(1,40)+  ylim(-3,2) 

ggsave('~/Documents/CAMCAN_outputs/figures/Example_spectra_left_precentral_loglog.pdf', device = "pdf", width=5, height=5, dpi=800)


target_LSP= target_LSP[!is.na(target_LSP$acer_bin),]
target_LSP= target_LSP[target_LSP$Group != 'adult',]

data4plot= target_LSP %>% group_by(Group,acer_bin, ind) %>% summarise( power= mean(log(values)), SEM= (sd(log(values))/sqrt(n())))
data4plot= data4plot[!is.na(data4plot$acer_bin),]


ggplot(data4plot, aes(x= ind, y = power, fill= Group,colour= Group, ymin=power-SEM, ymax=power+SEM, linetype= acer_bin)) + coord_trans(x = 'log10') + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + theme_classic2() + xlim(1,40) + ylim(-1, 3.5) + scale_color_manual(values=cbbPalette[c(2,4)]) +  scale_fill_manual(values=cbbPalette[c(2,4)]) + xlim(1,40)+  ylim(-3,2) 

ggplot(data4plot, aes(x= ind, y = power, fill= Group,colour= Group, ymin=power-SEM, ymax=power+SEM, linetype= acer_bin)) + coord_trans(x = 'log10') + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + theme_classic2() + xlim(1,40) + ylim(-1, 3.5) + scale_color_manual(values=cbbPalette[c(2,4)]) +  scale_fill_manual(values=cbbPalette[c(2,4)]) + xlim(1,40)+  ylim(-3,2)   + facet_wrap(~Group)


ggsave('~/Documents/CAMCAN_outputs/figures/Example_spectra_left_precentral_ACER_V_age_LOGLOG.pdf', device = "pdf", width=10, height=5, dpi=800)


target_LSP= target_LSP[target_LSP$Group == 'older adult',]

target_LSP$quant_acer= ntile(target_LSP$additional_acer, 3)

target_LSP$quant_acer= factor(target_LSP$quant_acer)

data4plot= target_LSP %>% group_by(Group,quant_acer, ind) %>% summarise( power= mean(log(values)), SEM= (sd(log(values))/sqrt(n())))
data4plot= data4plot[!is.na(data4plot$quant_acer),]

ggplot(data4plot, aes(x= ind, y = power, fill= quant_acer,colour= quant_acer, ymin=power-SEM, ymax=power+SEM, linetype= quant_acer)) + coord_trans(x = 'log10') + geom_ribbon(alpha=0.5, colour= NA) + geom_line() + theme_classic2() + xlim(1,40) + ylim(-1, 3.5) + scale_color_manual(values=cbbPalette[c(2,3,4)]) +  scale_fill_manual(values=cbbPalette[c(2,3,4)]) + xlim(1,40)+  ylim(-3,2) 

ggsave('~/Documents/CAMCAN_outputs/figures/Example_spectra_right_left_precentral_ACER_old_adult.pdf', device = "pdf", width=5, height=5, dpi=800)







```









```{r exponent diff across gradient}

cbbPalette= c("#4f89e0", "#f5ec6c",'#156605',"#76D7C4","#268236", '#4d3d87','#593d80', '#3b49e3')

#ge_colors = c("#000000","#007E7E","#8001FC","#FF8207","#FFFFFF")
#scale_fill_gradientn(colors = ge_colors,oob = scales::squish,limits=c(floor(rng[1]), ceiling(rng[2])))

demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]

aper_expon=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/aperiodic_exponent_Rest.csv', header = FALSE)
aper_offset=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/aperiodic_offset_Rest.csv', header = FALSE)

#aper_expon_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/aperiodic_exponent_Task.csv', header = FALSE)
#aper_offset_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/aperiodic_offset_task.csv', header = FALSE)

demo$Group[demo$Age>18 & demo$Age <45]= "young adult"
demo$Group[demo$Age>=45 & demo$Age <65]= "adult"
demo$Group[demo$Age>=65 & demo$Age <90]= "older adult"

t.test(aper_expon[demo$Group == 'young adult', 44], aper_expon[demo$Group == 'older adult', 44])

t.test(aper_expon[demo$Group == 'young adult', 67], aper_expon[demo$Group == 'older adult', 67])


t.test(aper_offset[demo$Group == 'young adult', 44], aper_offset[demo$Group == 'older adult', 44])

t.test(aper_offset[demo$Group == 'young adult', 67], aper_offset[demo$Group == 'older adult', 67])


fit_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/fit_mse_Rest.csv', header = FALSE)
fit_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/fit_mse_Task.csv', header = FALSE)

t.test(fit_rest[demo$Group == 'young adult', 44], fit_rest[demo$Group == 'older adult', 44])

t.test(fit_task[demo$Group == 'young adult', 67], fit_task[demo$Group == 'older adult', 67])



alpha_peak_amplitude=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/alpha_amplitude_Rest.csv', header = FALSE, na.strings = 'NaN')
alpha_peak_freq=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/alpha_centerfreq_Rest.csv', header = FALSE, na.strings = 'NaN')

t.test(alpha_peak_amplitude[demo$Group == 'young adult', 44], alpha_peak_amplitude[demo$Group == 'older adult', 44])

t.test(alpha_peak_amplitude[demo$Group == 'young adult', 67], alpha_peak_amplitude[demo$Group == 'older adult', 67])

t.test(alpha_peak_freq[demo$Group == 'young adult', 44], alpha_peak_freq[demo$Group == 'older adult', 44])

t.test(alpha_peak_freq[demo$Group == 'young adult', 67], alpha_peak_freq[demo$Group == 'older adult', 67])

alpha_peak_amplitude=alpha_peak_amplitude[demo$Group %in% c('young adult', 'older adult'),]
fit_rest=fit_rest[demo$Group %in% c('young adult', 'older adult'),]
aper_expon=aper_expon[demo$Group %in% c('young adult', 'older adult'),]
aper_offset=aper_offset[demo$Group %in% c('young adult', 'older adult'),]
demo_group= as.factor(demo$Group[demo$Group %in% c('young adult', 'older adult')])

scale_alpha_amplitude_44= (alpha_peak_amplitude[,44]- mean(alpha_peak_amplitude[,44], na.rm=TRUE))/ sd(alpha_peak_amplitude[,44], na.rm=TRUE)

scale_aper_offset_44= (aper_offset[,44]- mean(aper_offset[,44], na.rm=TRUE))/ sd(aper_offset[,44], na.rm=TRUE)

scale_aper_expon_44= (aper_expon[,44]- mean(aper_expon[,44], na.rm=TRUE))/ sd(aper_expon[,44], na.rm=TRUE)

scale_fit_44= (fit_rest[,44]- mean(fit_rest[,44], na.rm=TRUE))/ sd(fit_rest[,44], na.rm=TRUE)

scale_alpha_amplitude_67= (alpha_peak_amplitude[,67]- mean(alpha_peak_amplitude[,67], na.rm=TRUE))/ sd(alpha_peak_amplitude[,67], na.rm=TRUE)

scale_fit_67= (fit_rest[,67]- mean(fit_rest[,67], na.rm=TRUE))/ sd(fit_rest[,67], na.rm=TRUE)

scale_aper_offset_67= (aper_offset[,67]- mean(aper_offset[,67], na.rm=TRUE))/ sd(aper_offset[,67], na.rm=TRUE)

scale_aper_expon_67= (aper_expon[,67]- mean(aper_expon[,67], na.rm=TRUE))/ sd(aper_expon[,67], na.rm=TRUE)


lm1=lm(scale_alpha_amplitude_44 ~ demo_group + scale_fit_44)
summary(lm1)

lm2=lm(scale_aper_offset_44 ~ demo_group + scale_fit_44)
summary(lm2)

lm3=lm(scale_aper_expon_44 ~ demo_group + scale_fit_44)
summary(lm3)

coef= data.frame(effect= c('aperiodic exponent', 'aperiodic offset', 'alpha amplitude'), beta= c(lm3$coefficients[2], lm2$coefficients[2], lm1$coefficients[2]))


ggplot(data=coef, aes(x=effect, y=beta, fill=effect, width=.5)) +  coord_cartesian(ylim=c(0,1))+geom_bar(stat = "identity", position=position_dodge(width = 0.5)) +theme_minimal() + scale_fill_manual(values=cbbPalette) + labs(y="beta coef", x="",title="") + theme(text = element_text(size=40), legend.title=element_blank(), axis.text.x = element_text(angle = 90))

ggsave('~/Documents/CAMCAN_outputs/figures/effects_at_ROI_44.pdf', device = "pdf", width=10, height=10, dpi=800)





lm1=lm(scale_alpha_amplitude_67 ~ demo_group + scale_fit_44)
summary(lm1)

lm2=lm(scale_aper_offset_67 ~ demo_group + scale_fit_44)
summary(lm2)

lm3=lm(scale_aper_expon_67 ~ demo_group + scale_fit_44)
summary(lm3)

coef= data.frame(effect= c('aperiodic exponent', 'aperiodic offset', 'alpha amplitude'), beta= c(lm3$coefficients[2], lm2$coefficients[2], lm1$coefficients[2]))


ggplot(data=coef, aes(x=effect, y=beta, fill=effect, width=.5)) +  coord_cartesian(ylim=c(0,1))+geom_bar(stat = "identity", position=position_dodge(width = 0.5)) +theme_minimal() + scale_fill_manual(values=cbbPalette) + labs(y="beta coef", x="",title="") + theme(text = element_text(size=40), legend.title=element_blank(), axis.text.x = element_text(angle = 90))

ggsave('~/Documents/CAMCAN_outputs/figures/effects_at_ROI_67.pdf', device = "pdf", width=10, height=10, dpi=800)

```

## Neural Fingerprinting
fingerprint entire cohot and compare effects across psd, aperiodic, and periodic component 

```{r icc PCA explore}


# set colour palette
cbbPalette= c("#DBF132", "#15A705",'#4F89E0',"#D81B99","#268236", '#4d3d87','#593d80', '#3b49e3')


demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

psd_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_Rest.csv', header = FALSE)
psd_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_Task.csv', header = FALSE)


# look at age groups 
ind=demo$Age>18 & demo$Age <45
z_target= t(scale(t(psd_task[ind,])))
z_database= t(scale(t(psd_rest[ind,])))
icc = c()


n = length(ind)
k = 2
df_b = n-1
df_w = n*(k-1)


for (i_edge in 1:length(psd_rest)){
  x= data.frame(unlist(z_target[,i_edge]),unlist(z_database[,i_edge]) )
  x_w_mean =  rowMeans(x)
  x_g_mean = mean(unlist(x))
  ss_t = sum(((x - x_g_mean)^2))
  ss_w = sum((x - (x_w_mean))^2)
  ss_b = ss_t - ss_w
  ms_b = ss_b / df_b
  ms_w = ss_w / df_w
  icc[i_edge] = (ms_b - ms_w) / (ms_b + ((k-1)*ms_w))
  
  
}

icc_mat_young <- matrix(icc, nrow = 68, byrow = TRUE)


# look at age groups 
ind=demo$Age>=65 & demo$Age <90
z_target= t(scale(t(psd_task[ind,])))
z_database= t(scale(t(psd_rest[ind,])))
icc = c()


n = length(ind)
k = 2
df_b = n-1
df_w = n*(k-1)


for (i_edge in 1:length(psd_rest)){
  x= data.frame(unlist(z_target[,i_edge]),unlist(z_database[,i_edge]) )
  x_w_mean =  rowMeans(x)
  x_g_mean = mean(unlist(x))
  ss_t = sum(((x - x_g_mean)^2))
  ss_w = sum((x - (x_w_mean))^2)
  ss_b = ss_t - ss_w
  ms_b = ss_b / df_b
  ms_w = ss_w / df_w
  icc[i_edge] = (ms_b - ms_w) / (ms_b + ((k-1)*ms_w))
  
  
}

icc_mat_older <- matrix(icc, nrow = 68, byrow = TRUE)

icc_mat= icc_mat_older - icc_mat_young

X=data.frame(delta= rowMeans(icc_mat[,1:8]),theta= rowMeans(icc_mat[,9:16]),alpha= rowMeans(icc_mat[,17:26]),beta= rowMeans(icc_mat[,27:60]), gamma= rowMeans(icc_mat[,61:101]), hgamma= rowMeans(icc_mat[,102:300]))


# run PCA
library(factoextra)

X_scale= scale(X, center = TRUE, scale = TRUE)
pca_result <- prcomp(X_scale, scale = TRUE)
summary(pca_result)
fviz_eig(pca_result, ncp = 7)

X_young=data.frame(delta= rowMeans(icc_mat_young[,1:8]),theta= rowMeans(icc_mat_young[,9:16]),alpha= rowMeans(icc_mat_young[,17:26]),beta= rowMeans(icc_mat_young[,27:60]), gamma= rowMeans(icc_mat_young[,61:101]), hgamma= rowMeans(icc_mat_young[,102:300]))

X_older=data.frame(delta= rowMeans(icc_mat_older[,1:8]),theta= rowMeans(icc_mat_older[,9:16]),alpha= rowMeans(icc_mat_older[,17:26]),beta= rowMeans(icc_mat_older[,27:60]), gamma= rowMeans(icc_mat_older[,61:101]), hgamma= rowMeans(icc_mat_older[,102:300]))


X_young[44,]-X_older[44,]
X_young[43,]-X_older[43,]
X_young[24,]-X_older[24,]

X_young[67,]-X_older[67,]
X_young[39,]-X_older[39,]
X_young[68,]-X_older[68,]

cor.test(X_young[,1], pca_result$x[,1])
cor.test(X_young[,2], pca_result$x[,1])
cor.test(X_young[,3], pca_result$x[,1])
cor.test(X_young[,4], pca_result$x[,1])
cor.test(X_young[,5], pca_result$x[,1])
cor.test(X_young[,6], pca_result$x[,1])

cor.test(X_older[,1], pca_result$x[,1])
cor.test(X_older[,2], pca_result$x[,1])
cor.test(X_older[,3], pca_result$x[,1])
cor.test(X_older[,4], pca_result$x[,1])
cor.test(X_older[,5], pca_result$x[,1])
cor.test(X_older[,6], pca_result$x[,1])

as.matrix(X_young) %*% as.matrix(pca_result$rotation[,1])

as.matrix(X_older) %*% as.matrix(pca_result$rotation[,1])

```




```{r plot ICC effects }

demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]

psd_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_Rest.csv', header = FALSE)
psd_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_Task.csv', header = FALSE)

# look at age groups 
ind=demo$Age>18 & demo$Age <45
z_target= t(scale(t(psd_task[ind,])))
z_database= t(scale(t(psd_rest[ind,])))
icc = c()


n = length(ind)
k = 2
df_b = n-1
df_w = n*(k-1)


for (i_edge in 1:length(psd_rest)){
  x= data.frame(unlist(z_target[,i_edge]),unlist(z_database[,i_edge]) )
  x_w_mean =  rowMeans(x)
  x_g_mean = mean(unlist(x))
  ss_t = sum(((x - x_g_mean)^2))
  ss_w = sum((x - (x_w_mean))^2)
  ss_b = ss_t - ss_w
  ms_b = ss_b / df_b
  ms_w = ss_w / df_w
  icc[i_edge] = (ms_b - ms_w) / (ms_b + ((k-1)*ms_w))
  
  
}

icc_mat_young <- matrix(icc, nrow = 68, byrow = TRUE)


# look at age groups 
ind=demo$Age>=45 & demo$Age <65
z_target= t(scale(t(psd_task[ind,])))
z_database= t(scale(t(psd_rest[ind,])))
icc = c()


n = length(ind)
k = 2
df_b = n-1
df_w = n*(k-1)


for (i_edge in 1:length(psd_rest)){
  x= data.frame(unlist(z_target[,i_edge]),unlist(z_database[,i_edge]) )
  x_w_mean =  rowMeans(x)
  x_g_mean = mean(unlist(x))
  ss_t = sum(((x - x_g_mean)^2))
  ss_w = sum((x - (x_w_mean))^2)
  ss_b = ss_t - ss_w
  ms_b = ss_b / df_b
  ms_w = ss_w / df_w
  icc[i_edge] = (ms_b - ms_w) / (ms_b + ((k-1)*ms_w))
  
  
}

icc_mat_adult <- matrix(icc, nrow = 68, byrow = TRUE)



# look at age groups 
ind=demo$Age>=65 & demo$Age <90
z_target= t(scale(t(psd_task[ind,])))
z_database= t(scale(t(psd_rest[ind,])))
icc = c()


n = length(ind)
k = 2
df_b = n-1
df_w = n*(k-1)


for (i_edge in 1:length(psd_rest)){
  x= data.frame(unlist(z_target[,i_edge]),unlist(z_database[,i_edge]) )
  x_w_mean =  rowMeans(x)
  x_g_mean = mean(unlist(x))
  ss_t = sum(((x - x_g_mean)^2))
  ss_w = sum((x - (x_w_mean))^2)
  ss_b = ss_t - ss_w
  ms_b = ss_b / df_b
  ms_w = ss_w / df_w
  icc[i_edge] = (ms_b - ms_w) / (ms_b + ((k-1)*ms_w))
  
  
}

icc_mat_older <- matrix(icc, nrow = 68, byrow = TRUE)


icc_mat= icc_mat_older- icc_mat_young
X=data.frame(delta= rowMeans(icc_mat[,1:8]),theta= rowMeans(icc_mat[,9:16]),alpha= rowMeans(icc_mat[,17:26]),beta= rowMeans(icc_mat[,27:60]), gamma= rowMeans(icc_mat[,61:101]), hgamma= rowMeans(icc_mat[,102:300]))

# run PCA
library(factoextra)

X_scale= scale(X, center = TRUE, scale = TRUE)
pca_result <- prcomp(X_scale, scale = TRUE)
summary(pca_result)
fviz_eig(pca_result, ncp = 7)

df=read.csv('~/Documents//Alex_fingerprinting/PSD_ICC_orig_PD_new_PKD2.csv', header = FALSE, stringsAsFactors = FALSE)
colnames(df)[1]='region'
df=df[,1:2]
df$hemi =''
df$hemi[seq(2,68,2)] ='right'
df$hemi[seq(1,67,2)] ='left'
df$R=pca_result$x[,1]


cbbPalette= c("#4f89e0", "#f5ec6c",'#156605',"#76D7C4","#268236", '#4d3d87','#593d80', '#3b49e3')

data4plot= data.frame(ICC=c(icc_mat_young[67,], icc_mat_adult[67,], icc_mat_older[67,]), Group= rep(c('young adult', 'adult', 'older adult'), each=300 ), Frequency= rep(seq(0,149.5,1/2), 3) )

ggplot(data4plot, aes(x= Frequency, y = ICC, fill= Group,colour= Group)) +  geom_line() + ggpubr::theme_classic2() + xlim(1,150) + scale_color_manual(values=cbbPalette[c(4,1,2)]) + scale_fill_manual(values=cbbPalette[c(4,1,2)]) + coord_trans(x = 'log10') + xlim(1,40) + scale_y_continuous(position = "right", limits = c(0,1)) 

ggsave('~/Documents/CAMCAN_outputs/figures/Left_Transverse_temporal_ICC_group.pdf', device = "pdf")


data4plot= data.frame(ICC=c(icc_mat_young[44,], icc_mat_adult[44,], icc_mat_older[44,]), Group= rep(c('young adult', 'adult', 'older adult'), each=300 ), Frequency= rep(seq(0,149.5,1/2), 3) )

ggplot(data4plot, aes(x= Frequency, y = ICC, fill= Group,colour= Group)) +  geom_line() + ggpubr::theme_classic2() + xlim(1,150) + scale_color_manual(values=cbbPalette[c(1,6,3)]) + scale_fill_manual(values=cbbPalette[c(1,6,3)]) + coord_trans(x = 'log10') + xlim(1,40) + scale_y_continuous(position = "right", limits = c(0,1)) 

ggsave('~/Documents/CAMCAN_outputs/figures/Right_pericalcarine_ICC_group.pdf', device = "pdf")



```








``` {r decode age SVR new data}


# set colour palette
cbbPalette= c("#DBF132", "#15A705",'#4F89E0',"#D81B99","#268236", '#4d3d87','#593d80', '#3b49e3')


demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]


SVM=read.csv( '~/Documents/CAMCAN_outputs/NOV2022_decoding_age_from_JUSTOMEGA.csv', header = FALSE)


df=read.csv('~/Documents//Alex_fingerprinting/PSD_ICC_orig_PD_new_PKD2.csv', header = FALSE, stringsAsFactors = FALSE)
colnames(df)[1]='region'
df=df[,1:2]
df$hemi =''
df$hemi[seq(2,68,2)] ='right'
df$hemi[seq(1,67,2)] ='left'
df$R=rowMeans(SVM)

quantiles_decode=apply(SVM, 1, quantile, c(0.025, 0.975))
df$quantile_sig= quantiles_decode[1,] >0 & quantiles_decode[2,] >0

demo$Group[demo$Age>18 & demo$Age <45]= "young adult"
demo$Group[demo$Age>=45 & demo$Age <65]= "adult"
demo$Group[demo$Age>=65 & demo$Age <90]= "older adult"

someData2=df
someData2$R[someData2$R>0.5]=0.5
someData2$R[someData2$R<0.0]=0.0

ggplot(someData2) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = `R`)) +
  #scale_fill_distiller(palette = "RdBu"
  #                     , limits = c(0.4, 0.9))+
  viridis::scale_fill_viridis(option = 'viridis', limits = c(0.0, 0.5))+
  #scale_fill_gradient2(low="white", mid="#EC352F", high="#6C1917", 
  #                     midpoint=0.6,   
  #                     limits=c(0.4, 0.9 ))+
  theme_void() 

ggsave('~/Documents/CAMCAN_outputs/figures/decoding_of_age_80_20_just_OMEGA.pdf', device = "pdf")


psd_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_Rest.csv', header = FALSE)
psd_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_Task.csv', header = FALSE)


# look at age groups 
ind=demo$Age>18 & demo$Age <45
z_target= t(scale(t(psd_task[ind,])))
z_database= t(scale(t(psd_rest[ind,])))
icc = c()


n = length(ind)
k = 2
df_b = n-1
df_w = n*(k-1)


for (i_edge in 1:length(psd_rest)){
  x= data.frame(unlist(z_target[,i_edge]),unlist(z_database[,i_edge]) )
  x_w_mean =  rowMeans(x)
  x_g_mean = mean(unlist(x))
  ss_t = sum(((x - x_g_mean)^2))
  ss_w = sum((x - (x_w_mean))^2)
  ss_b = ss_t - ss_w
  ms_b = ss_b / df_b
  ms_w = ss_w / df_w
  icc[i_edge] = (ms_b - ms_w) / (ms_b + ((k-1)*ms_w))
  
  
}

icc_mat_young <- matrix(icc, nrow = 68, byrow = TRUE)


# look at age groups 
ind=demo$Age>=65 & demo$Age <90
z_target= t(scale(t(psd_task[ind,])))
z_database= t(scale(t(psd_rest[ind,])))
icc = c()


n = length(ind)
k = 2
df_b = n-1
df_w = n*(k-1)


for (i_edge in 1:length(psd_rest)){
  x= data.frame(unlist(z_target[,i_edge]),unlist(z_database[,i_edge]) )
  x_w_mean =  rowMeans(x)
  x_g_mean = mean(unlist(x))
  ss_t = sum(((x - x_g_mean)^2))
  ss_w = sum((x - (x_w_mean))^2)
  ss_b = ss_t - ss_w
  ms_b = ss_b / df_b
  ms_w = ss_w / df_w
  icc[i_edge] = (ms_b - ms_w) / (ms_b + ((k-1)*ms_w))
  
  
}

icc_mat_older <- matrix(icc, nrow = 68, byrow = TRUE)

icc_mat= icc_mat_older- icc_mat_young


X=data.frame(delta= rowMeans(icc_mat[,1:8]),theta= rowMeans(icc_mat[,9:16]),alpha= rowMeans(icc_mat[,17:26]),beta= rowMeans(icc_mat[,27:60]), gamma= rowMeans(icc_mat[,61:101]), hgamma= rowMeans(icc_mat[,102:300]))


# run PCA
library(factoextra)

X_scale= scale(X, center = TRUE, scale = TRUE)
pca_result <- prcomp(X_scale, scale = TRUE)
summary(pca_result)
fviz_eig(pca_result, ncp = 7)


cor.test(pca_result$x[,1], rowMeans(SVM))

SVM=read.csv( '~/Documents/CAMCAN_outputs/NOV2022_decoding_generalization_bothOMEGAANDPREVENT.csv', header = FALSE)

```



 ## Look at just rest effect
 
```{r just rest bootstrap fingerprinting acc}

cbbPalette= c("#4f89e0", "#f5ec6c",'#156605',"#76D7C4","#268236", '#4d3d87','#593d80', '#3b49e3')

demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]

psd_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_justRest.csv', header = FALSE)
psd_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_justRest2.csv', header = FALSE)


fingerprint_boot=matrix(, ncol = 1,nrow=2000)

temp_boot=matrix(, ncol = 2,nrow=1000)

for(i in 1:1000) {
  index_random_par=sample(1:606, 485)
  
  corr_psd=cor(t(psd_rest[index_random_par,]),t(psd_task[index_random_par,])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:485)==tt)/485
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:485)==tt)/485
  
}

fingerprint_boot[,1]= as.vector(temp_boot)

data4plot= data.frame(mean_differen=apply(fingerprint_boot, 2, mean), lower=apply(fingerprint_boot, 2, quantile, probs=c(0.025,0.975))[1,], upper= apply(fingerprint_boot, 2, quantile, probs=c(0.025,0.975))[2,])


write.csv(fingerprint_boot, '~/Documents/CAMCAN_outputs/CAMCAN_Analysis/just_baseline_bootstrapped_fingerprinting_fullcohort.csv')

mean(as.vector(temp_boot), na.rm = TRUE)
sd(as.vector(temp_boot), na.rm = TRUE)


ind=demo$Age>18 & demo$Age <45
psd_rest_age= psd_rest[ind,]
psd_task_age= psd_task[ind,]

fingerprint_boot=matrix(, ncol = 7,nrow=2000)

temp_boot=matrix(, ncol = 2,nrow=1000)

for(i in 1:1000) {
  index_random_par=sample(1:sum(ind), 175)
  
  corr_psd=cor(t(psd_rest_age[index_random_par,]),t(psd_task_age[index_random_par,])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:175)==tt)/175
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:175)==tt)/175
  
}

fingerprint_boot[,1]= as.vector(temp_boot)
write.csv(fingerprint_boot, '~/Documents/CAMCAN_outputs/CAMCAN_Analysis/just_baseline_bootstrapped_fingerprinting_young.csv')

mean(as.vector(temp_boot), na.rm = TRUE)
sd(as.vector(temp_boot), na.rm = TRUE)


ind=demo$Age>=45 & demo$Age <65
psd_rest_age= psd_rest[ind,]
psd_task_age= psd_task[ind,]

fingerprint_boot=matrix(, ncol = 7,nrow=2000)

temp_boot=matrix(, ncol = 2,nrow=1000)

for(i in 1:1000) {
  index_random_par=sample(1:sum(ind), 175)
  
  corr_psd=cor(t(psd_rest_age[index_random_par,]),t(psd_task_age[index_random_par,])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:175)==tt)/175
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:175)==tt)/175
  
}

fingerprint_boot[,1]= as.vector(temp_boot)
write.csv(fingerprint_boot, '/Users/jasondsc/Documents/CAMCAN_outputs/CAMCAN_Analysis/just_baseline_bootstrapped_fingerprinting_adult.csv')

mean(as.vector(temp_boot), na.rm = TRUE)
sd(as.vector(temp_boot), na.rm = TRUE)



ind=demo$Age>=65 & demo$Age <90
psd_rest_age= psd_rest[ind,]
psd_task_age= psd_task[ind,]

fingerprint_boot=matrix(, ncol = 7,nrow=2000)

temp_boot=matrix(, ncol = 2,nrow=1000)

for(i in 1:1000) {
  index_random_par=sample(1:sum(ind), 175)
  
  corr_psd=cor(t(psd_rest_age[index_random_par,]),t(psd_task_age[index_random_par,])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:175)==tt)/175
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:175)==tt)/175
  
}

fingerprint_boot[,1]= as.vector(temp_boot)
write.csv(fingerprint_boot, '/Users/jasondsc/Documents/CAMCAN_outputs/CAMCAN_Analysis/just_baseline_bootstrapped_fingerprinting_older.csv')

mean(as.vector(temp_boot), na.rm = TRUE)
sd(as.vector(temp_boot), na.rm = TRUE)



```


```{r use features to differentiate other group }


cbbPalette= c("#4f89e0", "#f5ec6c",'#156605',"#76D7C4","#268236", '#4d3d87','#593d80', '#3b49e3')

demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]

psd_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_Rest.csv', header = FALSE)
psd_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_Task.csv', header = FALSE)

icc_mat_young= read.csv('~/Documents/CAMCAN_outputs/ICC_features_young_adults.csv')
icc_mat_older= read.csv('~/Documents/CAMCAN_outputs/ICC_features_older_adults.csv')

icc_mat_young=icc_mat_young[,-1]
icc_mat_older=icc_mat_older[,-1]

icc_diff=icc_mat_young-icc_mat_older

count=1
fingerprint_boot_old=matrix(, ncol = 9,nrow=200)
fingerprint_boot_young=matrix(, ncol = 9,nrow=200)
fingerprint_boot_adult=matrix(, ncol = 9,nrow=200)

for (k in c(0.9, 0.85, 0.8, 0.75, 0.7, 0.65, 0.6, 0.55, 0.5)){
  
index_feats_young= c(t(icc_diff)) > quantile(c(t(icc_diff)), k)


ind=demo$Age>18 & demo$Age <45
psd_rest_age= psd_rest[ind,index_feats_young]
psd_task_age= psd_task[ind,index_feats_young]


temp_boot=matrix(, ncol = 2,nrow=100)

for(i in 1:100) {
  index_random_par=sample(1:sum(ind), 175)
  
  corr_psd=cor(t(psd_rest_age[index_random_par,]),t(psd_task_age[index_random_par,])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:175)==tt)/175
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:175)==tt)/175
  
}

fingerprint_boot_young[,count]= as.vector(temp_boot)
write.csv(fingerprint_boot_young, '~/Documents/CAMCAN_outputs/CAMCAN_Analysis/ICC_young_features_bootstrapped_fingerprinting_young2.csv')

mean(as.vector(temp_boot), na.rm = TRUE)
sd(as.vector(temp_boot), na.rm = TRUE)


ind=demo$Age>=45 & demo$Age <65
psd_rest_age= psd_rest[ind,index_feats_young]
psd_task_age= psd_task[ind,index_feats_young]

temp_boot=matrix(, ncol = 2,nrow=100)

for(i in 1:100) {
  index_random_par=sample(1:sum(ind), 175)
  
  corr_psd=cor(t(psd_rest_age[index_random_par,]),t(psd_task_age[index_random_par,])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:175)==tt)/175
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:175)==tt)/175
  
}

fingerprint_boot_adult[,count]= as.vector(temp_boot)
write.csv(fingerprint_boot_adult, '~/Documents/CAMCAN_outputs/CAMCAN_Analysis/ICC_young_features_bootstrapped_fingerprinting_adults2.csv')

mean(as.vector(temp_boot), na.rm = TRUE)
sd(as.vector(temp_boot), na.rm = TRUE)



ind=demo$Age>=65 & demo$Age <90
psd_rest_age= psd_rest[ind,index_feats_young]
psd_task_age= psd_task[ind,index_feats_young]


temp_boot=matrix(, ncol = 2,nrow=100)

for(i in 1:100) {
  index_random_par=sample(1:sum(ind), 175)
  
  corr_psd=cor(t(psd_rest_age[index_random_par,]),t(psd_task_age[index_random_par,])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:175)==tt)/175
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:175)==tt)/175
  
}

fingerprint_boot_old[,count]= as.vector(temp_boot)
write.csv(fingerprint_boot_old, '~/Documents/CAMCAN_outputs/CAMCAN_Analysis/ICC_young_features_bootstrapped_fingerprinting_olderadults2.csv')
mean(as.vector(temp_boot), na.rm = TRUE)
sd(as.vector(temp_boot), na.rm = TRUE)

count=count+1
}

```



```{r plot group effects }

cbbPalette= c("#4f89e0", "#f5ec6c",'#156605',"#76D7C4","#268236", '#4d3d87','#593d80', '#3b49e3')

demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]

older_adults=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/ICC_old_features_bootstrapped_fingerprinting_olderadults.csv')

adults=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/ICC_old_features_bootstrapped_fingerprinting_adults.csv')

young_adults=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/ICC_old_features_bootstrapped_fingerprinting_young.csv')

data4plot=rbind(data.frame(stack(older_adults[-1]), group= 'older adult'),
data.frame(stack(adults[-1]), group= 'adult'),
data.frame(stack(young_adults[-1]), group= 'young adult'))

data4plot=data4plot %>% group_by(group, ind) %>% summarise(m_acc= mean(values), CI= 1.96*(sd(values)/ sqrt(n())))

data4plot$ind= plyr::mapvalues(data4plot$ind,
                               c('V1', 'V2', 'V3', 'V4', 'V5', 'V6', 'V7', 'V8', 'V9'),
                               1-c(0.9, 0.85, 0.8, 0.75, 0.7, 0.65, 0.6, 0.55, 0.5))



ggplot(data4plot, aes(x=ind, y=m_acc, group=group, color = group, fill=group)) + geom_point(size=4) +
  geom_line(aes(x=ind, y=m_acc, color=group)) +
  geom_ribbon(aes(ymin=m_acc-CI,ymax=m_acc+CI,fill=group),alpha=0.4) +theme_classic2() + scale_colour_manual(values=cbbPalette) + scale_fill_manual(values=cbbPalette) + labs(y="Accuracy (%)", x="top % ICC features",title="") + theme(text = element_text(size=40), legend.title=element_blank()) 

ggsave('~/Documents/CAMCAN_outputs/figures/use_old_feats_to_fingerprint_young.pdf', device = "pdf", width=15, height=5, dpi=800)

#ggsave('/Users/jasondsc/Documents/CAMCAN_outputs/figures/Fingerprinting_age_across_ICC_nodes_oldrank.pdf', device = "pdf", width=25, height=4.51, dpi=800)


older_adults=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/ICC_young_features_bootstrapped_fingerprinting_olderadults.csv')

adults=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/ICC_young_features_bootstrapped_fingerprinting_adults.csv')

young_adults=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/ICC_young_features_bootstrapped_fingerprinting_young.csv')

data4plot2=rbind(data.frame(stack(older_adults[-1]), group= 'older adult'),
data.frame(stack(adults[-1]), group= 'adult'),
data.frame(stack(young_adults[-1]), group= 'young adult'))

data4plot2=data4plot2 %>% group_by(group, ind) %>% summarise(m_acc= mean(values), CI= 1.96*(sd(values)/ sqrt(n())))

data4plot2$ind= plyr::mapvalues(data4plot2$ind,
                               c('V1', 'V2', 'V3', 'V4', 'V5', 'V6', 'V7', 'V8', 'V9'),
                               1-c(0.9, 0.85, 0.8, 0.75, 0.7, 0.65, 0.6, 0.55, 0.5))


ggplot(data4plot2, aes(x=ind, y=m_acc, group=group, color = group, fill=group)) + geom_point(size=4) +
  geom_line(aes(x=ind, y=m_acc, color=group)) +
  geom_ribbon(aes(ymin=m_acc-CI,ymax=m_acc+CI,fill=group),alpha=0.4) +theme_classic2() + scale_colour_manual(values=cbbPalette) + scale_fill_manual(values=cbbPalette) + labs(y="Accuracy (%)", x="top % ICC features",title="") + theme(text = element_text(size=40), legend.title=element_blank()) 

ggsave('~/Documents/CAMCAN_outputs/figures/use_young_feats_to_fingerprint_young.pdf', device = "pdf", width=15, height=5, dpi=800)

icc_mat_young= read.csv('~/Documents/CAMCAN_outputs/ICC_features_young_adults.csv')
icc_mat_older= read.csv('~/Documents/CAMCAN_outputs/ICC_features_older_adults.csv')
icc_mat= read.csv('~/Documents/CAMCAN_outputs/ICC_fullgroup_analysis.csv')

icc_mat_young=icc_mat_young[,-1]
icc_mat_older=icc_mat_older[,-1]
icc_mat= icc_mat[,-1]

icc_diff=icc_mat_young-icc_mat_older
  
data4plot3=matrix(, nrow = 9, ncol = 3)
count=1
for (k in c(0.9, 0.85, 0.8, 0.75, 0.7, 0.65, 0.6, 0.55, 0.5)){

index_feats_young= c(t(icc_diff)) > quantile(c(t(icc_diff)), k)
index_feats_old= c(t(-1*icc_diff)) > quantile(c(t(-1*icc_diff)), k)
index_feats_allpeople= c(t(icc_mat)) > quantile(c(t(icc_mat)), k)
index=1:20400
data4plot3[count,1]=sum(index[index_feats_young] %in% index[index_feats_allpeople])
data4plot3[count,2]=sum(index[index_feats_old] %in% index[index_feats_allpeople])
data4plot3[count,3]=sum(index_feats_allpeople)
count=count+1
}

data4plot3= data4plot3/data4plot3[,3]
data4plot4= data.frame(percent= c(data4plot3[,1], data4plot3[,2]), feature= rep(c('young adult', 'older adult'), each=9), rank= 1-c(0.9, 0.85, 0.8, 0.75, 0.7, 0.65, 0.6, 0.55, 0.5))
ggplot(data4plot4, aes(x=rank, y=percent, group=feature, color = feature, fill=feature)) + geom_point(size=4) +
  geom_line(aes(x=rank, y=percent, color=feature), size=1.5) +theme_classic2() + scale_colour_manual(values=cbbPalette) + scale_fill_manual(values=cbbPalette) + labs(y="porportion of top ICC features for everyone (%)", x="top % ICC features",title="") + theme(text = element_text(size=40), legend.title=element_blank()) 

ggsave('~/Documents/CAMCAN_outputs/figures/use_feats_to_fingerprint_percent_of_total.pdf', device = "pdf", width=15, height=5, dpi=800)

```



```{r Compute ICC effects just rest }

demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]

psd_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_Rest1.csv', header = FALSE)
psd_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_Rest2.csv', header = FALSE)


z_target= t(scale(t(psd_task)))
z_database= t(scale(t(psd_rest)))
icc = c()


n = 606
k = 2
df_b = n-1
df_w = n*(k-1)


for (i_edge in 1:length(psd_rest)){
  x= data.frame(unlist(z_target[,i_edge]),unlist(z_database[,i_edge]) )
  x_w_mean =  rowMeans(x)
  x_g_mean = mean(unlist(x))
  ss_t = sum(((x - x_g_mean)^2))
  ss_w = sum((x - (x_w_mean))^2)
  ss_b = ss_t - ss_w
  ms_b = ss_b / df_b
  ms_w = ss_w / df_w
  icc[i_edge] = (ms_b - ms_w) / (ms_b + ((k-1)*ms_w))
  
  
}

icc_mat <- matrix(icc, nrow = 68, byrow = TRUE)


write.csv(icc_mat, '~/Documents/CAMCAN_outputs/just_rest_ICC_fullgroup_analysis.csv')



# plot effect 
library(ggseg)
library(ggplot2)
df=read.csv('~/Documents/Alex_fingerprinting/PSD_ICC_orig_PD_new_PKD2.csv', header = FALSE, stringsAsFactors = FALSE)
colnames(df)[1]='region'
df$hemi =''
df$hemi[seq(2,68,2)] ='right' 
df$hemi[seq(1,67,2)] ='left'

# index_delta=unlist(lapply(1:68, function(x) ((x-1)*300)+(1:8)))
# index_theta=unlist(lapply(1:68, function(x) ((x-1)*300)+(9:16))) # theta
# index_alpha=unlist(lapply(1:68, function(x) ((x-1)*300)+(17:26))) # alpha
# index_beta=unlist(lapply(1:68, function(x) ((x-1)*300)+(27:60))) # beta
# index_gamma=unlist(lapply(1:68, function(x) ((x-1)*300)+(61:101))) # gamma
# index_hgamma=unlist(lapply(1:68, function(x) ((x-1)*300)+(102:300))) # Hgamma

#  look ICC across bands
someData= tidyr::tibble(df$region, rowMeans(icc_mat[,102:300]), df$hemi)
colnames(someData)[2]='ICC'
colnames(someData)[1]='region'
colnames(someData)[3]='hemi'
someData$ICC[someData$ICC<0.4]=0.4
someData$ICC[someData$ICC>0.9]=0.9
someData$band= 'High gamma'
someData2= tidyr::tibble(df$region, rowMeans(icc_mat[,61:101]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Gamma'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_mat[,27:60]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Beta'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_mat[,17:26]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Alpha'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_mat[,9:16]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Theta'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_mat[,1:8]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Delta'
someData=rbind(someData,someData2)

someData$band= ordered(someData$band, levels= c("Delta", "Theta", "Alpha", "Beta", "Gamma", "High gamma"))
someData= someData[!is.na(someData$band),]
someData= na.omit(someData)
ggplot(someData) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ICC)) + viridis::scale_fill_viridis(option = 'viridis',limits=c(0.4, 1 ))+ theme_void() + facet_wrap(~band)

ggsave('~/Documents/CAMCAN_outputs/figures/just_rest_ICC_values_fullcohort.pdf', device = "pdf")


# look at age groups 
ind=demo$Age>18 & demo$Age <45
z_target= t(scale(t(psd_task[ind,])))
z_database= t(scale(t(psd_rest[ind,])))
icc = c()


n = length(ind)
k = 2
df_b = n-1
df_w = n*(k-1)


for (i_edge in 1:length(psd_rest)){
  x= data.frame(unlist(z_target[,i_edge]),unlist(z_database[,i_edge]) )
  x_w_mean =  rowMeans(x)
  x_g_mean = mean(unlist(x))
  ss_t = sum(((x - x_g_mean)^2))
  ss_w = sum((x - (x_w_mean))^2)
  ss_b = ss_t - ss_w
  ms_b = ss_b / df_b
  ms_w = ss_w / df_w
  icc[i_edge] = (ms_b - ms_w) / (ms_b + ((k-1)*ms_w))
  
  
}

icc_mat_young <- matrix(icc, nrow = 68, byrow = TRUE)
write.csv(icc_mat_young, '~/Documents/CAMCAN_outputs/ICC_young_adult_just_rest.csv')


# plot effect 
df=read.csv('~/Documents/Alex_fingerprinting/PSD_ICC_orig_PD_new_PKD2.csv', header = FALSE, stringsAsFactors = FALSE)
colnames(df)[1]='region'
df$hemi =''
df$hemi[seq(2,68,2)] ='right' 
df$hemi[seq(1,67,2)] ='left'


#  look ICC across bands
someData= tidyr::tibble(df$region, rowMeans(icc_mat_young[,102:300]), df$hemi)
colnames(someData)[2]='ICC'
colnames(someData)[1]='region'
colnames(someData)[3]='hemi'
someData$ICC[someData$ICC<0.4]=0.4
someData$ICC[someData$ICC>0.9]=0.9
someData$band= 'High gamma'
someData2= tidyr::tibble(df$region, rowMeans(icc_mat_young[,61:101]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Gamma'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_mat_young[,27:60]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Beta'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_mat_young[,17:26]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Alpha'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_mat_young[,9:16]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Theta'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_mat_young[,1:8]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Delta'
someData=rbind(someData,someData2)

someData$band= ordered(someData$band, levels= c("Delta", "Theta", "Alpha", "Beta", "Gamma", "High gamma"))
someData= someData[!is.na(someData$band),]
someData= na.omit(someData)
ggplot(someData) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ICC)) + viridis::scale_fill_viridis(option = 'viridis',limits=c(0.4, 1 ))+ theme_void() + facet_wrap(~band)

ggsave('~/Documents/CAMCAN_outputs/figures/just_rest_ICC_values_young_adults.pdf', device = "pdf")



# look at age groups 
ind=demo$Age>=45 & demo$Age <65
z_target= t(scale(t(psd_task[ind,])))
z_database= t(scale(t(psd_rest[ind,])))
icc = c()


n = length(ind)
k = 2
df_b = n-1
df_w = n*(k-1)


for (i_edge in 1:length(psd_rest)){
  x= data.frame(unlist(z_target[,i_edge]),unlist(z_database[,i_edge]) )
  x_w_mean =  rowMeans(x)
  x_g_mean = mean(unlist(x))
  ss_t = sum(((x - x_g_mean)^2))
  ss_w = sum((x - (x_w_mean))^2)
  ss_b = ss_t - ss_w
  ms_b = ss_b / df_b
  ms_w = ss_w / df_w
  icc[i_edge] = (ms_b - ms_w) / (ms_b + ((k-1)*ms_w))
  
  
}

icc_mat_adult <- matrix(icc, nrow = 68, byrow = TRUE)



# plot effect 
df=read.csv('~/Documents/Alex_fingerprinting/just_rest_orig_PD_new_PKD2.csv', header = FALSE, stringsAsFactors = FALSE)
colnames(df)[1]='region'
df$hemi =''
df$hemi[seq(2,68,2)] ='right' 
df$hemi[seq(1,67,2)] ='left'


#  look ICC across bands
someData= tidyr::tibble(df$region, rowMeans(icc_mat_adult[,102:300]), df$hemi)
colnames(someData)[2]='ICC'
colnames(someData)[1]='region'
colnames(someData)[3]='hemi'
someData$ICC[someData$ICC<0.4]=0.4
someData$ICC[someData$ICC>0.9]=0.9
someData$band= 'High gamma'
someData2= tidyr::tibble(df$region, rowMeans(icc_mat_adult[,61:101]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Gamma'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_mat_adult[,27:60]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Beta'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_mat_adult[,17:26]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Alpha'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_mat_adult[,9:16]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Theta'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_mat_adult[,1:8]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Delta'
someData=rbind(someData,someData2)

someData$band= ordered(someData$band, levels= c("Delta", "Theta", "Alpha", "Beta", "Gamma", "High gamma"))
someData= someData[!is.na(someData$band),]
someData= na.omit(someData)
ggplot(someData) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ICC)) + viridis::scale_fill_viridis(option = 'viridis',limits=c(0.4, 1 ))+ theme_void() + facet_wrap(~band)

ggsave('~/Documents/CAMCAN_outputs/figures/just_rest_values_adults.pdf', device = "pdf")




# look at age groups 
ind=demo$Age>=65 & demo$Age <90
z_target= t(scale(t(psd_task[ind,])))
z_database= t(scale(t(psd_rest[ind,])))
icc = c()


n = length(ind)
k = 2
df_b = n-1
df_w = n*(k-1)


for (i_edge in 1:length(psd_rest)){
  x= data.frame(unlist(z_target[,i_edge]),unlist(z_database[,i_edge]) )
  x_w_mean =  rowMeans(x)
  x_g_mean = mean(unlist(x))
  ss_t = sum(((x - x_g_mean)^2))
  ss_w = sum((x - (x_w_mean))^2)
  ss_b = ss_t - ss_w
  ms_b = ss_b / df_b
  ms_w = ss_w / df_w
  icc[i_edge] = (ms_b - ms_w) / (ms_b + ((k-1)*ms_w))
  
  
}

icc_mat_older <- matrix(icc, nrow = 68, byrow = TRUE)


# plot effect 
df=read.csv('~/Documents/Alex_fingerprinting/PSD_ICC_orig_PD_new_PKD2.csv', header = FALSE, stringsAsFactors = FALSE)
colnames(df)[1]='region'
df$hemi =''
df$hemi[seq(2,68,2)] ='right' 
df$hemi[seq(1,67,2)] ='left'


#  look ICC across bands
someData= tidyr::tibble(df$region, rowMeans(icc_mat_older[,102:300]), df$hemi)
colnames(someData)[2]='ICC'
colnames(someData)[1]='region'
colnames(someData)[3]='hemi'
someData$ICC[someData$ICC<0.4]=0.4
someData$ICC[someData$ICC>0.9]=0.9
someData$band= 'High gamma'
someData2= tidyr::tibble(df$region, rowMeans(icc_mat_older[,61:101]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Gamma'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_mat_older[,27:60]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Beta'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_mat_older[,17:26]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Alpha'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_mat_older[,9:16]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Theta'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_mat_older[,1:8]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC<0.4]=0.4
someData2$ICC[someData2$ICC>0.9]=0.9
someData2$band= 'Delta'
someData=rbind(someData,someData2)

someData$band= ordered(someData$band, levels= c("Delta", "Theta", "Alpha", "Beta", "Gamma", "High gamma"))
someData= someData[!is.na(someData$band),]
someData= na.omit(someData)
ggplot(someData) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ICC)) + viridis::scale_fill_viridis(option = 'viridis',limits=c(0.4, 1 ))+ theme_void() + facet_wrap(~band)

ggsave('~/Documents/CAMCAN_outputs/figures/just_rest_ICC_values_older.pdf', device = "pdf")




# plot effect 
df=read.csv('~/Documents/Alex_fingerprinting/PSD_ICC_orig_PD_new_PKD2.csv', header = FALSE, stringsAsFactors = FALSE)
colnames(df)[1]='region'
df$hemi =''
df$hemi[seq(2,68,2)] ='right' 
df$hemi[seq(1,67,2)] ='left'

icc_diff= icc_mat_older- icc_mat_young

write.csv(icc_diff, '~/Documents/CAMCAN_outputs/just_rest_ICC_diff_between_young_and_older_analysis.csv')



#  look ICC across bands
someData= tidyr::tibble(df$region, rowMeans(icc_diff[,102:300]), df$hemi)
colnames(someData)[2]='ICC'
colnames(someData)[1]='region'
colnames(someData)[3]='hemi'
someData$ICC[someData$ICC< -0.3]= -0.3
someData$ICC[someData$ICC>0.3]=0.3
someData$band= 'High gamma'
someData2= tidyr::tibble(df$region, rowMeans(icc_diff[,61:101]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC< -0.3]= -0.3
someData2$ICC[someData2$ICC>0.3]=0.3
someData2$band= 'Gamma'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_diff[,27:60]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC< -0.3]= -0.3
someData2$ICC[someData2$ICC>0.3]=0.3
someData2$band= 'Beta'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_diff[,17:26]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC< -0.3]= -0.3
someData2$ICC[someData2$ICC>0.3]=0.3
someData2$band= 'Alpha'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_diff[,9:16]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC< -0.3]= -0.3
someData2$ICC[someData2$ICC>0.3]=0.3
someData2$band= 'Theta'
someData=rbind(someData,someData2)
someData2= tidyr::tibble(df$region, rowMeans(icc_diff[,1:8]), df$hemi)
colnames(someData2)[2]='ICC'
colnames(someData2)[1]='region'
colnames(someData2)[3]='hemi'
someData2$ICC[someData2$ICC< -0.3]= -0.3
someData2$ICC[someData2$ICC>0.3]=0.3
someData2$band= 'Delta'
someData=rbind(someData,someData2)

someData$band= ordered(someData$band, levels= c("Delta", "Theta", "Alpha", "Beta", "Gamma", "High gamma"))
someData= someData[!is.na(someData$band),]
someData= na.omit(someData)
ggplot(someData) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ICC)) + #viridis::scale_fill_viridis(option = 'magma',limits=c(-0.3, 0.3 ))
  scale_fill_gradient2(low = "#1C14B4", mid = "#FCF7F4", high = "#079D0A", midpoint = 0.0, limits=c(-0.3, 0.3 )) + facet_wrap(~band)   + theme_void() 

ggsave('~/Documents/CAMCAN_outputs/figures/just_rest_ICC_values_diff_younger_minus_older.pdf', device = "pdf")


# CORR WITH ORIG RESULTS 


orig_diff=read.csv(icc_diff, '~/Documents/CAMCAN_outputs/ICC_diff_between_young_and_older_analysis.csv')

cor.test(c(orig_diff),c(icc_diffp) )


# RUN PCA



```





```{r just rest use features to differentiate other group }


cbbPalette= c("#4f89e0", "#f5ec6c",'#156605',"#76D7C4","#268236", '#4d3d87','#593d80', '#3b49e3')

demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]

psd_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_justRest.csv', header = FALSE)
psd_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_justRest2.csv', header = FALSE)

icc_diff= read.csv('~/Documents/CAMCAN_outputs/just_rest_ICC_diff_between_young_and_older_analysis.csv')

icc_diff=icc_diff[,-1]


count=1
fingerprint_boot_old=matrix(, ncol = 9,nrow=200)
fingerprint_boot_young=matrix(, ncol = 9,nrow=200)
fingerprint_boot_adult=matrix(, ncol = 9,nrow=200)


for (k in c(0.9, 0.85, 0.8, 0.75, 0.7, 0.65, 0.6, 0.55, 0.5)){
  
index_feats_young= c(t(icc_diff)) > quantile(c(t(icc_diff)), k)


ind=demo$Age>18 & demo$Age <45
psd_rest_age= psd_rest[ind,index_feats_young]
psd_task_age= psd_task[ind,index_feats_young]


temp_boot=matrix(, ncol = 2,nrow=100)

for(i in 1:100) {
  index_random_par=sample(1:sum(ind), 175)
  
  corr_psd=cor(t(psd_rest_age[index_random_par,]),t(psd_task_age[index_random_par,])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:175)==tt)/175
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:175)==tt)/175
  
}

fingerprint_boot_young[,count]= as.vector(temp_boot)
write.csv(fingerprint_boot_young, '~/Documents/CAMCAN_outputs/CAMCAN_Analysis/just_restICC_old_features_bootstrapped_fingerprinting_young2.csv')

mean(as.vector(temp_boot), na.rm = TRUE)
sd(as.vector(temp_boot), na.rm = TRUE)


ind=demo$Age>=45 & demo$Age <65
psd_rest_age= psd_rest[ind,index_feats_young]
psd_task_age= psd_task[ind,index_feats_young]

temp_boot=matrix(, ncol = 2,nrow=100)

for(i in 1:100) {
  index_random_par=sample(1:sum(ind), 175)
  
  corr_psd=cor(t(psd_rest_age[index_random_par,]),t(psd_task_age[index_random_par,])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:175)==tt)/175
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:175)==tt)/175
  
}

fingerprint_boot_adult[,count]= as.vector(temp_boot)
write.csv(fingerprint_boot_adult, '~/Documents/CAMCAN_outputs/CAMCAN_Analysis/just_rest_ICC_old_features_bootstrapped_fingerprinting_adults2.csv')

mean(as.vector(temp_boot), na.rm = TRUE)
sd(as.vector(temp_boot), na.rm = TRUE)



ind=demo$Age>=65 & demo$Age <90
psd_rest_age= psd_rest[ind,index_feats_young]
psd_task_age= psd_task[ind,index_feats_young]


temp_boot=matrix(, ncol = 2,nrow=100)

for(i in 1:100) {
  index_random_par=sample(1:sum(ind), 175)
  
  corr_psd=cor(t(psd_rest_age[index_random_par,]),t(psd_task_age[index_random_par,])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:175)==tt)/175
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:175)==tt)/175
  
}

fingerprint_boot_old[,count]= as.vector(temp_boot)
write.csv(fingerprint_boot_old, '~/Documents/CAMCAN_outputs/CAMCAN_Analysis/just_rest_ICC_old_features_bootstrapped_fingerprinting_olderadults2.csv')
mean(as.vector(temp_boot), na.rm = TRUE)
sd(as.vector(temp_boot), na.rm = TRUE)

count=count+1
}




cbbPalette= c("#4f89e0", "#f5ec6c",'#156605',"#76D7C4","#268236", '#4d3d87','#593d80', '#3b49e3')

demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]

psd_rest=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_justRest.csv', header = FALSE)
psd_task=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/PSD_justRest2.csv', header = FALSE)

icc_diff= read.csv('~/Documents/CAMCAN_outputs/just_rest_ICC_diff_between_young_and_older_analysis.csv')

icc_diff=-1*icc_diff[,-1]


count=1
fingerprint_boot_old=matrix(, ncol = 9,nrow=200)
fingerprint_boot_young=matrix(, ncol = 9,nrow=200)
fingerprint_boot_adult=matrix(, ncol = 9,nrow=200)

for (k in c(0.9, 0.85, 0.8, 0.75, 0.7, 0.65, 0.6, 0.55, 0.5)){
  
index_feats_young= c(t(icc_diff)) > quantile(c(t(icc_diff)), k)


ind=demo$Age>18 & demo$Age <45
psd_rest_age= psd_rest[ind,index_feats_young]
psd_task_age= psd_task[ind,index_feats_young]


temp_boot=matrix(, ncol = 2,nrow=100)

for(i in 1:100) {
  index_random_par=sample(1:sum(ind), 175)
  
  corr_psd=cor(t(psd_rest_age[index_random_par,]),t(psd_task_age[index_random_par,])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:175)==tt)/175
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:175)==tt)/175
  
}

fingerprint_boot_young[,count]= as.vector(temp_boot)
write.csv(fingerprint_boot_young, '~/Documents/CAMCAN_outputs/CAMCAN_Analysis/just_restICC_young_features_bootstrapped_fingerprinting_young2.csv')

mean(as.vector(temp_boot), na.rm = TRUE)
sd(as.vector(temp_boot), na.rm = TRUE)


ind=demo$Age>=45 & demo$Age <65
psd_rest_age= psd_rest[ind,index_feats_young]
psd_task_age= psd_task[ind,index_feats_young]

temp_boot=matrix(, ncol = 2,nrow=100)

for(i in 1:100) {
  index_random_par=sample(1:sum(ind), 175)
  
  corr_psd=cor(t(psd_rest_age[index_random_par,]),t(psd_task_age[index_random_par,])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:175)==tt)/175
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:175)==tt)/175
  
}

fingerprint_boot_adult[,count]= as.vector(temp_boot)
write.csv(fingerprint_boot_adult, '~/Documents/CAMCAN_outputs/CAMCAN_Analysis/just_rest_ICC_young_features_bootstrapped_fingerprinting_adults2.csv')

mean(as.vector(temp_boot), na.rm = TRUE)
sd(as.vector(temp_boot), na.rm = TRUE)



ind=demo$Age>=65 & demo$Age <90
psd_rest_age= psd_rest[ind,index_feats_young]
psd_task_age= psd_task[ind,index_feats_young]


temp_boot=matrix(, ncol = 2,nrow=100)

for(i in 1:100) {
  index_random_par=sample(1:sum(ind), 175)
  
  corr_psd=cor(t(psd_rest_age[index_random_par,]),t(psd_task_age[index_random_par,])) 
  tt=apply(corr_psd, 1, which.max)
  temp_boot[i,1]=sum(seq(1:175)==tt)/175
  tt=apply(corr_psd, 2, which.max)
  temp_boot[i,2]=sum(seq(1:175)==tt)/175
  
}

fingerprint_boot_old[,count]= as.vector(temp_boot)
write.csv(fingerprint_boot_old, '~/Documents/CAMCAN_outputs/CAMCAN_Analysis/just_rest_ICC_young_features_bootstrapped_fingerprinting_olderadults2.csv')
mean(as.vector(temp_boot), na.rm = TRUE)
sd(as.vector(temp_boot), na.rm = TRUE)

count=count+1
}


```




```{r just rest plot group effects }


cbbPalette= c("#4f89e0", "#f5ec6c",'#156605',"#76D7C4","#268236", '#4d3d87','#593d80', '#3b49e3')

demo=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/standard_data.csv')
demo$CCID=paste('sub',demo$CCID, sep = '_')
ids=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/subject_codes.csv')
index=demo$CCID %in% ids$Ids
demo=demo[index,]

full_demo=read.csv('~/Documents/CAMCAN_outputs/approved_data.csv')
full_demo$CCID=paste('sub',full_demo$CCID, sep = '_')
index=full_demo$CCID %in% ids$Ids
full_demo=full_demo[index,]

older_adults=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/just_rest_ICC_old_features_bootstrapped_fingerprinting_olderadults2.csv')

adults=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/just_rest_ICC_old_features_bootstrapped_fingerprinting_adults2.csv')

young_adults=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/just_restICC_old_features_bootstrapped_fingerprinting_young2.csv')

data4plot=rbind(data.frame(stack(older_adults[-1]), group= 'older adult'),
data.frame(stack(adults[-1]), group= 'adult'),
data.frame(stack(young_adults[-1]), group= 'young adult'))

data4plot=data4plot %>% group_by(group, ind) %>% summarise(m_acc= mean(values), CI= 1.96*(sd(values)/ sqrt(n())))

data4plot$ind= plyr::mapvalues(data4plot$ind,
                               c('V1', 'V2', 'V3', 'V4', 'V5', 'V6', 'V7', 'V8', 'V9'),
                               1-c(0.9, 0.85, 0.8, 0.75, 0.7, 0.65, 0.6, 0.55, 0.5))



ggplot(data4plot, aes(x=ind, y=m_acc, group=group, color = group, fill=group)) + geom_point(size=4) +
  geom_line(aes(x=ind, y=m_acc, color=group)) +
  geom_ribbon(aes(ymin=m_acc-CI,ymax=m_acc+CI,fill=group),alpha=0.4) +theme_classic2() + scale_colour_manual(values=cbbPalette) + scale_fill_manual(values=cbbPalette) + labs(y="Accuracy (%)", x="top % ICC features",title="") + theme(text = element_text(size=40), legend.title=element_blank()) 

ggsave('~/Documents/CAMCAN_outputs/figures/just_rest_use_old_feats_to_fingerprint_young.pdf', device = "pdf", width=15, height=5, dpi=800)

#ggsave('/Users/jasondsc/Documents/CAMCAN_outputs/figures/Fingerprinting_age_across_ICC_nodes_oldrank.pdf', device = "pdf", width=25, height=4.51, dpi=800)


older_adults=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/just_rest_ICC_young_features_bootstrapped_fingerprinting_olderadults2.csv')

adults=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/just_rest_ICC_young_features_bootstrapped_fingerprinting_adults2.csv')

young_adults=read.csv('~/Documents/CAMCAN_outputs/CAMCAN_Analysis/just_restICC_young_features_bootstrapped_fingerprinting_young2.csv')


data4plot2=rbind(data.frame(stack(older_adults[-1]), group= 'older adult'),
data.frame(stack(adults[-1]), group= 'adult'),
data.frame(stack(young_adults[-1]), group= 'young adult'))

data4plot2=data4plot2 %>% group_by(group, ind) %>% summarise(m_acc= mean(values), CI= 1.96*(sd(values)/ sqrt(n())))

data4plot2$ind= plyr::mapvalues(data4plot2$ind,
                               c('V1', 'V2', 'V3', 'V4', 'V5', 'V6', 'V7', 'V8', 'V9'),
                               1-c(0.9, 0.85, 0.8, 0.75, 0.7, 0.65, 0.6, 0.55, 0.5))


ggplot(data4plot2, aes(x=ind, y=m_acc, group=group, color = group, fill=group)) + geom_point(size=4) +
  geom_line(aes(x=ind, y=m_acc, color=group)) +
  geom_ribbon(aes(ymin=m_acc-CI,ymax=m_acc+CI,fill=group),alpha=0.4) +theme_classic2() + scale_colour_manual(values=cbbPalette) + scale_fill_manual(values=cbbPalette) + labs(y="Accuracy (%)", x="top % ICC features",title="") + theme(text = element_text(size=40), legend.title=element_blank()) 

ggsave('~/Documents/CAMCAN_outputs/figures/just_rest_use_young_feats_to_fingerprint_young.pdf', device = "pdf", width=15, height=5, dpi=800)

icc_mat= read.csv('~/Documents/CAMCAN_outputs/just_rest_ICC_fullgroup_analysis.csv')

icc_mat= icc_mat[,-1]

  
data4plot3=matrix(, nrow = 9, ncol = 3)
count=1
for (k in c(0.9, 0.85, 0.8, 0.75, 0.7, 0.65, 0.6, 0.55, 0.5)){

index_feats_young= c(t(icc_diff)) > quantile(c(t(icc_diff)), k)
index_feats_old= c(t(-1*icc_diff)) > quantile(c(t(-1*icc_diff)), k)
index_feats_allpeople= c(t(icc_mat)) > quantile(c(t(icc_mat)), k)
index=1:20400
data4plot3[count,1]=sum(index[index_feats_young] %in% index[index_feats_allpeople])
data4plot3[count,2]=sum(index[index_feats_old] %in% index[index_feats_allpeople])
data4plot3[count,3]=sum(index_feats_allpeople)
count=count+1
}

data4plot3= data4plot3/data4plot3[,3]
data4plot4= data.frame(percent= c(data4plot3[,1], data4plot3[,2]), feature= rep(c('young adult', 'older adult'), each=9), rank= 1-c(0.9, 0.85, 0.8, 0.75, 0.7, 0.65, 0.6, 0.55, 0.5))
ggplot(data4plot4, aes(x=rank, y=percent, group=feature, color = feature, fill=feature)) + geom_point(size=4) +
  geom_line(aes(x=rank, y=percent, color=feature), size=1.5) +theme_classic2() + scale_colour_manual(values=cbbPalette) + scale_fill_manual(values=cbbPalette) + labs(y="porportion of top ICC features for everyone (%)", x="top % ICC features",title="") + theme(text = element_text(size=40), legend.title=element_blank()) 

ggsave('~/Documents/CAMCAN_outputs/figures/just_rest_use_feats_to_fingerprint_percent_of_total.pdf', device = "pdf", width=15, height=5, dpi=800)

```

